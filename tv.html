<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PadelTrack - Pantalla TV</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js"></script>
  <style>
    :root {
      --primary: #2c3e50;
      --secondary: #e74c3c;
      --accent: #3498db;
      --light: #ecf0f1;
      --dark: #2c3e50;
      --success: #2ecc71;
    }
    
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Montserrat', sans-serif;
    }
    
    body {
      background: linear-gradient(135deg, #2c3e50 0%, #1a2530 100%);
      color: white;
      min-height: 100vh;
      overflow: hidden;
    }
    
    .container {
      max-width: 100%;
      height: 100vh;
      padding: 15px;
      display: flex;
      flex-direction: column;
    }
    
    .court-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
      padding-bottom: 10px;
      border-bottom: 2px solid rgba(255, 255, 255, 0.1);
    }
    
    .court-header h1 {
      font-size: 1.8rem;
    }
    
    .match-status {
      padding: 6px 12px;
      background-color: #e67e22;
      border-radius: 20px;
      font-weight: bold;
      font-size: 0.9rem;
    }
    
    .match-status.active {
      background-color: var(--success);
    }
    
    .scoreboard {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin: 15px 0;
      background-color: rgba(255, 255, 255, 0.1);
      padding: 20px;
      border-radius: 12px;
      flex: 1;
    }
    
    .team {
      text-align: center;
      flex: 1;
    }
    
    .team h2 {
      font-size: 1.5rem;
      margin-bottom: 8px;
    }
    
    .team-a .score {
      color: #3498db;
      font-size: 4rem;
      font-weight: bold;
    }
    
    .team-b .score {
      color: #e74c3c;
      font-size: 4rem;
      font-weight: bold;
    }
    
    .players {
      font-size: 1.2rem;
      margin: 8px 0;
      min-height: 1.2em;
    }
    
    .vs {
      font-size: 2.5rem;
      font-weight: bold;
      margin: 0 20px;
      opacity: 0.7;
    }
    
    .game-info {
      display: flex;
      justify-content: space-around;
      margin: 15px 0;
    }
    
    .info-box {
      background-color: rgba(255, 255, 255, 0.1);
      padding: 12px 20px;
      border-radius: 8px;
      text-align: center;
      flex: 1;
      margin: 0 8px;
    }
    
    .info-box span:first-child {
      display: block;
      font-size: 0.9rem;
      opacity: 0.8;
      margin-bottom: 5px;
    }
    
    .info-box span:last-child {
      font-size: 1.5rem;
      font-weight: bold;
    }
    
    .bottom-section {
      display: flex;
      margin-top: 15px;
      flex: 0 0 auto;
    }
    
    .qr-section {
      text-align: center;
      flex: 1;
      padding: 15px;
      background-color: rgba(255, 255, 255, 0.05);
      border-radius: 8px;
      margin-right: 15px;
    }
    
    #qrcode {
      margin: 10px auto;
      display: inline-block;
      background: white;
      padding: 10px;
      border-radius: 8px;
    }
    
    .qr-section h3 {
      font-size: 1.1rem;
      margin-bottom: 5px;
    }
    
    .qr-section p {
      font-size: 0.9rem;
      opacity: 0.8;
    }
    
    .button-simulator {
      display: flex;
      flex-direction: column;
      justify-content: center;
      gap: 15px;
      flex: 0 0 180px;
    }
    
    .sim-button {
      width: 100%;
      height: 80px;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.1rem;
      font-weight: bold;
      cursor: pointer;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
      transition: all 0.2s;
      text-align: center;
      padding: 0 10px;
    }
    
    .sim-button:active {
      transform: scale(0.98);
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    }
    
    .team-a-btn {
      background-color: #3498db;
    }
    
    .team-b-btn {
      background-color: #e74c3c;
    }
    
    /* Responsive adjustments for TV */
    @media (max-width: 1200px) {
      .team-a .score, .team-b .score {
        font-size: 3.5rem;
      }
      
      .players {
        font-size: 1.1rem;
      }
      
      .vs {
        font-size: 2rem;
      }
    }
    
    @media (max-width: 900px) {
      .scoreboard {
        flex-direction: column;
        gap: 20px;
      }
      
      .vs {
        margin: 15px 0;
        transform: rotate(0deg);
      }
      
      .bottom-section {
        flex-direction: column;
      }
      
      .qr-section {
        margin-right: 0;
        margin-bottom: 15px;
      }
      
      .button-simulator {
        flex-direction: row;
        flex: 0 0 auto;
      }
      
      .sim-button {
        width: 50%;
        height: 70px;
      }
    }

    @media (max-height: 800px) {
      .container {
        padding: 10px;
      }
      
      .court-header {
        margin-bottom: 10px;
      }
      
      .court-header h1 {
        font-size: 1.5rem;
      }
      
      .scoreboard {
        margin: 10px 0;
        padding: 15px;
      }
      
      .team-a .score, .team-b .score {
        font-size: 3rem;
      }
      
      .players {
        font-size: 1rem;
      }
      
      .game-info {
        margin: 10px 0;
      }
      
      .info-box {
        padding: 8px 12px;
      }
      
      .info-box span:last-child {
        font-size: 1.3rem;
      }
      
      .bottom-section {
        margin-top: 10px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="court-header">
      <h1>Cancha #<span id="court-number">1</span></h1>
      <div class="match-status" id="match-state">Esperando jugadores...</div>
    </div>
    
    <div class="scoreboard">
      <div class="team team-a">
        <h2 id="team-a-name">Equipo A</h2>
        <div class="players" id="team-a-players">-</div>
        <div class="score" id="score-a">0</div>
      </div>
      
      <div class="vs">VS</div>
      
      <div class="team team-b">
        <h2 id="team-b-name">Equipo B</h2>
        <div class="players" id="team-b-players">-</div>
        <div class="score" id="score-b">0</div>
      </div>
    </div>
    
    <div class="game-info">
      <div class="info-box">
        <span>Duración</span>
        <span id="match-duration">00:00</span>
      </div>
      <div class="info-box">
        <span>Puntos totales</span>
        <span id="total-points">0</span>
      </div>
      <div class="info-box">
        <span>Sistema</span>
        <span id="scoring-type">Tradicional</span>
      </div>
    </div>
    
    <div class="bottom-section">
      <div class="qr-section">
        <h3>Escanee para registrar su partido</h3>
        <div id="qrcode"></div>
        <p>Use su smartphone para escanear el código</p>
      </div>
      
      <div class="button-simulator">
        <div class="sim-button team-a-btn" onclick="addPoint('A')">EQUIPO A</div>
        <div class="sim-button team-b-btn" onclick="addPoint('B')">EQUIPO B</div>
      </div>
    </div>
  </div>

  <script>
    // Configuración de Supabase (¡REEMPLAZA CON TUS CREDENCIALES REALES!)
    const supabaseUrl = 'https://omizjfxbxkfkxlxdkbej.supabase.co'; // ¡REEMPLAZA ESTO!
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9taXpqZnhieGtma3hseGRrYmVqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU0NzkyMjIsImV4cCI6MjA3MTA1NTIyMn0.UAj61BfHqIF8Gg9bHYsEF_ocTM8Og4oJN2bWT11N6Rg'; // ¡REEMPLAZA ESTO!
      
    // Inicializar Supabase
    const supabase = window.supabase.createClient(supabaseUrl, supabaseKey, {
      db: {
        schema: 'public'
      },
      global: {
        headers: {
          'Content-Type': 'application/json',
          'Accept': 'application/json'
        }
      }
    });
    
    // Obtener ID de cancha de la URL
    const urlParams = new URLSearchParams(window.location.search);
    const courtId = urlParams.get('court') || 1;
    
    document.getElementById('court-number').textContent = courtId;
    
    // Variables de estado del partido
    let currentMatch = null;
    let matchDurationInterval = null;
    
    // Función para generar código QR
    function generateQRCode() {
      const registrationUrl = `${window.location.origin}/index.html?mode=qr&court=${courtId}`;
      const qrElement = document.getElementById('qrcode');
      
      if (qrElement) {
        qrElement.innerHTML = '';
        const canvas = document.createElement('canvas');
        qrElement.appendChild(canvas);
        
        // Reducir el tamaño del QR para asegurar que se vea completo
        QRCode.toCanvas(canvas, registrationUrl, {
          width: 140,  // Reducido de 180 a 140
          margin: 1,
          color: {
            dark: '#2c3e50',
            light: '#ffffff'
          }
        }, function(error) {
          if (error) {
            console.error('Error generating QR code:', error);
            qrElement.innerHTML = `
              <a href="${registrationUrl}" style="color: white; text-decoration: underline;">
                Escanear para registrar partido
              </a>
            `;
          }
        });
      }
    }
    
    // Función para cargar partido activo
    async function loadActiveMatch() {
      try {
        console.log("Buscando partido activo para cancha:", courtId);
        
        // Primero intentar con el formato "Cancha X"
        let { data, error } = await supabase
          .from('matches')
          .select('*')
          .eq('court', `Cancha ${courtId}`)
          .eq('status', 'active')
          .maybeSingle();
          
        if (error) {
          console.error("Error al cargar partido:", error);
          // Intentar con formato alternativo (solo el número)
          const { data: altData, error: altError } = await supabase
            .from('matches')
            .select('*')
            .eq('court', courtId)
            .eq('status', 'active')
            .maybeSingle();
            
          if (altError) {
            console.error("Error alternativo:", altError);
            return null;
          }
          
          return altData;
        }
        
        return data;
      } catch (error) {
        console.error("Error inesperado:", error);
        return null;
      }
    }
    
    // Función para actualizar la visualización
    function updateMatchDisplay(matchData) {
      if (!matchData) {
        document.getElementById('match-state').textContent = 'Esperando jugadores...';
        document.querySelector('.qr-section').style.display = 'block';
        return;
      }
      
      currentMatch = matchData;
      
      // Actualizar estado
      const stateElement = document.getElementById('match-state');
      if (matchData.status === 'active') {
        stateElement.textContent = 'Partido en curso';
        stateElement.className = 'match-status active';
        document.querySelector('.qr-section').style.display = 'none';
      } else {
        stateElement.textContent = 'Esperando jugadores...';
        stateElement.className = 'match-status';
        document.querySelector('.qr-section').style.display = 'block';
      }
      
      // Actualizar información de equipos
      document.getElementById('team-a-players').textContent = 
        matchData.team_a_players ? matchData.team_a_players.join(' / ') : '-';
      document.getElementById('team-b-players').textContent = 
        matchData.team_b_players ? matchData.team_b_players.join(' / ') : '-';
        
      // Actualizar nombres de equipos
      document.getElementById('team-a-name').textContent = matchData.team_a_name || 'Equipo A';
      document.getElementById('team-b-name').textContent = matchData.team_b_name || 'Equipo B';
        
      // Actualizar marcador
      document.getElementById('score-a').textContent = matchData.team_a_score || 0;
      document.getElementById('score-b').textContent = matchData.team_b_score || 0;
      document.getElementById('total-points').textContent = 
        (matchData.team_a_score || 0) + (matchData.team_b_score || 0);
        
      // Actualizar tipo de sistema de puntuación
      document.getElementById('scoring-type').textContent = 
        matchData.scoring_type === 'american' ? 'Americano' : 'Tradicional';
        
      // Calcular y mostrar duración si el partido está activo
      if (matchData.status === 'active' && matchData.start_time) {
        startMatchTimer(matchData.start_time);
      } else {
        stopMatchTimer();
        document.getElementById('match-duration').textContent = '00:00';
      }
    }
    
    // Función para iniciar el temporizador
    function startMatchTimer(startTime) {
      stopMatchTimer();
      
      matchDurationInterval = setInterval(() => {
        const start = new Date(startTime);
        const now = new Date();
        const diff = now - start;
        const minutes = Math.floor(diff / 60000);
        const seconds = Math.floor((diff % 60000) / 1000);
        
        document.getElementById('match-duration').textContent = 
          `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
      }, 1000);
    }
    
    // Función para detener el temporizador
    function stopMatchTimer() {
      if (matchDurationInterval) {
        clearInterval(matchDurationInterval);
        matchDurationInterval = null;
      }
    }
    
    // Función para agregar puntos
    async function addPoint(team) {
      if (!currentMatch || currentMatch.status !== 'active') {
        alert('No hay un partido activo. Por favor, escanee el QR para registrar un partido primero.');
        return;
      }
      
      try {
        const updateData = {};
        if (team === 'A') {
          updateData.team_a_score = (currentMatch.team_a_score || 0) + 1;
        } else {
          updateData.team_b_score = (currentMatch.team_b_score || 0) + 1;
        }
        
        const { error } = await supabase
          .from('matches')
          .update(updateData)
          .eq('id', currentMatch.id);
          
        if (error) {
          console.error('Error al actualizar puntuación:', error);
          alert('Error al registrar punto. Intente nuevamente.');
        }
      } catch (error) {
        console.error('Error:', error);
        alert('Error inesperado. Intente nuevamente.');
      }
    }
    
    // Función para configurar la suscripción en tiempo real
    function setupRealtimeSubscription() {
      try {
        const subscription = supabase
          .channel('matches-channel')
          .on(
            'postgres_changes',
            {
              event: '*',
              schema: 'public',
              table: 'matches'
            },
            (payload) => {
              // Filtrar manualmente por cancha
              const courtValue = payload.new.court;
              if (courtValue === `Cancha ${courtId}` || courtValue == courtId) {
                updateMatchDisplay(payload.new);
              }
            }
          )
          .subscribe((status, err) => {
            if (err) {
              console.error("Error de suscripción:", err);
            } else {
              console.log("Estado de suscripción:", status);
            }
          });
          
        return subscription;
      } catch (error) {
        console.error("Error al configurar suscripción:", error);
        return null;
      }
    }
    
    // Función de inicialización
    async function initApp() {
      try {
        // Cargar partido activo
        currentMatch = await loadActiveMatch();
        updateMatchDisplay(currentMatch);
        
        // Configurar suscripción en tiempo real
        setupRealtimeSubscription();
        
        // Generar código QR
        generateQRCode();
        
      } catch (error) {
        console.error("Error al inicializar la aplicación:", error);
      }
    }
    
    // Iniciar la aplicación cuando el DOM esté cargado
    document.addEventListener('DOMContentLoaded', initApp);
  </script>
</body>
</html>
