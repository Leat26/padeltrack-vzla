<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PadelTrack - Pantalla TV</title>
  <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js"></script>  
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    :root {
      --primary: #2c3e50;
      --secondary: #e74c3c;
      --accent: #3498db;
      --light: #ecf0f1;
      --dark: #2c3e50;
      --success: #2ecc71;
    }
    
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Montserrat', sans-serif;
    }
    
    body {
      background: linear-gradient(135deg, #2c3e50 0%, #1a2530 100%);
      color: white;
      min-height: 100vh;
      overflow: hidden;
    }
    
    .container {
      max-width: 100%;
      height: 100vh;
      padding: 15px;
      display: flex;
      flex-direction: column;
    }
    
    .court-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
      padding-bottom: 10px;
      border-bottom: 2px solid rgba(255, 255, 255, 0.1);
    }
    
    .court-header h1 {
      font-size: 1.8rem;
    }
    
    .match-status {
      padding: 6px 12px;
      background-color: #e67e22;
      border-radius: 20px;
      font-weight: bold;
      font-size: 0.9rem;
    }
    
    .match-status.active {
      background-color: var(--success);
    }
    
    .scoreboard {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin: 15px 0;
      background-color: rgba(255, 255, 255, 0.1);
      padding: 20px;
      border-radius: 12px;
      flex: 1;
    }
    
    .team {
      text-align: center;
      flex: 1;
    }
    
    .team h2 {
      font-size: 1.5rem;
      margin-bottom: 8px;
    }
    
    .team-a .score {
      color: #3498db;
      font-size: 4rem;
      font-weight: bold;
    }
    
    .team-b .score {
      color: #e74c3c;
      font-size: 4rem;
      font-weight: bold;
    }
    
    .players {
      font-size: 1.2rem;
      margin: 8px 0;
      min-height: 1.2em;
    }
    
    .vs {
      font-size: 2.5rem;
      font-weight: bold;
      margin: 0 20px;
      opacity: 0.7;
    }
    
    .game-info {
      display: flex;
      justify-content: space-around;
      margin: 15px 0;
    }
    
    .info-box {
      background-color: rgba(255, 255, 255, 0.1);
      padding: 12px 20px;
      border-radius: 8px;
      text-align: center;
      flex: 1;
      margin: 0 8px;
    }
    
    .info-box span:first-child {
      display: block;
      font-size: 0.9rem;
      opacity: 0.8;
      margin-bottom: 5px;
    }
    
    .info-box span:last-child {
      font-size: 1.5rem;
      font-weight: bold;
    }
    
    .bottom-section {
      display: flex;
      margin-top: 15px;
      flex: 0 0 auto;
    }
    
    .qr-section {
      text-align: center;
      flex: 1;
      padding: 15px;
      background-color: rgba(255, 255, 255, 0.05);
      border-radius: 8px;
      margin-right: 15px;
    }
    
    #qrcode {
      margin: 10px auto;
      display: inline-block;
      background: white;
      padding: 10px;
      border-radius: 8px;
    }
    
    .qr-section h3 {
      font-size: 1.1rem;
      margin-bottom: 5px;
    }
    
    .qr-section p {
      font-size: 0.9rem;
      opacity: 0.8;
    }
    
    .button-simulator {
      display: flex;
      flex-direction: column;
      justify-content: center;
      gap: 15px;
      flex: 0 0 180px;
    }
    
    .sim-button {
      width: 100%;
      height: 80px;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.1rem;
      font-weight: bold;
      cursor: pointer;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
      transition: all 0.2s;
      text-align: center;
      padding: 0 10px;
    }
    
    .sim-button:active {
      transform: scale(0.98);
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    }
    
    .team-a-btn {
      background-color: #3498db;
    }
    
    .team-b-btn {
      background-color: #e74c3c;
    }
    
    /* Responsive adjustments for TV */
    @media (max-width: 1200px) {
      .team-a .score, .team-b .score {
        font-size: 3.5rem;
      }
      
      .players {
        font-size: 1.1rem;
      }
      
      .vs {
        font-size: 2rem;
      }
    }
    
    @media (max-width: 900px) {
      .scoreboard {
        flex-direction: column;
        gap: 20px;
      }
      
      .vs {
        margin: 15px 0;
        transform: rotate(0deg);
      }
      
      .bottom-section {
        flex-direction: column;
      }
      
      .qr-section {
        margin-right: 0;
        margin-bottom: 15px;
      }
      
      .button-simulator {
        flex-direction: row;
        flex: 0 0 auto;
      }
      
      .sim-button {
        width: 50%;
        height: 70px;
      }
    }

    @media (max-height: 800px) {
      .container {
        padding: 10px;
      }
      
      .court-header {
        margin-bottom: 10px;
      }
      
      .court-header h1 {
        font-size: 1.5rem;
      }
      
      .scoreboard {
        margin: 10px 0;
        padding: 15px;
      }
      
      .team-a .score, .team-b .score {
        font-size: 3rem;
      }
      
      .players {
        font-size: 1rem;
      }
      
      .game-info {
        margin: 10px 0;
      }
      
      .info-box {
        padding: 8px 12px;
      }
      
      .info-box span:last-child {
        font-size: 1.3rem;
      }
      
      .bottom-section {
        margin-top: 10px;
      }
    }
  </style>
</head>
<body>
    <div class="tv-container">
      <!-- Modo QR - Visible cuando no hay partido activo -->
      <div id="qr-mode" class="mode">
        <h2>Modo TV - Cancha #<span id="tv-court-number">1</span></h2>
        
        <div class="qr-section">
          <h3>Escanee para registrar su partido</h3>
          <div id="qrcode"></div>
          <p>Use su smartphone para escanear el código</p>
        </div>
        
        <div class="instructions">
          <h4>¿Cómo registrar un partido?</h4>
          <ol>
            <li>Escanea el código QR con tu teléfono</li>
            <li>Ingresa los datos de los jugadores</li>
            <li>Presiona "Iniciar Partido"</li>
            <li>¡Listo! El marcador se actualizará automáticamente</li>
          </ol>
        </div>
      </div>
    
      <!-- Modo Partido - Visible cuando hay un partido activo -->
      <div id="match-mode" class="mode" style="display: none;">
        <div class="match-header">
          <h2>Partido en curso - Cancha #<span id="active-court-number">1</span></h2>
          <div class="match-timer" id="match-timer">00:00</div>
        </div>
    
        <div class="scoreboard">
          <div class="team team-a">
            <div class="team-name" id="team-a-name">Equipo A</div>
            <div class="players" id="team-a-players">
              <div class="player">Jugador 1</div>
              <div class="player">Jugador 2</div>
            </div>
            <div class="score" id="team-a-score">0</div>
          </div>
          
          <div class="separator">-</div>
          
          <div class="team team-b">
            <div class="team-name" id="team-b-name">Equipo B</div>
            <div class="players" id="team-b-players">
              <div class="player">Jugador 1</div>
              <div class="player">Jugador 2</div>
            </div>
            <div class="score" id="team-b-score">0</div>
          </div>
        </div>
    
        <div class="button-controls">
          <button class="btn team-a-btn" onclick="addPoint('A')">
            <i class="fas fa-plus"></i> PUNTO EQUIPO A
          </button>
          <button class="btn team-b-btn" onclick="addPoint('B')">
            <i class="fas fa-plus"></i> PUNTO EQUIPO B
          </button>
        </div>
      </div>
    </div>
  <script>
    
	// === INICIALIZACIÓN ===
	document.addEventListener('DOMContentLoaded', async () => {
	  try {
	    // Obtener parámetros de la URL
	    const urlParams = new URLSearchParams(window.location.search);
	    const clubId = urlParams.get('club');
	    const courtId = urlParams.get('court');
	    
	    if (!clubId || !courtId) {
	      document.body.innerHTML = `
	        <div class="error-screen">
	          <h1>Error</h1>
	          <p>Parámetros faltantes. Debe incluir club y court en la URL.</p>
	          <button onclick="location.reload()">Recargar Página</button>
	        </div>
	      `;
	      return;
	    }
	    
	    // Validar formato UUID para clubId
	    const uuidRegex = /^[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i;
	    if (!uuidRegex.test(clubId)) {
	      document.body.innerHTML = `
	        <div class="error-screen">
	          <h1>Error</h1>
	          <p>QR inválido. Identificador de club no válido.</p>
	          <button onclick="location.reload()">Recargar Página</button>
	        </div>
	      `;
	      return;
	    }
	    
	    // Configurar variables globales
	    window.clubId = clubId;
	    window.courtId = courtId;
	    
	    // Actualizar interfaz
	    const tvCourtNumber = document.getElementById('court-number');
	    if (tvCourtNumber) {
	      tvCourtNumber.textContent = courtId;
	    }
	    
	    // Inicializar Supabase (solo lectura)
        const supabaseUrl = 'https://omizjfxbxkfkxlxdkbej.supabase.co'; // ¡REEMPLAZA ESTO!
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9taXpqZnhieGtma3hseGRrYmVqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU0NzkyMjIsImV4cCI6MjA3MTA1NTIyMn0.UAj61BfHqIF8Gg9bHYsEF_ocTM8Og4oJN2bWT11N6Rg'; // ¡REEMPLAZA ESTO!
      		
        const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);
        window.supabase = supabase;

	    // Cargar estado inicial
	    await initApp();
	    
	    // Generar QR DESPUÉS de que todo esté listo
	    setTimeout(generateQRCode, 100);
	    
	  } catch (error) {
	    console.error("Error crítico al inicializar:", error);
	    document.body.innerHTML = `
	      <div class="error-screen">
	        <h1>Error</h1>
	        <p>Error crítico al inicializar la aplicación.</p>
	        <button onclick="location.reload()">Recargar Página</button>
	      </div>
	    `;
	  }
	});        
    
    // === FUNCIONES PRINCIPALES ===
    async function initApp() {
      try {
        // Cargar partido activo
        const match = await loadActiveMatch();
        updateDisplay(match);
        
        // Configurar suscripción en tiempo real
        setupRealtimeSubscription();
        
        // Iniciar temporizador si hay partido activo
        if (match) {
          startMatchTimer(match.start_time);
        }
        
      } catch (error) {
        console.error("Error al inicializar la aplicación:", error);
        showErrorScreen("Error al cargar datos. Intente nuevamente.");
      }
    }
    
    async function loadActiveMatch() {
      try {
        // Formato de cancha: "Cancha 1"
        const courtName = `Cancha ${courtId}`;
        
        // Obtener partido activo
        const { data: matchData, error: matchError } = await supabase
          .from('matches')
          .select(`
            *,
            match_players (
              player_id,
              players (
                first_name,
                last_name
              )
            )
          `)
          .eq('court', courtName)
          .eq('status', 'active')
          .maybeSingle();
    
        if (matchError) {
          console.error("Error al cargar partido:", matchError);
          return null;
        }
    
        if (!matchData) {
          return null; // No hay partido activo
        }
    
        // Procesar jugadores
        const teamAPlayers = [];
        const teamBPlayers = [];
    
        if (matchData.match_players) {
          matchData.match_players.forEach(mp => {
            if (mp.players) {
              const playerName = `${mp.players.first_name} ${mp.players.last_name}`;
              if (mp.team === 'teamA') {
                teamAPlayers.push(playerName);
              } else {
                teamBPlayers.push(playerName);
              }
            }
          });
        }
    
        // Devolver partido con información completa
        return {
          ...matchData,
          teamAPlayers,
          teamBPlayers
        };
      } catch (error) {
        console.error("Error al cargar partido:", error);
        return null;
      }
    }
    
    function updateDisplay(match) {
      const qrMode = document.getElementById('qr-mode');
      const matchMode = document.getElementById('match-mode');
      
      if (!match) {
        // Modo QR: No hay partido activo
        qrMode.style.display = 'block';
        matchMode.style.display = 'none';
        return;
      }
      
      // Modo Partido: Actualizar interfaz
      qrMode.style.display = 'none';
      matchMode.style.display = 'block';
      
      // Actualizar puntuación
      document.getElementById('team-a-score').textContent = match.team_a_score || 0;
      document.getElementById('team-b-score').textContent = match.team_b_score || 0;
      
      // Actualizar nombres de jugadores
      updatePlayersDisplay('team-a', match.teamAPlayers);
      updatePlayersDisplay('team-b', match.teamBPlayers);
    }
    
    function updatePlayersDisplay(teamId, players) {
      const playersContainer = document.getElementById(`${teamId}-players`);
      playersContainer.innerHTML = '';
      
      if (!players || players.length === 0) {
        // Mostrar marcadores genéricos si no hay jugadores
        const placeholder = document.createElement('div');
        placeholder.className = 'player placeholder';
        placeholder.textContent = 'Jugador 1';
        playersContainer.appendChild(placeholder);
        
        const placeholder2 = document.createElement('div');
        placeholder2.className = 'player placeholder';
        placeholder2.textContent = 'Jugador 2';
        playersContainer.appendChild(placeholder2);
        return;
      }
      
      // Mostrar jugadores reales
      players.forEach(playerName => {
        const playerEl = document.createElement('div');
        playerEl.className = 'player';
        playerEl.textContent = playerName;
        playersContainer.appendChild(playerEl);
      });
    }
    
    function startMatchTimer(startTime) {
      const timerElement = document.getElementById('match-timer');
      const start = new Date(startTime);
      
      function updateTimer() {
        const now = new Date();
        const diff = now - start;
        const minutes = Math.floor(diff / 60000);
        const seconds = Math.floor((diff % 60000) / 1000);
        
        timerElement.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
      }
      
      // Actualizar inmediatamente y luego cada segundo
      updateTimer();
      window.matchTimerInterval = setInterval(updateTimer, 1000);
    }
    
    // Configurar suscripción en tiempo real
    function setupRealtimeSubscription() {
      try {
        const subscription = supabase
          .channel('tv-channel')
          .on(
            'postgres_changes',
            {
              event: '*',
              schema: 'public',
              table: 'matches',
              filter: `court=eq.Cancha ${courtId}`
            },
            async (payload) => {
              // Actualizar solo si es un partido activo
              if (payload.new.status === 'active' || 
                  (payload.old && payload.old.status === 'active')) {
                const match = await loadActiveMatch();
                updateDisplay(match);
                
                // Reiniciar temporizador si es un nuevo partido
                if (payload.eventType === 'INSERT' && match) {
                  if (window.matchTimerInterval) {
                    clearInterval(window.matchTimerInterval);
                  }
                  startMatchTimer(match.start_time);
                }
              }
            }
          )
          .subscribe();
    
        return subscription;
      } catch (error) {
        console.error("Error al configurar suscripción:", error);
        return null;
      }
    }    
    
    async function addPoint(team) {
      try {
        // Verificar si hay partido activo
        const match = await loadActiveMatch();
        if (!match) {
          alert('No hay un partido activo. Por favor, registre un partido primero.');
          return;
        }
    
        // Preparar datos de actualización
        const updateData = {};
        if (team === 'A') {
          updateData.team_a_score = (match.team_a_score || 0) + 1;
        } else {
          updateData.team_b_score = (match.team_b_score || 0) + 1;
        }
    
        // Actualizar en Supabase
        const { error } = await supabase
          .from('matches')
          .update(updateData)
          .eq('id', match.id);
    
        if (error) {
          console.error('Error al actualizar puntuación:', error);
          alert('Error al registrar punto. Intente nuevamente.');
        }
      } catch (error) {
        console.error('Error inesperado:', error);
        alert('Error inesperado. Intente nuevamente.');
      }
    }
    
    // Función para generar QR - CORREGIDA
    function generateQRCode() {
      // CORREGIDO: El QR debe apuntar a index.html?mode=qr, no a tv.html
      const registrationUrl = `${window.location.origin}/index.html?mode=qr&club=${window.clubId}&court=${window.courtId}`;
      
      const qrElement = document.getElementById('qrcode');
      if (!qrElement) return;
      
      // CORREGIDO: Verificar explícitamente que QRCode esté definido
      if (typeof QRCode === 'undefined') {
        console.error("Biblioteca QRCode no está cargada");
        qrElement.innerHTML = '<div class="qr-error">Biblioteca QR no cargada</div>';
        return;
      }
      
      // Limpiar contenido previo
      qrElement.innerHTML = '';
      
      // Generar QR
      try {
        QRCode.toCanvas(qrElement, registrationUrl, {
          width: 180,
          margin: 1,
          color: {
            dark: '#2c3e50',
            light: '#ffffff'
          }
        }, function(error) {
          if (error) {
            console.error("Error al generar QR:", error);
            qrElement.innerHTML = '<div class="qr-error">Error al generar QR</div>';
          }
        });
      } catch (error) {
        console.error("Error en QRCode.toCanvas:", error);
        qrElement.innerHTML = '<div class="qr-error">Error al generar QR</div>';
      }
    }  
    
    // Función para mostrar errores
    function showErrorScreen(message) {
      document.body.innerHTML = `
        <div class="error-screen">
          <i class="fas fa-exclamation-triangle"></i>
          <h2>Error</h2>
          <p>${message}</p>
          <button onclick="location.reload()">Recargar Página</button>
        </div>
      `;
    }
  </script>
</body>
</html>
