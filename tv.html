<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PadelTrack - Pantalla TV</title>
  <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    :root {
      --primary: #2c3e50;
      --secondary: #e74c3c;
      --accent: #3498db;
      --light: #ecf0f1;
      --dark: #2c3e50;
      --success: #2ecc71;
      --waiting: #e67e22;
      --pending: #f39c12;
    }
    
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Montserrat', sans-serif;
    }
    
    body {
      background: linear-gradient(135deg, #2c3e50 0%, #1a2530 100%);
      color: white;
      min-height: 100vh;
      overflow: hidden;
    }
    
    .container {
      max-width: 100%;
      height: 100vh;
      padding: 20px;
      display: flex;
      flex-direction: column;
    }
    
    .court-header {
      text-align: center;
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 2px solid rgba(255, 255, 255, 0.1);
    }
    
    .court-header h1 {
      font-size: 2.5rem;
      margin-bottom: 10px;
    }
    
    .match-status {
      padding: 8px 16px;
      border-radius: 20px;
      font-weight: bold;
      font-size: 1.1rem;
      display: inline-block;
    }
    
    .status-pending {
      background-color: var(--pending);
    }
    
    .status-active {
      background-color: var(--success);
    }
    
    .status-completed {
      background-color: var(--secondary);
    }
    
    .status-waiting {
      background-color: var(--waiting);
    }
    
    .main-content {
      display: flex;
      flex: 1;
      gap: 30px;
    }
    
    .match-info {
      flex: 2;
      display: flex;
      flex-direction: column;
    }
    
    .scoreboard {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin: 20px 0;
      background-color: rgba(255, 255, 255, 0.1);
      padding: 30px;
      border-radius: 15px;
      flex: 1;
    }
    
    .team {
      text-align: center;
      flex: 1;
    }
    
    .team h2 {
      font-size: 1.8rem;
      margin-bottom: 15px;
      color: var(--light);
    }
    
    .team-a .score {
      color: #3498db;
      font-size: 5rem;
      font-weight: bold;
    }
    
    .team-b .score {
      color: #e74c3c;
      font-size: 5rem;
      font-weight: bold;
    }
    
    .players {
      font-size: 1.4rem;
      margin: 15px 0;
      min-height: 1.4em;
    }
    
    .player {
      margin: 5px 0;
    }
    
    .vs {
      font-size: 3rem;
      font-weight: bold;
      margin: 0 30px;
      opacity: 0.7;
    }
    
    .game-info {
      display: flex;
      justify-content: space-around;
      margin: 20px 0;
    }
    
    .info-box {
      background-color: rgba(255, 255, 255, 0.1);
      padding: 15px 25px;
      border-radius: 10px;
      text-align: center;
      flex: 1;
      margin: 0 10px;
    }
    
    .info-box span:first-child {
      display: block;
      font-size: 1.1rem;
      opacity: 0.8;
      margin-bottom: 8px;
    }
    
    .info-box span:last-child {
      font-size: 1.8rem;
      font-weight: bold;
    }
    
    .scoring-system {
      text-align: center;
      margin: 15px 0;
      font-size: 1.2rem;
      opacity: 0.9;
    }
    
    .tiebreak-indicator {
      background-color: #e67e22;
      color: white;
      padding: 8px 16px;
      border-radius: 20px;
      font-weight: bold;
      display: inline-block;
      margin: 10px 0;
    }
    
    .qr-section {
      flex: 1;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      background-color: rgba(255, 255, 255, 0.05);
      border-radius: 15px;
      padding: 25px;
    }
    
    #qrcode {
      margin: 20px auto;
      display: inline-block;
      background: white;
      padding: 15px;
      border-radius: 10px;
    }
    
    .qr-section h3 {
      font-size: 1.4rem;
      margin-bottom: 10px;
      text-align: center;
    }
    
    .qr-section p {
      font-size: 1.1rem;
      opacity: 0.8;
      text-align: center;
      margin-top: 15px;
    }
    
    .team-names {
      display: flex;
      justify-content: space-around;
      margin-top: 20px;
    }
    
    .team-name {
      font-size: 1.3rem;
      font-weight: bold;
      padding: 10px 20px;
      border-radius: 8px;
      background-color: rgba(255, 255, 255, 0.1);
    }
    
    .team-a-name {
      color: #3498db;
    }
    
    .team-b-name {
      color: #e74c3c;
    }
    
    .simulation-controls {
      margin-top: 20px;
      padding: 15px;
      background-color: rgba(255, 255, 255, 0.05);
      border-radius: 10px;
      text-align: center;
    }
    
    .simulation-controls h3 {
      margin-bottom: 10px;
      font-size: 1.2rem;
    }
    
    .simulation-buttons {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin-top: 10px;
      flex-wrap: wrap;
    }
    
    .sim-btn {
      padding: 8px 15px;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-weight: bold;
    }
    
    .sim-btn:hover {
      opacity: 0.9;
    }
    
    .sim-btn.team-a {
      background-color: #3498db;
    }
    
    .sim-btn.team-b {
      background-color: #e74c3c;
    }
    
    .sim-btn.secondary {
      background-color: #7f8c8d;
    }
    
    /* Responsive adjustments for TV */
    @media (max-width: 1200px) {
      .team-a .score, .team-b .score {
        font-size: 4rem;
      }
      
      .players {
        font-size: 1.2rem;
      }
      
      .vs {
        font-size: 2.5rem;
      }
    }
    
    @media (max-width: 900px) {
      .main-content {
        flex-direction: column;
      }
      
      .scoreboard {
        flex-direction: column;
        gap: 25px;
      }
      
      .vs {
        margin: 15px 0;
        transform: rotate(0deg);
      }
      
      .qr-section {
        margin-top: 20px;
      }
      
      .simulation-buttons {
        flex-direction: column;
      }
    }

    @media (max-height: 800px) {
      .container {
        padding: 15px;
      }
      
      .court-header {
        margin-bottom: 15px;
      }
      
      .court-header h1 {
        font-size: 2rem;
      }
      
      .scoreboard {
        margin: 15px 0;
        padding: 20px;
      }
      
      .team-a .score, .team-b .score {
        font-size: 3.5rem;
      }
      
      .players {
        font-size: 1.1rem;
      }
      
      .game-info {
        margin: 15px 0;
      }
      
      .info-box {
        padding: 10px 15px;
      }
      
      .info-box span:last-child {
        font-size: 1.5rem;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="court-header">
      <h1>Cancha #<span id="court-number">2</span></h1>
      <div class="match-status status-waiting" id="match-status">En espera</div>
    </div>
    
    <div class="main-content">
      <div class="match-info">
        <div class="scoreboard">
          <div class="team team-a">
            <h2 id="team-a-name">EQUIPO A</h2>
            <div class="players" id="team-a-players">
              <div class="player">Jugador 1</div>
              <div class="player">Jugador 2</div>
            </div>
            <div class="score" id="team-a-score">0</div>
          </div>
          
          <div class="vs">VS</div>
          
          <div class="team team-b">
            <h2 id="team-b-name">EQUIPO B</h2>
            <div class="players" id="team-b-players">
              <div class="player">Jugador 1</div>
              <div class="player">Jugador 2</div>
            </div>
            <div class="score" id="team-b-score">0</div>
          </div>
        </div>
        
        <div class="game-info">
          <div class="info-box">
            <span>Duración</span>
            <span id="match-duration">00:00</span>
          </div>
          <div class="info-box">
            <span>Puntos totales</span>
            <span id="total-points">0</span>
          </div>
          <div class="info-box">
            <span>Juegos</span>
            <span id="games-score">0-0</span>
          </div>
        </div>
        
        <div class="scoring-system" id="scoring-system">
          Sistema Tradicional
        </div>
        
        <div id="tiebreak-container" style="display: none;">
          <div class="tiebreak-indicator">
            <i class="fas fa-bolt"></i> Tiebreak en progreso
          </div>
        </div>

        <div class="simulation-controls">
          <h3>Simulación de Puntos (Para pruebas)</h3>
          <div class="simulation-buttons">
            <button class="sim-btn team-a" onclick="addPoint('A')">Punto Equipo A</button>
            <button class="sim-btn team-b" onclick="addPoint('B')">Punto Equipo B</button>
            <button class="sim-btn secondary" onclick="addGame('A')">Juego Equipo A</button>
            <button class="sim-btn secondary" onclick="addGame('B')">Juego Equipo B</button>
            <button class="sim-btn" style="background-color: #9b59b6;" onclick="toggleTiebreak()">Toggle Tiebreak</button>
            <button class="sim-btn" style="background-color: #e74c3c;" onclick="endMatch()">Finalizar Partido</button>
          </div>
        </div>
      </div>
      
      <div class="qr-section">
        <h3>Escanee para registrar su partido</h3>
        <div id="qrcode"></div>
        <div class="team-names">
          <div class="team-name team-a-name" id="team-a-display">EQUIPO A</div>
          <div class="team-name team-b-name" id="team-b-display">EQUIPO B</div>
        </div>
        <p>Use su smartphone para escanear el código</p>
      </div>
    </div>
  </div>

  <script>
    // Configuración de Supabase (reemplaza con tus propias credenciales)
    const supabaseUrl = 'https://omizjfxbxkfkxlxdkbej.supabase.co'; // ¡REEMPLAZA ESTO!
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9taXpqZnhieGtma3hseGRrYmVqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU0NzkyMjIsImV4cCI6MjA3MTA1NTIyMn0.UAj61BfHqIF8Gg9bHYsEF_ocTM8Og4oJN2bWT11N6Rg'; // ¡REEMPLAZA ESTO!
      
    
    // Inicializar Supabase
    const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);
	window.supabase = supabase;
    
    // Estado del partido
    let matchState = {
      id: null,
      club_id: null,
      court: "",
      scoring_type: "traditional",
      team_a_name: "EQUIPO A",
      team_b_name: "EQUIPO B",
      winner: null,
      games_a: 0,
      games_b: 0,
      points_a: 0,
      points_b: 0,
      tiebreak: false,
      duration: "00:00",
      status: "waiting",
      team_a_players: ["Jugador 1", "Jugador 2"],
      team_b_players: ["Jugador 1", "Jugador 2"],
      startTime: null,
      timerInterval: null
    };

    // === INICIALIZACIÓN ===
    document.addEventListener('DOMContentLoaded', async () => {
      try {
        // Obtener parámetros de la URL
        const urlParams = new URLSearchParams(window.location.search);
        const clubId = urlParams.get('club');
        const courtId = urlParams.get('court') || "2";
        
        // 🔐 VALIDACIÓN CRÍTICA: Verificar que tenemos clubId
        if (!clubId) {
          showErrorScreen("URL inválida: falta el identificador del club. Contacte al administrador.");
          return;
        }
        
        // Validar formato UUID del club
        const uuidRegex = /^[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i;
        if (!uuidRegex.test(clubId)) {
          showErrorScreen("URL inválida: identificador de club incorrecto. Contacte al administrador.");
          return;
        }
        
        // Configurar variables globales con validación
        window.clubId = clubId;
        matchState.club_id = clubId;
        matchState.court = `Cancha ${courtId}`;
        
        // Actualizar interfaz
        const tvCourtNumber = document.getElementById('court-number');
        if (tvCourtNumber) {
          tvCourtNumber.textContent = courtId;
        }
        
        // Inicializar con estado en espera
        resetDisplay();
        
        // Configurar suscripción a cambios en la base de datos
        setupRealtimeSubscription();
        
        // Cargar partido activo si existe
        await loadActiveMatch();
        
        // Generar QR
        setTimeout(generateQRCode, 100);
        
      } catch (error) {
        console.error("Error crítico al inicializar:", error);
        showErrorScreen("Error al inicializar la aplicación.");
      }
    });
    
    // Configurar suscripción en tiempo real
    function setupRealtimeSubscription() {
      try {
        // Suscribirse a cambios en la tabla de partidos
        const subscription = supabase
          .channel('matches')
          .on('postgres_changes', 
            { 
              event: '*', 
              schema: 'public', 
              table: 'matches',
              filter: `court=eq.${matchState.court}`
            }, 
            handleMatchUpdate)
          .subscribe();
          
        console.log("Suscripción a cambios en tiempo real configurada");
      } catch (error) {
        console.error("Error al configurar suscripción:", error);
      }
    }
    
    // Configurar suscripción en tiempo real
    function setupRealtimeSubscription() {
      try {
        // 🔐 FILTRO MEJORADO: Solo suscribirse a partidos del club y cancha específicos
        const subscription = supabase
          .channel('matches')
          .on('postgres_changes', 
            { 
              event: '*', 
              schema: 'public', 
              table: 'matches',
              filter: `club_id=eq.${matchState.club_id}`
            }, 
            (payload) => {
              // 🔐 FILTRADO ADICIONAL: Verificar que el partido es de esta cancha
              if (payload.new && payload.new.court === matchState.court) {
                handleMatchUpdate(payload);
              }
            })
          .subscribe();
          
        console.log("Suscripción a cambios en tiempo real configurada para club:", matchState.club_id);
      } catch (error) {
        console.error("Error al configurar suscripción:", error);
      }
    }
    
    // Cargar partido activo
    async function loadActiveMatch() {
      try {
        const { data: match, error } = await supabase
          .from('matches')
          .select('*')
          .eq('club_id', matchState.club_id)  // 🔐 Solo partidos de este club
          .eq('court', matchState.court)
          .eq('status', 'active')
          .order('created_at', { ascending: false })
          .limit(1)
          .single();
          
        if (error && error.code !== 'PGRST116') {
          console.error("Error al cargar partido activo:", error);
          return;
        }
        
        if (match) {
          // 🔐 VERIFICACIÓN ADICIONAL: Asegurar que el partido pertenece al club
          if (match.club_id !== matchState.club_id) {
            console.warn("Intento de acceso a partido de otro club detectado.");
            return;
          }
          
          await updateMatchDisplay(match);
        } else {
          // Verificar si hay un partido pendiente
          const { data: pendingMatch, error: pendingError } = await supabase
            .from('matches')
            .select('*')
            .eq('club_id', matchState.club_id)  // 🔐 Solo partidos de este club
            .eq('court', matchState.court)
            .eq('status', 'pending')
            .order('created_at', { ascending: false })
            .limit(1)
            .single();
            
          if (pendingMatch && !pendingError) {
            // 🔐 VERIFICACIÓN ADICIONAL: Asegurar que el partido pertenece al club
            if (pendingMatch.club_id !== matchState.club_id) {
              console.warn("Intento de acceso a partido de otro club detectado.");
              return;
            }
            
            updateMatchStatus('pending');
          }
        }
      } catch (error) {
        console.error("Error al cargar partido activo:", error);
      }
    }
    
    // Actualizar la pantalla con datos del partido
    async function updateMatchDisplay(match) {
      
	  // 🔐 VERIFICACIÓN DE SEGURIDAD: Asegurar que el partido pertenece al club
	  if (match.club_id !== matchState.club_id) {
	    console.warn("Intento de mostrar partido de otro club detectado.");
	    return;
	  }	  
	  
	  // Actualizar estado interno
      matchState = {
        ...matchState,
        id: match.id,
        club_id: match.club_id,
        court: match.court,
        scoring_type: match.scoring_type,
        team_a_name: match.team_a_name || "EQUIPO A",
        team_b_name: match.team_b_name || "EQUIPO B",
        winner: match.winner,
        games_a: match.games_a || 0,
        games_b: match.games_b || 0,
        points_a: match.points_a || 0,
        points_b: match.points_b || 0,
        tiebreak: match.tiebreak || false,
        duration: match.duration || "00:00",
        status: match.status,
        team_a_players: match.team_a_players || ["Jugador 1", "Jugador 2"],
        team_b_players: match.team_b_players || ["Jugador 1", "Jugador 2"]
      };
      
      // Actualizar nombres de equipos
      document.getElementById('team-a-name').textContent = matchState.team_a_name;
      document.getElementById('team-b-name').textContent = matchState.team_b_name;
      document.getElementById('team-a-display').textContent = matchState.team_a_name;
      document.getElementById('team-b-display').textContent = matchState.team_b_name;
      
      // Actualizar jugadores
      updatePlayersDisplay('team-a', matchState.team_a_players);
      updatePlayersDisplay('team-b', matchState.team_b_players);
      
      // Actualizar puntuación
      document.getElementById('team-a-score').textContent = matchState.points_a;
      document.getElementById('team-b-score').textContent = matchState.points_b;
      document.getElementById('total-points').textContent = matchState.points_a + matchState.points_b;
      document.getElementById('games-score').textContent = `${matchState.games_a}-${matchState.games_b}`;
      
      // Actualizar sistema de puntuación
      document.getElementById('scoring-system').textContent = 
        matchState.scoring_type === 'american' ? 'Sistema Americano' : 'Sistema Tradicional';
      
      // Actualizar tiebreak
      if (matchState.tiebreak) {
        document.getElementById('tiebreak-container').style.display = 'block';
      } else {
        document.getElementById('tiebreak-container').style.display = 'none';
      }
      
      // Iniciar temporizador si es un partido activo
      if (matchState.status === 'active' && !matchState.timerInterval) {
        matchState.startTime = new Date(match.created_at);
        startTimer();
      }
      
      // Actualizar estado
      updateMatchStatus(matchState.status);
    }
    
    // Actualizar visualización de jugadores
    function updatePlayersDisplay(teamId, players) {
      const playersContainer = document.getElementById(`${teamId}-players`);
      playersContainer.innerHTML = '';
      
      if (!players || players.length === 0) {
        playersContainer.innerHTML = `
          <div class="player">Jugador 1</div>
          <div class="player">Jugador 2</div>
        `;
        return;
      }
      
      players.forEach(player => {
        const playerEl = document.createElement('div');
        playerEl.className = 'player';
        playerEl.textContent = player;
        playersContainer.appendChild(playerEl);
      });
    }
    
    // Actualizar estado del partido
    function updateMatchStatus(status) {
      const statusElement = document.getElementById('match-status');
      statusElement.className = 'match-status';
      
      switch(status) {
        case 'pending':
          statusElement.classList.add('status-pending');
          statusElement.textContent = 'Partido Pendiente';
          break;
        case 'active':
          statusElement.classList.add('status-active');
          statusElement.textContent = 'En Curso';
          break;
        case 'completed':
          statusElement.classList.add('status-completed');
          statusElement.textContent = 'Partido Finalizado';
          break;
        default:
          statusElement.classList.add('status-waiting');
          statusElement.textContent = 'En Espera';
      }
      
      matchState.status = status;
    }
    
    // Reiniciar visualización
    function resetDisplay() {
      if (matchState.timerInterval) {
        clearInterval(matchState.timerInterval);
        matchState.timerInterval = null;
      }
      
      // Restablecer estado
      matchState = {
        ...matchState,
        id: null,
        team_a_name: "EQUIPO A",
        team_b_name: "EQUIPO B",
        winner: null,
        games_a: 0,
        games_b: 0,
        points_a: 0,
        points_b: 0,
        tiebreak: false,
        duration: "00:00",
        status: "waiting",
        team_a_players: ["Jugador 1", "Jugador 2"],
        team_b_players: ["Jugador 1", "Jugador 2"],
        startTime: null
      };
      
      // Actualizar UI
      document.getElementById('team-a-score').textContent = '0';
      document.getElementById('team-b-score').textContent = '0';
      document.getElementById('total-points').textContent = '0';
      document.getElementById('games-score').textContent = '0-0';
      document.getElementById('match-duration').textContent = '00:00';
      document.getElementById('tiebreak-container').style.display = 'none';
      
      document.getElementById('team-a-name').textContent = 'EQUIPO A';
      document.getElementById('team-b-name').textContent = 'EQUIPO B';
      document.getElementById('team-a-display').textContent = 'EQUIPO A';
      document.getElementById('team-b-display').textContent = 'EQUIPO B';
      
      updatePlayersDisplay('team-a', matchState.team_a_players);
      updatePlayersDisplay('team-b', matchState.team_b_players);
      
      updateMatchStatus('waiting');
    }
    
    // Iniciar temporizador
    function startTimer() {
      if (matchState.timerInterval) {
        clearInterval(matchState.timerInterval);
      }
      
      matchState.timerInterval = setInterval(() => {
        const now = new Date();
        const diff = now - matchState.startTime;
        const minutes = Math.floor(diff / 60000);
        const seconds = Math.floor((diff % 60000) / 1000);
        
        matchState.duration = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        document.getElementById('match-duration').textContent = matchState.duration;
        
        // Actualizar duración en la base de datos cada minuto
        if (seconds === 0 && matchState.id) {
          updateMatchDuration();
        }
      }, 1000);
    }
    
    // Actualizar duración en la base de datos
    async function updateMatchDuration() {
      try {
        const { error } = await supabase
          .from('matches')
          .update({ 
            duration: matchState.duration,
            updated_at: new Date().toISOString()
          })
          .eq('id', matchState.id);
          
        if (error) {
          console.error("Error al actualizar duración:", error);
        }
      } catch (error) {
        console.error("Error al actualizar duración:", error);
      }
    }
    
    // Añadir punto (simulación)
    async function addPoint(team) {
      if (!matchState.id || matchState.status !== 'active') {
        alert("No hay un partido activo para añadir puntos");
        return;
      }
      
      // 🔐 VERIFICACIÓN ADICIONAL: Asegurar que estamos modificando un partido de nuestro club
      if (matchState.club_id !== window.clubId) {
        alert("No tiene permisos para modificar este partido.");
        return;
      }      
	  
      try {
        // Determinar qué campo actualizar según el equipo
        const field = team === 'A' ? 'points_a' : 'points_b';
        const newValue = team === 'A' ? matchState.points_a + 1 : matchState.points_b + 1;
        
        // Actualizar en la base de datos
        const { error } = await supabase
          .from('matches')
          .update({ 
            [field]: newValue,
            updated_at: new Date().toISOString()
          })
          .eq('id', matchState.id);
          
        if (error) {
          console.error("Error al actualizar punto:", error);
          alert("Error al registrar el punto. Intenta nuevamente.");
        } else {
          console.log(`Punto registrado para equipo ${team}`);
          
          // Actualizar estado local
          if (team === 'A') {
            matchState.points_a = newValue;
          } else {
            matchState.points_b = newValue;
          }
          
          // Actualizar UI
          document.getElementById('team-a-score').textContent = matchState.points_a;
          document.getElementById('team-b-score').textContent = matchState.points_b;
          document.getElementById('total-points').textContent = matchState.points_a + matchState.points_b;
        }
      } catch (error) {
        console.error("Error al añadir punto:", error);
      }
    }
    
    // Añadir juego (simulación)
    async function addGame(team) {
      if (!matchState.id || matchState.status !== 'active') {
        alert("No hay un partido activo para añadir juegos");
        return;
      }
      
      // 🔐 VERIFICACIÓN DE SEGURIDAD: Asegurar que estamos modificando un partido de nuestro club
      if (matchState.club_id !== window.clubId) {
        alert("No tiene permisos para modificar este partido.");
        return;
      }
      
      try {
        // Determinar qué campo actualizar según el equipo
        const field = team === 'A' ? 'games_a' : 'games_b';
        const newValue = team === 'A' ? matchState.games_a + 1 : matchState.games_b + 1;
        
        // Actualizar en la base de datos
        const { error } = await supabase
          .from('matches')
          .update({ 
            [field]: newValue,
            updated_at: new Date().toISOString()
          })
          .eq('id', matchState.id)
          .eq('club_id', window.clubId); // 🔐 Filtro adicional de seguridad
        
        if (error) {
          console.error("Error al actualizar juego:", error);
          alert("Error al registrar el juego. Intenta nuevamente.");
        } else {
          console.log(`Juego registrado para equipo ${team}`);
          
          // Actualizar estado local
          if (team === 'A') {
            matchState.games_a = newValue;
          } else {
            matchState.games_b = newValue;
          }
          
          // Actualizar UI
          document.getElementById('games-score').textContent = `${matchState.games_a}-${matchState.games_b}`;
        }
      } catch (error) {
        console.error("Error al añadir juego:", error);
      }
    }    
    
    // Alternar tiebreak
    async function toggleTiebreak() {
      if (!matchState.id || matchState.status !== 'active') {
        alert("No hay un partido activo para modificar el tiebreak");
        return;
      }
      
      // 🔐 VERIFICACIÓN DE SEGURIDAD: Asegurar que estamos modificando un partido de nuestro club
      if (matchState.club_id !== window.clubId) {
        alert("No tiene permisos para modificar este partido.");
        return;
      }
      
      try {
        const newTiebreakValue = !matchState.tiebreak;
        
        // Actualizar en la base de datos
        const { error } = await supabase
          .from('matches')
          .update({ 
            tiebreak: newTiebreakValue,
            updated_at: new Date().toISOString()
          })
          .eq('id', matchState.id)
          .eq('club_id', window.clubId); // 🔐 Filtro adicional de seguridad
          
        if (error) {
          console.error("Error al actualizar tiebreak:", error);
          alert("Error al modificar el tiebreak. Intenta nuevamente.");
        } else {
          console.log(`Tiebreak ${newTiebreakValue ? 'activado' : 'desactivado'}`);
          
          // Actualizar estado local
          matchState.tiebreak = newTiebreakValue;
          
          // Actualizar UI
          if (matchState.tiebreak) {
            document.getElementById('tiebreak-container').style.display = 'block';
          } else {
            document.getElementById('tiebreak-container').style.display = 'none';
          }
        }
      } catch (error) {
        console.error("Error al alternar tiebreak:", error);
      }
    }    
    
    // Finalizar partido
    async function endMatch() {
      if (!matchState.id || matchState.status !== 'active') {
        alert("No hay un partido activo para finalizar");
        return;
      }
      
      // 🔐 VERIFICACIÓN DE SEGURIDAD: Asegurar que estamos modificando un partido de nuestro club
      if (matchState.club_id !== window.clubId) {
        alert("No tiene permisos para modificar este partido.");
        return;
      }
      
      try {
        // Determinar ganador
        let winner = null;
        if (matchState.scoring_type === 'traditional') {
          // Lógica para determinar ganador en sistema tradicional
          winner = matchState.games_a > matchState.games_b ? 'team_a' : 'team_b';
        } else {
          // Lógica para determinar ganador en sistema americano
          winner = matchState.points_a > matchState.points_b ? 'team_a' : 'team_b';
        }
        
        // Actualizar en la base de datos
        const { error } = await supabase
          .from('matches')
          .update({ 
            status: 'completed',
            winner: winner,
            updated_at: new Date().toISOString()
          })
          .eq('id', matchState.id)
          .eq('club_id', window.clubId); // 🔐 Filtro adicional de seguridad
          
        if (error) {
          console.error("Error al finalizar partido:", error);
          alert("Error al finalizar el partido. Intenta nuevamente.");
        } else {
          console.log("Partido finalizado");
          resetDisplay();
        }
      } catch (error) {
        console.error("Error al finalizar partido:", error);
      }
    }
    
    // Función para generar QR
    function generateQRCode() {
      // 🔐 GENERACIÓN SEGURA: Usar solo el club_id de la URL actual
      if (!window.clubId) {
        console.error("No se puede generar QR: falta clubId");
        return;
      }
      
      const courtNumber = matchState.court.replace('Cancha ', '');
      const registrationUrl = `${window.location.origin}/index.html?mode=qr&club=${window.clubId}&court=${courtNumber}`;
      
      const qrElement = document.getElementById('qrcode');
      if (!qrElement) return;
    
      // Limpiar contenido previo
      qrElement.innerHTML = '';      
    
      // Crear un elemento canvas para el QR
      const canvas = document.createElement('canvas');
      qrElement.appendChild(canvas);
    
      // Generar QR
      try {
        QRCode.toCanvas(canvas, registrationUrl, {
          width: 200,
          margin: 1,
          color: {
            dark: '#2c3e50',
            light: '#ffffff'
          }
        }, function(error) {
          if (error) {
            console.error("Error al generar QR:", error);
            qrElement.innerHTML = '<div style="color: white; padding: 20px; text-align: center;">Error al generar QR</div>';
          }
        });
      } catch (error) {
        console.error("Error en QRCode.toCanvas:", error);
        qrElement.innerHTML = '<div style="color: white; padding: 20px; text-align: center;">Error al generar QR</div>';
      }
    }       
    
    // Función para mostrar errores
    function showErrorScreen(message) {
      document.body.innerHTML = `
        <div style="display: flex; justify-content: center; align-items: center; height: 100vh; flex-direction: column; text-align: center; padding: 20px;">
          <h1 style="color: #e74c3c; margin-bottom: 20px;">Error de Configuración</h1>
          <p style="margin-bottom: 30px; font-size: 18px;">${message}</p>
          <button onclick="location.reload()" style="padding: 12px 24px; background: #3498db; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 16px;">Reintentar</button>
          <p style="margin-top: 30px; color: #7f8c8d; font-size: 14px;">Si el problema persiste, contacte al administrador del sistema.</p>
        </div>
      `;
    }
  </script>
</body>
</html>
