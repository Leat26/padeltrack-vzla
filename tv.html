<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PadelTrack - Pantalla TV</title>
  <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    :root {
      --primary: #2c3e50;
      --secondary: #e74c3c;
      --accent: #3498db;
      --light: #ecf0f1;
      --dark: #2c3e50;
      --success: #2ecc71;
      --waiting: #e67e22;
      --pending: #f39c12;
    }
    
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Montserrat', sans-serif;
    }
    
    body {
      background: linear-gradient(135deg, #2c3e50 0%, #1a2530 100%);
      color: white;
      min-height: 100vh;
      overflow: hidden;
    }
    
    .container {
      max-width: 100%;
      height: 100vh;
      padding: 20px;
      display: flex;
      flex-direction: column;
    }
    
    .court-header {
      text-align: center;
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 2px solid rgba(255, 255, 255, 0.1);
    }
    
    .court-header h1 {
      font-size: 2.5rem;
      margin-bottom: 10px;
    }
    
    .match-status {
      padding: 8px 16px;
      border-radius: 20px;
      font-weight: bold;
      font-size: 1.1rem;
      display: inline-block;
    }
    
    .status-pending {
      background-color: var(--pending);
    }
    
    .status-active {
      background-color: var(--success);
    }
    
    .status-completed {
      background-color: var(--secondary);
    }
    
    .status-waiting {
      background-color: var(--waiting);
    }
    
    .main-content {
      display: flex;
      flex: 1;
      gap: 30px;
    }
    
    .match-info {
      flex: 2;
      display: flex;
      flex-direction: column;
    }
    
    .scoreboard {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin: 20px 0;
      background-color: rgba(255, 255, 255, 0.1);
      padding: 30px;
      border-radius: 15px;
      flex: 1;
    }
    
    .team {
      text-align: center;
      flex: 1;
    }
    
    .team h2 {
      font-size: 1.8rem;
      margin-bottom: 15px;
      color: var(--light);
    }
    
    .team-a .score {
      color: #3498db;
      font-size: 5rem;
      font-weight: bold;
    }
    
    .team-b .score {
      color: #e74c3c;
      font-size: 5rem;
      font-weight: bold;
    }
    
    .players {
      font-size: 1.4rem;
      margin: 15px 0;
      min-height: 1.4em;
    }
    
    .player {
      margin: 5px 0;
    }
    
    .vs {
      font-size: 3rem;
      font-weight: bold;
      margin: 0 30px;
      opacity: 0.7;
    }
    
    .game-info {
      display: flex;
      justify-content: space-around;
      margin: 20px 0;
    }
    
    .info-box {
      background-color: rgba(255, 255, 255, 0.1);
      padding: 15px 25px;
      border-radius: 10px;
      text-align: center;
      flex: 1;
      margin: 0 10px;
    }
    
    .info-box span:first-child {
      display: block;
      font-size: 1.1rem;
      opacity: 0.8;
      margin-bottom: 8px;
    }
    
    .info-box span:last-child {
      font-size: 1.8rem;
      font-weight: bold;
    }
    
    .scoring-system {
      text-align: center;
      margin: 15px 0;
      font-size: 1.2rem;
      opacity: 0.9;
    }
    
    .tiebreak-indicator {
      background-color: #e67e22;
      color: white;
      padding: 8px 16px;
      border-radius: 20px;
      font-weight: bold;
      display: inline-block;
      margin: 10px 0;
    }
    
    .qr-section {
      flex: 1;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      background-color: rgba(255, 255, 255, 0.05);
      border-radius: 15px;
      padding: 25px;
    }
    
    #qrcode {
      margin: 20px auto;
      display: inline-block;
      background: white;
      padding: 15px;
      border-radius: 10px;
    }
    
    .qr-section h3 {
      font-size: 1.4rem;
      margin-bottom: 10px;
      text-align: center;
    }
    
    .qr-section p {
      font-size: 1.1rem;
      opacity: 0.8;
      text-align: center;
      margin-top: 15px;
    }
    
    .team-names {
      display: flex;
      justify-content: space-around;
      margin-top: 20px;
    }
    
    .team-name {
      font-size: 1.3rem;
      font-weight: bold;
      padding: 10px 20px;
      border-radius: 8px;
      background-color: rgba(255, 255, 255, 0.1);
    }
    
    .team-a-name {
      color: #3498db;
    }
    
    .team-b-name {
      color: #e74c3c;
    }
    
    .simulation-controls {
      margin-top: 20px;
      padding: 15px;
      background-color: rgba(255, 255, 255, 0.05);
      border-radius: 10px;
      text-align: center;
    }
    
    .simulation-controls h3 {
      margin-bottom: 10px;
      font-size: 1.2rem;
    }
    
    .simulation-buttons {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin-top: 10px;
      flex-wrap: wrap;
    }
    
    .sim-btn {
      padding: 8px 15px;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-weight: bold;
    }
    
    .sim-btn:hover {
      opacity: 0.9;
    }
    
    .sim-btn.team-a {
      background-color: #3498db;
    }
    
    .sim-btn.team-b {
      background-color: #e74c3c;
    }
    
    .sim-btn.secondary {
      background-color: #7f8c8d;
    }
    
    /* Responsive adjustments for TV */
    @media (max-width: 1200px) {
      .team-a .score, .team-b .score {
        font-size: 4rem;
      }
      
      .players {
        font-size: 1.2rem;
      }
      
      .vs {
        font-size: 2.5rem;
      }
    }
    
    @media (max-width: 900px) {
      .main-content {
        flex-direction: column;
      }
      
      .scoreboard {
        flex-direction: column;
        gap: 25px;
      }
      
      .vs {
        margin: 15px 0;
        transform: rotate(0deg);
      }
      
      .qr-section {
        margin-top: 20px;
      }
      
      .simulation-buttons {
        flex-direction: column;
      }
    }

    @media (max-height: 800px) {
      .container {
        padding: 15px;
      }
      
      .court-header {
        margin-bottom: 15px;
      }
      
      .court-header h1 {
        font-size: 2rem;
      }
      
      .scoreboard {
        margin: 15px 0;
        padding: 20px;
      }
      
      .team-a .score, .team-b .score {
        font-size: 3.5rem;
      }
      
      .players {
        font-size: 1.1rem;
      }
      
      .game-info {
        margin: 15px 0;
      }
      
      .info-box {
        padding: 10px 15px;
      }
      
      .info-box span:last-child {
        font-size: 1.5rem;
      }
    }
	
    /* Estilos para puntuación tradicional */
    .traditional-score {
      font-size: 4rem;
      font-weight: bold;
    }
    
    .advantage-score {
      color: #FFD700; /* Dorado para ventaja */
      font-size: 3.5rem;
    }
    
    .tiebreak-score {
      color: #FF9800; /* Naranja para tiebreak */
    }	
	
    /* Estilos para la visualización de GAME */
    .game-score {
      font-size: 3.5rem !important;
      font-weight: bold;
      color: #4CAF50 !important;
      animation: pulse 0.5s ease-in-out;
    }
    
    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.1); }
      100% { transform: scale(1); }
    }
    
    /* Estilos para ventaja (AD) */
    .advantage-score {
      color: #FFD700 !important;
      font-weight: bold;
    }	
	
    /* Estilos para sets y notificaciones */
    .sets-display {
      display: flex;
      justify-content: center;
      gap: 30px;
      margin: 15px 0;
      font-size: 1.8rem;
      font-weight: bold;
    }
    
    .team-a-sets {
      color: #D32F2F;
    }
    
    .team-b-sets {
      color: #1976D2;
    }
    
    .set-notification {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(0, 0, 0, 0.9);
      color: white;
      padding: 20px 30px;
      border-radius: 10px;
      font-size: 1.8rem;
      font-weight: bold;
      z-index: 1000;
      animation: fadeInOut 3s forwards;
    }
    
    @keyframes fadeInOut {
      0% { 
        opacity: 0; 
        transform: translate(-50%, -50%) scale(0.8); 
      }
      20% { 
        opacity: 1; 
        transform: translate(-50%, -50%) scale(1.1); 
      }
      30% { 
        transform: translate(-50%, -50%) scale(1); 
      }
      80% { 
        opacity: 1; 
      }
      100% { 
        opacity: 0; 
      }
    }
    
    .current-set {
      text-align: center;
      margin: 10px 0;
      font-size: 1.4rem;
      font-weight: bold;
      color: #7f8c8d;
    }	
  </style>
</head>
<body>
  <div class="container">
    <div class="court-header">
      <h1>Cancha #<span id="court-number">2</span></h1>
      <div class="match-status status-waiting" id="match-status">En espera</div>
    </div>
    
    <div class="main-content">
      <div class="match-info">
        <div class="scoreboard">
          <div class="team team-a">
            <h2 id="team-a-name">EQUIPO A</h2>
            <div class="players" id="team-a-players">
              <div class="player">Jugador 1</div>
              <div class="player">Jugador 2</div>
            </div>
            <div class="score" id="team-a-score">0</div>
          </div>
          
          <div class="vs">VS</div>
          
          <div class="team team-b">
            <h2 id="team-b-name">EQUIPO B</h2>
            <div class="players" id="team-b-players">
              <div class="player">Jugador 1</div>
              <div class="player">Jugador 2</div>
            </div>
            <div class="score" id="team-b-score">0</div>
          </div>
        </div>
        
        <div class="game-info">
          <div class="info-box">
            <span>Duración</span>
            <span id="match-duration">00:00</span>
          </div>
          <div class="info-box">
            <span>Puntos totales</span>
            <span id="total-points">0</span>
          </div>
          <div class="info-box">
            <span>Juegos</span>
            <span id="games-score">0-0</span>
          </div>
        </div>
        
        <div class="scoring-system" id="scoring-system">
          Sistema Tradicional
        </div>
        
        <div id="tiebreak-container" style="display: none;">
          <div class="tiebreak-indicator">
            <i class="fas fa-bolt"></i> Tiebreak en progreso
          </div>
        </div>

        <div class="simulation-controls">
          <h3>Simulación de Puntos (Para pruebas)</h3>
          <div class="simulation-buttons">
            <button class="sim-btn team-a" onclick="addPoint('A')">Punto Equipo A</button>
            <button class="sim-btn team-b" onclick="addPoint('B')">Punto Equipo B</button>
            <button class="sim-btn secondary" onclick="addGame('A')">Juego Equipo A</button>
            <button class="sim-btn secondary" onclick="addGame('B')">Juego Equipo B</button>
            <button class="sim-btn" style="background-color: #9b59b6;" onclick="toggleTiebreak()">Toggle Tiebreak</button>
            <button class="sim-btn" style="background-color: #e74c3c;" onclick="endMatch()">Finalizar Partido</button>
          </div>
        </div>
      </div>
      
      <div class="qr-section">
        <h3>Escanee para registrar su partido</h3>
        <div id="qrcode"></div>
        <div class="team-names">
          <div class="team-name team-a-name" id="team-a-display">EQUIPO A</div>
          <div class="team-name team-b-name" id="team-b-display">EQUIPO B</div>
        </div>
        <p>Use su smartphone para escanear el código</p>
      </div>
    </div>
  </div>

  <script>
    // Configuración de Supabase (reemplaza con tus propias credenciales)
    const supabaseUrl = 'https://omizjfxbxkfkxlxdkbej.supabase.co'; // ¡REEMPLAZA ESTO!
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9taXpqZnhieGtma3hseGRrYmVqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU0NzkyMjIsImV4cCI6MjA3MTA1NTIyMn0.UAj61BfHqIF8Gg9bHYsEF_ocTM8Og4oJN2bWT11N6Rg'; // ¡REEMPLAZA ESTO!

    // Variables para seguimiento de sets
    let lastSetsA = 0;
    let lastSetsB = 0;
    let currentSetNumber = 1;      
    
    // Inicializar Supabase
    const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);
	window.supabase = supabase;
    
    // Estado del partido
    let matchState = {
      id: null,
      club_id: null,
      court: "",
      scoring_type: "traditional",
      team_a_name: "EQUIPO A",
      team_b_name: "EQUIPO B",
      winner: null,
      games_a: 0,
      games_b: 0,
      points_a: 0,
      points_b: 0,
      tiebreak: false,
      duration: "00:00",
      status: "waiting",
      team_a_players: ["Jugador 1", "Jugador 2"],
      team_b_players: ["Jugador 1", "Jugador 2"],
      startTime: null,
      timerInterval: null
    };

    // === INICIALIZACIÓN ===
    document.addEventListener('DOMContentLoaded', async () => {
      try {
        // Obtener parámetros de la URL
        const urlParams = new URLSearchParams(window.location.search);
        const clubId = urlParams.get('club');
        const courtId = urlParams.get('court') || "2";
        
        // 🔐 VALIDACIÓN CRÍTICA: Verificar que tenemos clubId
        if (!clubId) {
          showErrorScreen("URL inválida: falta el identificador del club. Contacte al administrador.");
          return;
        }
        
        // Validar formato UUID del club
        const uuidRegex = /^[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i;
        if (!uuidRegex.test(clubId)) {
          showErrorScreen("URL inválida: identificador de club incorrecto. Contacte al administrador.");
          return;
        }
        
        // Configurar variables globales con validación
        window.clubId = clubId;
        matchState.club_id = clubId;
        matchState.court = `Cancha ${courtId}`;
        
        // Actualizar interfaz
        const tvCourtNumber = document.getElementById('court-number');
        if (tvCourtNumber) {
          tvCourtNumber.textContent = courtId;
        }
        
        console.log("TV inicializada para:", clubId, matchState.court);
        
        // Inicializar con estado en espera
        resetDisplay();
        
        // Configurar suscripción a cambios en la base de datos
        setupRealtimeSubscription();
        
        // Cargar partido activo si existe
        await loadActiveMatch();
        
        // Generar QR
        setTimeout(generateQRCode, 100);
        
      } catch (error) {
        console.error("Error crítico al inicializar:", error);
        showErrorScreen("Error al inicializar la aplicación.");
      }
    });

    // Función para reiniciar puntos después de mostrar GAME
    function resetPointsAfterGame() {
      if (matchState.scoring_type === 'traditional') {
        const scoreA = getTraditionalDisplayScore(matchState.points_a, matchState.points_b, matchState.tiebreak, true);
        const scoreB = getTraditionalDisplayScore(matchState.points_b, matchState.points_a, matchState.tiebreak, false);
        
        if (scoreA === 'GAME' || scoreB === 'GAME') {
          // Esperar un momento para mostrar GAME y luego reiniciar
          setTimeout(() => {
            matchState.points_a = 0;
            matchState.points_b = 0;
            updateMatchDisplay(matchState);
          }, 2000);
        }
      }
    }

    // Función para verificar el estado de la suscripción
    window.checkSubscriptionStatus = function() {
      console.log("Estado actual:");
      console.log("- Club ID:", matchState.club_id);
      console.log("- Cancha:", matchState.court);
      console.log("- Partido ID:", matchState.id);
      console.log("- Estado:", matchState.status);
      
      // Verificar conexión con Supabase
      supabase
        .from('matches')
        .select('count', { count: 'exact' })
        .eq('club_id', matchState.club_id)
        .then(({ count, error }) => {
          if (error) {
            console.error("Error de conexión a Supabase:", error);
          } else {
            console.log(`Total de partidos del club: ${count}`);
          }
        });
    };
    
    // Función para forzar una actualización
    window.forceRefresh = function() {
      console.log("Forzando actualización...");
      loadActiveMatch();
    };

    // Función para convertir puntos al formato tradicional con visualización de GAME
    function getTraditionalDisplayScore(points, otherPoints, isTiebreak, isServing = false) {
      if (isTiebreak) {
        return points; // En tiebreak mostrar puntos numéricos
      }
      
      const traditionalPoints = ['0', '15', '30', '40', 'GAME'];
      
      // Si el punto es 4 o más, mostramos "GAME"
      if (points >= 4) {
        return 'GAME';
      }
      
      return traditionalPoints[points] || '40';
    }
    
    // Agregar botones de depuración a la interfaz (opcional)
    function addDebugButtons() {
      const debugDiv = document.createElement('div');
      debugDiv.style.position = 'fixed';
      debugDiv.style.bottom = '10px';
      debugDiv.style.right = '10px';
      debugDiv.style.zIndex = '1000';
      
      debugDiv.innerHTML = `
        <button onclick="checkSubscriptionStatus()" style="padding: 5px 10px; margin: 2px; background: #3498db; color: white; border: none; border-radius: 3px; cursor: pointer;">Estado</button>
        <button onclick="forceRefresh()" style="padding: 5px 10px; margin: 2px; background: #2ecc71; color: white; border: none; border-radius: 3px; cursor: pointer;">Actualizar</button>
      `;
      
      document.body.appendChild(debugDiv);
    }
    
    // Llamar a addDebugButtons después de que se cargue la página
    setTimeout(addDebugButtons, 3000);

    async function handleMatchUpdate(payload) {
      try {
        console.log("Actualización recibida:", payload.eventType, payload.new);
        
        // Si es un nuevo partido o una actualización
        if (payload.eventType === 'INSERT' || payload.eventType === 'UPDATE') {
          const match = payload.new;
          
          // 🔐 VERIFICACIÓN DE SEGURIDAD: Asegurar que el partido pertenece al club
          if (match.club_id !== matchState.club_id) {
            console.warn("Intento de mostrar partido de otro club detectado.");
            return;
          }
          
          // Si el partido está activo
          if (match.status === 'active') {
            console.log("Partido activo detectado, actualizando pantalla...");
            await updateMatchDisplay(match);
          } 
          // Si el partido está pendiente
          else if (match.status === 'pending') {
            console.log("Partido pendiente detectado");
            updateMatchStatus('pending');
          }
          // Si el partido ha finalizado
          else if (match.status === 'completed') {
            console.log("Partido completado detectado, reiniciando pantalla...");
            resetDisplay();
          }
        } else if (payload.eventType === 'DELETE') {
          // Si se eliminó el partido
          console.log("Partido eliminado detectado, reiniciando pantalla...");
          resetDisplay();
        }
      } catch (error) {
        console.error("Error en handleMatchUpdate:", error);
      }
    }
    
    // Configurar suscripción en tiempo real - VERSIÓN CORREGIDA
    function setupRealtimeSubscription() {
      try {
        console.log("Configurando suscripción para club:", matchState.club_id);
        
        // 🔄 SUSCRIPCIÓN MEJORADA: Filtrar por club Y cancha
        const subscription = supabase
          .channel('matches-channel')
          .on('postgres_changes', 
            { 
              event: '*', 
              schema: 'public', 
              table: 'matches',
              filter: `club_id=eq.${matchState.club_id}`
            }, 
            (payload) => {
              console.log("Evento recibido:", payload.eventType, payload.new);
              
              // 🔄 FILTRADO ADICIONAL: Verificar que el partido es de esta cancha
              if (payload.new && payload.new.court === matchState.court) {
                console.log("Partido coincide con esta cancha, procesando...");
                handleMatchUpdate(payload);
              } else if (payload.new) {
                console.log("Partido ignorado (diferente cancha):", payload.new.court);
              }
            })
          .subscribe((status) => {
            console.log("Estado de suscripción:", status);
          });
          
        console.log("Suscripción a cambios en tiempo real configurada correctamente");
      } catch (error) {
        console.error("Error al configurar suscripción:", error);
        // Reintentar después de 5 segundos
        setTimeout(setupRealtimeSubscription, 5000);
      }
    }
    
    // Cargar partido activo - VERSIÓN MEJORADA
    async function loadActiveMatch() {
      try {
        console.log("Buscando partido activo para:", matchState.club_id, matchState.court);
        
        const { data: match, error } = await supabase
          .from('matches')
          .select('*')
          .eq('club_id', matchState.club_id)
          .eq('court', matchState.court)
          .eq('status', 'active')
          .order('created_at', { ascending: false })
          .limit(1)
          .single();
          
        if (error && error.code !== 'PGRST116') {
          console.error("Error al cargar partido activo:", error);
          return;
        }
        
        if (match) {
          console.log("Partido activo encontrado:", match.id);
          // 🔐 VERIFICACIÓN ADICIONAL: Asegurar que el partido pertenece al club
          if (match.club_id !== matchState.club_id) {
            console.warn("Intento de cargar partido de otro club detectado.");
            return;
          }
          
          await updateMatchDisplay(match);
        } else {
          console.log("No hay partidos activos para esta cancha");
          // Verificar si hay un partido pendiente
          const { data: pendingMatch, error: pendingError } = await supabase
            .from('matches')
            .select('*')
            .eq('club_id', matchState.club_id)
            .eq('court', matchState.court)
            .eq('status', 'pending')
            .order('created_at', { ascending: false })
            .limit(1)
            .single();
            
          if (pendingMatch && !pendingError) {
            // 🔐 VERIFICACIÓN ADICIONAL: Asegurar que el partido pertenece al club
            if (pendingMatch.club_id !== matchState.club_id) {
              console.warn("Intento de cargar partido de otro club detectado.");
              return;
            }
            
            console.log("Partido pendiente encontrado:", pendingMatch.id);
            updateMatchStatus('pending');
          } else {
            console.log("No hay partidos pendientes para esta cancha");
          }
        }
      } catch (error) {
        console.error("Error al cargar partido activo:", error);
      }
    }    

    // Función para mostrar notificación de set ganado
    function showSetNotification(message) {
      // Eliminar notificación anterior si existe
      const existingNotification = document.getElementById('set-notification');
      if (existingNotification) {
        existingNotification.remove();
      }
      
      const notification = document.createElement('div');
      notification.id = 'set-notification';
      notification.style.cssText = `
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: rgba(0, 0, 0, 0.9);
        color: white;
        padding: 20px 30px;
        border-radius: 10px;
        font-size: 1.8rem;
        font-weight: bold;
        z-index: 1000;
        animation: fadeInOut 3s forwards;
      `;
      
      notification.innerHTML = `🎉 ${message} 🎉`;
      
      // Agregar estilos de animación
      const style = document.createElement('style');
      style.textContent = `
        @keyframes fadeInOut {
          0% { opacity: 0; transform: translate(-50%, -50%) scale(0.8); }
          20% { opacity: 1; transform: translate(-50%, -50%) scale(1.1); }
          30% { transform: translate(-50%, -50%) scale(1); }
          80% { opacity: 1; }
          100% { opacity: 0; }
        }
      `;
      document.head.appendChild(style);
      
      document.body.appendChild(notification);
      
      // Eliminar después de 3 segundos
      setTimeout(() => {
        if (document.body.contains(notification)) {
          document.body.removeChild(notification);
        }
      }, 3000);
    }

    // Función para mostrar notificación de partido completado
    function showMatchCompleteNotification(message) {
      const notification = document.createElement('div');
      notification.style.cssText = `
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: rgba(1, 107, 58, 0.95);
        color: white;
        padding: 25px 40px;
        border-radius: 15px;
        font-size: 2.2rem;
        font-weight: bold;
        z-index: 1000;
        text-align: center;
        box-shadow: 0 10px 30px rgba(0,0,0,0.5);
      `;
      
      notification.innerHTML = `
        <div style="margin-bottom: 15px;">🎾 ${message} 🎾</div>
        <div style="font-size: 1.4rem;">Preparándose para el próximo partido...</div>
      `;
      
      document.body.appendChild(notification);
      
      // Eliminar después de 5 segundos
      setTimeout(() => {
        if (document.body.contains(notification)) {
          document.body.removeChild(notification);
        }
      }, 5000);
    }

    // Actualizar la pantalla con datos del partido - VERSIÓN MEJORADA
    async function updateMatchDisplay(match) {
      try {
        // 🔐 VERIFICACIÓN DE SEGURIDAD: Asegurar que el partido pertenece al club
        if (match.club_id !== matchState.club_id) {
          console.warn("Intento de mostrar partido de otro club detectado.");
          return;
        }
        
        // Actualizar estado interno
        matchState = {
          ...matchState,
          id: match.id,
          club_id: match.club_id,
          court: match.court,
          scoring_type: match.scoring_type,
          team_a_name: match.team_a_name || "EQUIPO A",
          team_b_name: match.team_b_name || "EQUIPO B",
          winner: match.winner,
          games_a: match.games_a || 0,
          games_b: match.games_b || 0,
          points_a: match.points_a || 0,
          points_b: match.points_b || 0,
          tiebreak: match.tiebreak || false,
          duration: match.duration || "00:00",
          status: match.status,
          team_a_players: match.team_a_players || ["Jugador 1", "Jugador 2"],
          team_b_players: match.team_b_players || ["Jugador 1", "Jugador 2"]
        };
        		
		
        // Actualizar nombres de equipos
        document.getElementById('team-a-name').textContent = matchState.team_a_name;
        document.getElementById('team-b-name').textContent = matchState.team_b_name;
        document.getElementById('team-a-display').textContent = matchState.team_a_name;
        document.getElementById('team-b-display').textContent = matchState.team_b_name;
        
        // Actualizar jugadores
        updatePlayersDisplay('team-a', matchState.team_a_players);
        updatePlayersDisplay('team-b', matchState.team_b_players);
        
        // Actualizar puntuación según el sistema de puntuación
        if (matchState.scoring_type === 'traditional') {
          // Usar formato tradicional con visualización de GAME
          const scoreA = getTraditionalDisplayScore(matchState.points_a, matchState.points_b, matchState.tiebreak, true);
          const scoreB = getTraditionalDisplayScore(matchState.points_b, matchState.points_a, matchState.tiebreak, false);
          
          document.getElementById('team-a-score').textContent = scoreA;
          document.getElementById('team-b-score').textContent = scoreB;
          
          // Aplicar estilos especiales para GAME
          if (scoreA === 'GAME') {
            document.getElementById('team-a-score').style.fontSize = '3.5rem';
            document.getElementById('team-a-score').style.color = '#4CAF50';
          } else {
            document.getElementById('team-a-score').style.fontSize = '5rem';
            document.getElementById('team-a-score').style.color = '#D32F2F';
          }
          
          if (scoreB === 'GAME') {
            document.getElementById('team-b-score').style.fontSize = '3.5rem';
            document.getElementById('team-b-score').style.color = '#4CAF50';
          } else {
            document.getElementById('team-b-score').style.fontSize = '5rem';
            document.getElementById('team-b-score').style.color = '#1976D2';
          }
        } else {
          // Mostrar puntos numéricos para modo americano
          document.getElementById('team-a-score').textContent = matchState.points_a;
          document.getElementById('team-b-score').textContent = matchState.points_b;
          document.getElementById('team-a-score').style.fontSize = '5rem';
          document.getElementById('team-b-score').style.fontSize = '5rem';
          document.getElementById('team-a-score').style.color = '#D32F2F';
          document.getElementById('team-b-score').style.color = '#1976D2';
        }
        
        document.getElementById('total-points').textContent = matchState.points_a + matchState.points_b;
        document.getElementById('games-score').textContent = `${matchState.games_a}-${matchState.games_b}`;
       
        // Actualizar sistema de puntuación
        document.getElementById('scoring-system').textContent = 
          matchState.scoring_type === 'american' ? 'Sistema Americano' : 'Sistema Tradicional';
        
        // Actualizar tiebreak
        if (matchState.tiebreak) {
          document.getElementById('tiebreak-container').style.display = 'block';
        } else {
          document.getElementById('tiebreak-container').style.display = 'none';
        }

        // Actualizar sets
        const setsA = match.sets_a || 0;
        const setsB = match.sets_b || 0;
        
        // Crear o actualizar elementos de visualización de sets
        let setsContainer = document.getElementById('sets-container');
        if (!setsContainer) {
          setsContainer = document.createElement('div');
          setsContainer.id = 'sets-container';
          setsContainer.style.cssText = 'display: flex; justify-content: center; gap: 20px; margin: 15px 0; font-size: 1.5rem; font-weight: bold;';
          document.querySelector('.scoreboard').parentNode.insertBefore(setsContainer, document.querySelector('.scoreboard'));
        }
        
        setsContainer.innerHTML = `
          <div style="color: #D32F2F;">Sets: ${setsA}</div>
          <div style="color: #1976D2;">Sets: ${setsB}</div>
        `;
        
        // Detectar si se ganó un set y mostrar notificación
        if (typeof lastSetsA === 'undefined') lastSetsA = setsA;
        if (typeof lastSetsB === 'undefined') lastSetsB = setsB;
        
        if (setsA > lastSetsA || setsB > lastSetsB) {
          const setNumber = setsA + setsB;
          const winningTeam = setsA > lastSetsA ? matchState.team_a_name : matchState.team_b_name;
          
          showSetNotification(`${winningTeam} ganó el set ${setNumber}`);
          
          // Actualizar últimos valores
          lastSetsA = setsA;
          lastSetsB = setsB;
        }
        
        // Actualizar marcador de juegos dentro del set
        const gamesElement = document.getElementById('games-score');
        if (gamesElement) {
          gamesElement.textContent = `${matchState.games_a}-${matchState.games_b}`;
          gamesElement.style.fontSize = '1.8rem';
          gamesElement.style.fontWeight = 'bold';
          gamesElement.style.margin = '10px 0';
        }
        
        // Actualizar información del set actual
        const setInfoElement = document.getElementById('set-info');
        if (!setInfoElement) {
          const newSetInfoElement = document.createElement('div');
          newSetInfoElement.id = 'set-info';
          newSetInfoElement.style.cssText = 'text-align: center; margin: 10px 0; font-size: 1.2rem;';
          document.querySelector('.scoring-system').parentNode.insertBefore(newSetInfoElement, document.querySelector('.scoring-system'));
        }
        
        const setInfo = document.getElementById('set-info');
        if (setInfo) {
          const currentSet = (matchState.sets_a || 0) + (matchState.sets_b || 0) + 1;
          setInfo.textContent = `Set ${currentSet}`;
        }		
		
        // Iniciar temporizador si es un partido activo
        if (matchState.status === 'active' && !matchState.timerInterval) {
          matchState.startTime = new Date(match.created_at);
          startTimer();
        }


        if (matchState.status === 'completed') {
          // Determinar ganador
          const winner = matchState.winner === 'teamA' ? matchState.team_a_name : matchState.team_b_name;
          
          // Mostrar notificación de partido terminado
          showMatchCompleteNotification(`¡Partido terminado! Ganador: ${winner}`);
          
          // Restablecer para nuevo partido después de un tiempo
          setTimeout(() => {
            resetDisplay();
          }, 5000);
        }
        
        // Actualizar estado
        updateMatchStatus(matchState.status);
        
      } catch (error) {
        console.error("Error en updateMatchDisplay:", error);
      }
    }    

    // Actualizar visualización de jugadores
    function updatePlayersDisplay(teamId, players) {
      const playersContainer = document.getElementById(`${teamId}-players`);
      playersContainer.innerHTML = '';
      
      if (!players || players.length === 0) {
        playersContainer.innerHTML = `
          <div class="player">Jugador 1</div>
          <div class="player">Jugador 2</div>
        `;
        return;
      }
      
      players.forEach(player => {
        const playerEl = document.createElement('div');
        playerEl.className = 'player';
        playerEl.textContent = player;
        playersContainer.appendChild(playerEl);
      });
    }
    
    // Actualizar estado del partido
    function updateMatchStatus(status) {
      const statusElement = document.getElementById('match-status');
      statusElement.className = 'match-status';
      
      switch(status) {
        case 'pending':
          statusElement.classList.add('status-pending');
          statusElement.textContent = 'Partido Pendiente';
          break;
        case 'active':
          statusElement.classList.add('status-active');
          statusElement.textContent = 'En Curso';
          break;
        case 'completed':
          statusElement.classList.add('status-completed');
          statusElement.textContent = 'Partido Finalizado';
          break;
        default:
          statusElement.classList.add('status-waiting');
          statusElement.textContent = 'En Espera';
      }
      
      matchState.status = status;
    }
    
    // Reiniciar visualización
    function resetDisplay() {
      if (matchState.timerInterval) {
        clearInterval(matchState.timerInterval);
        matchState.timerInterval = null;
      }
      
      // Restablecer estado
      matchState = {
        ...matchState,
        id: null,
        team_a_name: "EQUIPO A",
        team_b_name: "EQUIPO B",
        winner: null,
        games_a: 0,
        games_b: 0,
        points_a: 0,
        points_b: 0,
        tiebreak: false,
        duration: "00:00",
        status: "waiting",
        team_a_players: ["Jugador 1", "Jugador 2"],
        team_b_players: ["Jugador 1", "Jugador 2"],
        startTime: null
      };
      
      // Actualizar UI
      document.getElementById('team-a-score').textContent = '0';
      document.getElementById('team-b-score').textContent = '0';
      document.getElementById('total-points').textContent = '0';
      document.getElementById('games-score').textContent = '0-0';
      document.getElementById('match-duration').textContent = '00:00';
      document.getElementById('tiebreak-container').style.display = 'none';
      
      document.getElementById('team-a-name').textContent = 'EQUIPO A';
      document.getElementById('team-b-name').textContent = 'EQUIPO B';
      document.getElementById('team-a-display').textContent = 'EQUIPO A';
      document.getElementById('team-b-display').textContent = 'EQUIPO B';
      
      updatePlayersDisplay('team-a', matchState.team_a_players);
      updatePlayersDisplay('team-b', matchState.team_b_players);
      
      updateMatchStatus('waiting');
    }
    
    // Iniciar temporizador
    function startTimer() {
      if (matchState.timerInterval) {
        clearInterval(matchState.timerInterval);
      }
      
      matchState.timerInterval = setInterval(() => {
        const now = new Date();
        const diff = now - matchState.startTime;
        const minutes = Math.floor(diff / 60000);
        const seconds = Math.floor((diff % 60000) / 1000);
        
        matchState.duration = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        document.getElementById('match-duration').textContent = matchState.duration;
        
        // Actualizar duración en la base de datos cada minuto
        if (seconds === 0 && matchState.id) {
          updateMatchDuration();
        }
      }, 1000);
    }
    
    // Actualizar duración en la base de datos
    async function updateMatchDuration() {
      try {
        const { error } = await supabase
          .from('matches')
          .update({ 
            duration: matchState.duration,
            updated_at: new Date().toISOString()
          })
          .eq('id', matchState.id);
          
        if (error) {
          console.error("Error al actualizar duración:", error);
        }
      } catch (error) {
        console.error("Error al actualizar duración:", error);
      }
    }
    
    // Añadir punto (simulación) - VERSIÓN MEJORADA
    async function addPoint(team) {
      if (!matchState.id || matchState.status !== 'active') {
        alert("No hay un partido activo para añadir puntos");
        return;
      }
      
      // 🔐 VERIFICACIÓN DE SEGURIDAD: Asegurar que estamos modificando un partido de nuestro club
      if (matchState.club_id !== window.clubId) {
        alert("No tiene permisos para modificar este partido.");
        return;
      }
      
      try {
        // Determinar qué campo actualizar según el equipo
        const field = team === 'A' ? 'points_a' : 'points_b';
        const newValue = team === 'A' ? matchState.points_a + 1 : matchState.points_b + 1;
        
        // Actualizar en la base de datos
        const { error } = await supabase
          .from('matches')
          .update({ 
            [field]: newValue,
            updated_at: new Date().toISOString()
          })
          .eq('id', matchState.id)
          .eq('club_id', window.clubId);
          
        if (error) {
          console.error("Error al actualizar punto:", error);
          
          // Manejo específico de error 401 (No autorizado)
          if (error.code === '401' || error.status === 401) {
            alert("Error de permisos. Contacte al administrador para configurar las políticas de seguridad.");
          } else {
            alert("Error al registrar el punto. Intenta nuevamente.");
          }
        } else {
          console.log(`Punto registrado para equipo ${team}`);
          
          // Actualizar estado local
          if (team === 'A') {
            matchState.points_a = newValue;
          } else {
            matchState.points_b = newValue;
          }
          
          // Actualizar UI - manejar formato tradicional
          if (matchState.scoring_type === 'traditional') {
            const scoreA = getTraditionalDisplayScore(matchState.points_a, matchState.points_b, matchState.tiebreak, true);
            const scoreB = getTraditionalDisplayScore(matchState.points_b, matchState.points_a, matchState.tiebreak, false);
            
            document.getElementById('team-a-score').textContent = scoreA;
            document.getElementById('team-b-score').textContent = scoreB;
            
            // Aplicar estilos especiales para GAME
            if (scoreA === 'GAME') {
              document.getElementById('team-a-score').classList.add('game-score');
              // Reiniciar después de un tiempo
              setTimeout(() => {
                matchState.points_a = 0;
                matchState.points_b = 0;
                document.getElementById('team-a-score').textContent = '0';
                document.getElementById('team-b-score').textContent = '0';
                document.getElementById('team-a-score').classList.remove('game-score');
              }, 1500);
            } else if (scoreB === 'GAME') {
              document.getElementById('team-b-score').classList.add('game-score');
              // Reiniciar después de un tiempo
              setTimeout(() => {
                matchState.points_a = 0;
                matchState.points_b = 0;
                document.getElementById('team-a-score').textContent = '0';
                document.getElementById('team-b-score').textContent = '0';
                document.getElementById('team-b-score').classList.remove('game-score');
              }, 1500);
            }
          } else {
            document.getElementById('team-a-score').textContent = matchState.points_a;
            document.getElementById('team-b-score').textContent = matchState.points_b;
          }
          
          document.getElementById('total-points').textContent = matchState.points_a + matchState.points_b;
        }
      } catch (error) {
        console.error("Error al añadir punto:", error);
      }
    }    
    
    // Añadir juego (simulación)
    async function addGame(team) {
      if (!matchState.id || matchState.status !== 'active') {
        alert("No hay un partido activo para añadir juegos");
        return;
      }
      
      // 🔐 VERIFICACIÓN DE SEGURIDAD: Asegurar que estamos modificando un partido de nuestro club
      if (matchState.club_id !== window.clubId) {
        alert("No tiene permisos para modificar este partido.");
        return;
      }
      
      try {
        // Determinar qué campo actualizar según el equipo
        const field = team === 'A' ? 'games_a' : 'games_b';
        const newValue = team === 'A' ? matchState.games_a + 1 : matchState.games_b + 1;
        
        // Actualizar en la base de datos
        const { error } = await supabase
          .from('matches')
          .update({ 
            [field]: newValue,
            updated_at: new Date().toISOString()
          })
          .eq('id', matchState.id)
          .eq('club_id', window.clubId); // 🔐 Filtro adicional de seguridad
        
        if (error) {
          console.error("Error al actualizar juego:", error);
          alert("Error al registrar el juego. Intenta nuevamente.");
        } else {
          console.log(`Juego registrado para equipo ${team}`);
          
          // Actualizar estado local
          if (team === 'A') {
            matchState.games_a = newValue;
          } else {
            matchState.games_b = newValue;
          }
          
          // Actualizar UI
          document.getElementById('games-score').textContent = `${matchState.games_a}-${matchState.games_b}`;
        }
      } catch (error) {
        console.error("Error al añadir juego:", error);
      }
    }    
    
    // Alternar tiebreak
    async function toggleTiebreak() {
      if (!matchState.id || matchState.status !== 'active') {
        alert("No hay un partido activo para modificar el tiebreak");
        return;
      }
      
      // 🔐 VERIFICACIÓN DE SEGURIDAD: Asegurar que estamos modificando un partido de nuestro club
      if (matchState.club_id !== window.clubId) {
        alert("No tiene permisos para modificar este partido.");
        return;
      }
      
      try {
        const newTiebreakValue = !matchState.tiebreak;
        
        // Actualizar en la base de datos
        const { error } = await supabase
          .from('matches')
          .update({ 
            tiebreak: newTiebreakValue,
            updated_at: new Date().toISOString()
          })
          .eq('id', matchState.id)
          .eq('club_id', window.clubId); // 🔐 Filtro adicional de seguridad
          
        if (error) {
          console.error("Error al actualizar tiebreak:", error);
          alert("Error al modificar el tiebreak. Intenta nuevamente.");
        } else {
          console.log(`Tiebreak ${newTiebreakValue ? 'activado' : 'desactivado'}`);
          
          // Actualizar estado local
          matchState.tiebreak = newTiebreakValue;
          
          // Actualizar UI
          if (matchState.tiebreak) {
            document.getElementById('tiebreak-container').style.display = 'block';
          } else {
            document.getElementById('tiebreak-container').style.display = 'none';
          }
        }
      } catch (error) {
        console.error("Error al alternar tiebreak:", error);
      }
    }   

    // Finalizar partido - CON MEJOR MANEJO DE ERRORES
    async function endMatch() {
      if (!matchState.id || matchState.status !== 'active') {
        alert("No hay un partido activo para finalizar");
        return;
      }
      
      // 🔐 VERIFICACIÓN DE SEGURIDAD: Asegurar que estamos modificando un partido de nuestro club
      if (matchState.club_id !== window.clubId) {
        alert("No tiene permisos para modificar este partido.");
        return;
      }
      
      try {
        // Determinar ganador
        let winner = null;
        if (matchState.scoring_type === 'traditional') {
          // Lógica para determinar ganador en sistema tradicional
          winner = matchState.games_a > matchState.games_b ? 'team_a' : 'team_b';
        } else {
          // Lógica para determinar ganador en sistema americano
          winner = matchState.points_a > matchState.points_b ? 'team_a' : 'team_b';
        }
        
        // Actualizar en la base de datos
        const { error } = await supabase
          .from('matches')
          .update({ 
            status: 'completed',
            winner: winner,
            updated_at: new Date().toISOString()
          })
          .eq('id', matchState.id)
          .eq('club_id', window.clubId);
          
        if (error) {
          console.error("Error al finalizar partido:", error);
          
          // Mostrar mensaje de error específico
          let errorMessage = "Error al finalizar el partido. Intenta nuevamente.";
          
          if (error.code === '401' || error.status === 401) {
            errorMessage = "Error de permisos. Contacte al administrador.";
          } else if (error.message) {
            errorMessage = `Error: ${error.message}`;
          }
          
          alert(errorMessage);
        } else {
          console.log("Partido finalizado");
          resetDisplay();
        }
      } catch (error) {
        console.error("Error al finalizar partido:", error);
        alert("Error inesperado al finalizar el partido.");
      }
    }    
    
    // Función para generar QR
    function generateQRCode() {
      // 🔐 GENERACIÓN SEGURA: Usar solo el club_id de la URL actual
      if (!window.clubId) {
        console.error("No se puede generar QR: falta clubId");
        return;
      }
      
      const courtNumber = matchState.court.replace('Cancha ', '');
      const registrationUrl = `${window.location.origin}/index.html?mode=qr&club=${window.clubId}&court=${courtNumber}`;
      
      const qrElement = document.getElementById('qrcode');
      if (!qrElement) return;
    
      // Limpiar contenido previo
      qrElement.innerHTML = '';      
    
      // Crear un elemento canvas para el QR
      const canvas = document.createElement('canvas');
      qrElement.appendChild(canvas);
    
      // Generar QR
      try {
        QRCode.toCanvas(canvas, registrationUrl, {
          width: 200,
          margin: 1,
          color: {
            dark: '#2c3e50',
            light: '#ffffff'
          }
        }, function(error) {
          if (error) {
            console.error("Error al generar QR:", error);
            qrElement.innerHTML = '<div style="color: white; padding: 20px; text-align: center;">Error al generar QR</div>';
          }
        });
      } catch (error) {
        console.error("Error en QRCode.toCanvas:", error);
        qrElement.innerHTML = '<div style="color: white; padding: 20px; text-align: center;">Error al generar QR</div>';
      }
    }       
    
    // Función para mostrar errores
    function showErrorScreen(message) {
      document.body.innerHTML = `
        <div style="display: flex; justify-content: center; align-items: center; height: 100vh; flex-direction: column; text-align: center; padding: 20px; background: #2c3e50; color: white;">
          <h1 style="color: #e74c3c; margin-bottom: 20px; font-size: 2rem;">Error de Configuración</h1>
          <p style="margin-bottom: 30px; font-size: 1.2rem; max-width: 500px;">${message}</p>
          <button onclick="location.reload()" style="padding: 12px 24px; background: #3498db; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 1rem;">Reintentar</button>
          <p style="margin-top: 30px; color: #7f8c8d; font-size: 0.9rem;">Si el problema persiste, contacte al administrador del sistema.</p>
        </div>
      `;
    }
  </script>
</body>
</html>
