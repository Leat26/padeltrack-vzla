<!DOCTYPE html>
<html lang="es">
<head>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PadelTrack - Pantalla TV</title>
  <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    :root {
      --primary: #2c3e50;
      --secondary: #e74c3c;
      --accent: #3498db;
      --light: #ecf0f1;
      --dark: #2c3e50;
      --success: #2ecc71;
      --waiting: #e67e22;
      --pending: #f39c12;
    }
    
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Montserrat', sans-serif;
    }
    
    body {
      background: linear-gradient(135deg, #2c3e50 0%, #1a2530 100%);
      color: white;
      min-height: 100vh;
      overflow: hidden;
    }
    
    .container {
      max-width: 100%;
      height: 100vh;
      padding: 20px;
      display: flex;
      flex-direction: column;
    }
    
    .court-header {
      text-align: center;
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 2px solid rgba(255, 255, 255, 0.1);
    }
    
    .court-header h1 {
      font-size: 2.5rem;
      margin-bottom: 10px;
    }
    
    .match-status {
      padding: 8px 16px;
      border-radius: 20px;
      font-weight: bold;
      font-size: 1.1rem;
      display: inline-block;
    }
    
    .status-pending {
      background-color: var(--pending);
    }
    
    .status-active {
      background-color: var(--success);
    }
    
    .status-completed {
      background-color: var(--secondary);
    }
    
    .status-waiting {
      background-color: var(--waiting);
    }
    
    .main-content {
      display: flex;
      flex: 1;
      gap: 30px;
    }
    
    .match-info {
      flex: 2;
      display: flex;
      flex-direction: column;
    }
    
    .scoreboard {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin: 20px 0;
      background-color: rgba(255, 255, 255, 0.1);
      padding: 30px;
      border-radius: 15px;
      flex: 1;
    }
    
    .team {
      text-align: center;
      flex: 1;
    }
    
    .team h2 {
      font-size: 1.8rem;
      margin-bottom: 15px;
      color: var(--light);
    }
    
    .team-a .score {
      color: #3498db;
      font-size: 5rem;
      font-weight: bold;
    }
    
    .team-b .score {
      color: #e74c3c;
      font-size: 5rem;
      font-weight: bold;
    }
    
    .players {
      font-size: 1.4rem;
      margin: 15px 0;
      min-height: 1.4em;
    }
    
    .player {
      margin: 5px 0;
    }
    
    .vs {
      font-size: 3rem;
      font-weight: bold;
      margin: 0 30px;
      opacity: 0.7;
    }
    
    .game-info {
      display: flex;
      justify-content: space-around;
      margin: 20px 0;
    }
    
    .info-box {
      background-color: rgba(255, 255, 255, 0.1);
      padding: 15px 25px;
      border-radius: 10px;
      text-align: center;
      flex: 1;
      margin: 0 10px;
    }
    
    .info-box span:first-child {
      display: block;
      font-size: 1.1rem;
      opacity: 0.8;
      margin-bottom: 8px;
    }
    
    .info-box span:last-child {
      font-size: 1.8rem;
      font-weight: bold;
    }
    
    .scoring-system {
      text-align: center;
      margin: 15px 0;
      font-size: 1.2rem;
      opacity: 0.9;
    }
    
    .tiebreak-indicator {
      background-color: #e67e22;
      color: white;
      padding: 8px 16px;
      border-radius: 20px;
      font-weight: bold;
      display: inline-block;
      margin: 10px 0;
    }
    
    .qr-section {
      flex: 1;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      background-color: rgba(255, 255, 255, 0.05);
      border-radius: 15px;
      padding: 25px;
    }
    
    #qrcode {
      margin: 20px auto;
      display: inline-block;
      background: white;
      padding: 15px;
      border-radius: 10px;
    }
    
    .qr-section h3 {
      font-size: 1.4rem;
      margin-bottom: 10px;
      text-align: center;
    }
    
    .qr-section p {
      font-size: 1.1rem;
      opacity: 0.8;
      text-align: center;
      margin-top: 15px;
    }
    
    .team-names {
      display: flex;
      justify-content: space-around;
      margin-top: 20px;
    }
    
    .team-name {
      font-size: 1.3rem;
      font-weight: bold;
      padding: 10px 20px;
      border-radius: 8px;
      background-color: rgba(255, 255, 255, 0.1);
    }
    
    .team-a-name {
      color: #3498db;
    }
    
    .team-b-name {
      color: #e74c3c;
    }
    
    .simulation-controls {
      margin-top: 20px;
      padding: 15px;
      background-color: rgba(255, 255, 255, 0.05);
      border-radius: 10px;
      text-align: center;
    }
    
    .simulation-controls h3 {
      margin-bottom: 10px;
      font-size: 1.2rem;
    }
    
    .simulation-buttons {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin-top: 10px;
      flex-wrap: wrap;
    }
    
    .sim-btn {
      padding: 8px 15px;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-weight: bold;
    }
    
    .sim-btn:hover {
      opacity: 0.9;
    }
    
    .sim-btn.team-a {
      background-color: #3498db;
    }
    
    .sim-btn.team-b {
      background-color: #e74c3c;
    }
    
    .sim-btn.secondary {
      background-color: #7f8c8d;
    }
    
    /* NUEVOS ESTILOS PARA JUEGOS Y SETS */
    .games-sets-container {
      display: flex;
      justify-content: center;
      gap: 40px;
      margin: 20px 0;
      background: rgba(255, 255, 255, 0.05);
      padding: 20px;
      border-radius: 10px;
    }
    
    .games-display, .sets-display {
      text-align: center;
    }
    
    .games-display h3, .sets-display h3 {
      font-size: 1.2rem;
      margin-bottom: 10px;
      opacity: 0.8;
    }
    
    .games-values, .sets-values {
      display: flex;
      justify-content: center;
      gap: 30px;
      font-size: 2.5rem;
      font-weight: bold;
    }
    
    .games-a, .sets-a {
      color: #3498db;
    }
    
    .games-b, .sets-b {
      color: #e74c3c;
    }
    
    /* Estilos para puntuaci√≥n tradicional */
    .traditional-score {
      font-size: 4rem;
      font-weight: bold;
    }
    
    .tiebreak-score {
      color: #FF9800;
    }

    /* Responsive adjustments for TV */
    @media (max-width: 1200px) {
      .team-a .score, .team-b .score {
        font-size: 4rem;
      }
      
      .players {
        font-size: 1.2rem;
      }
      
      .vs {
        font-size: 2.5rem;
      }
      
      .games-values, .sets-values {
        font-size: 2rem;
      }
    }
    
    @media (max-width: 900px) {
      .main-content {
        flex-direction: column;
      }
      
      .scoreboard {
        flex-direction: column;
        gap: 25px;
      }
      
      .vs {
        margin: 15px 0;
        transform: rotate(0deg);
      }
      
      .qr-section {
        margin-top: 20px;
      }
      
      .simulation-buttons {
        flex-direction: column;
      }
      
      .games-sets-container {
        flex-direction: column;
        gap: 20px;
      }
    }

    @media (max-height: 800px) {
      .container {
        padding: 15px;
      }
      
      .court-header {
        margin-bottom: 15px;
      }
      
      .court-header h1 {
        font-size: 2rem;
      }
      
      .scoreboard {
        margin: 15px 0;
        padding: 20px;
      }
      
      .team-a .score, .team-b .score {
        font-size: 3.5rem;
      }
      
      .players {
        font-size: 1.1rem;
      }
      
      .game-info {
        margin: 15px 0;
      }
      
      .info-box {
        padding: 10px 15px;
      }
      
      .info-box span:last-child {
        font-size: 1.5rem;
      }
      
      .games-values, .sets-values {
        font-size: 2rem;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="court-header">
      <h1>Cancha #<span id="court-number">2</span></h1>
      <div class="match-status status-waiting" id="match-status">En espera</div>
    </div>
    
    <div class="main-content">
      <div class="match-info">
        <div class="scoreboard">
          <div class="team team-a">
            <h2 id="team-a-name">EQUIPO A</h2>
            <div class="players" id="team-a-players">
              <div class="player">Jugador 1</div>
              <div class="player">Jugador 2</div>
            </div>
            <div class="score traditional-score" id="team-a-score">0</div>
          </div>
          
          <div class="vs">VS</div>
          
          <div class="team team-b">
            <h2 id="team-b-name">EQUIPO B</h2>
            <div class="players" id="team-b-players">
              <div class="player">Jugador 1</div>
              <div class="player">Jugador 2</div>
            </div>
            <div class="score traditional-score" id="team-b-score">0</div>
          </div>
        </div>
        
        <!-- NUEVA SECCI√ìN: JUEGOS Y SETS -->
        <div class="games-sets-container">
          <div class="games-display">
            <h3>JUEGOS</h3>
            <div class="games-values">
              <div class="games-a" id="team-a-games">0</div>
              <div class="games-b" id="team-b-games">0</div>
            </div>
          </div>
          
          <div class="sets-display">
            <h3>SETS</h3>
            <div class="sets-values">
              <div class="sets-a" id="team-a-sets">0</div>
              <div class="sets-b" id="team-b-sets">0</div>
            </div>
          </div>
        </div>
        
        <div class="game-info">
          <div class="info-box">
            <span>Duraci√≥n</span>
            <span id="match-duration">00:00</span>
          </div>
          <div class="info-box">
            <span>Puntos totales</span>
            <span id="total-points">0</span>
          </div>
          <div class="info-box">
            <span>Sistema</span>
            <span id="scoring-system">Tradicional</span>
          </div>
        </div>
        
        <div id="tiebreak-container" style="display: none;">
          <div class="tiebreak-indicator">
            ‚ö° TIEBREAK ACTIVO - Juega a 7 puntos
          </div>
        </div>

        <div class="simulation-controls">
          <h3>Controles de Simulaci√≥n (Modo Pruebas)</h3>
          <div class="simulation-buttons">
            <button class="sim-btn team-a" onclick="addPoint('A')">
              <i class="fas fa-plus"></i> Punto Equipo A
            </button>
            <button class="sim-btn team-b" onclick="addPoint('B')">
              <i class="fas fa-plus"></i> Punto Equipo B
            </button>
            <button class="sim-btn" style="background-color: #e74c3c;" onclick="endMatch()">
              <i class="fas fa-flag-checkered"></i> Finalizar Partido
            </button>
          </div>
          <p style="font-size: 12px; opacity: 0.7; margin-top: 10px;">
            Estos controles simulan la l√≥gica real de p√°del y actualizan la base de datos
          </p>
        </div>
      </div>
      
      <div class="qr-section">
        <h3>Escanee para registrar su partido</h3>
        <div id="qrcode"></div>
        <div class="team-names">
          <div class="team-name team-a-name" id="team-a-display">EQUIPO A</div>
          <div class="team-name team-b-name" id="team-b-display">EQUIPO B</div>
        </div>
        <p>Use su smartphone para escanear el c√≥digo</p>
      </div>
    </div>
  </div>

  <script>
    // Configuraci√≥n de Supabase (reemplaza con tus propias credenciales)
    const supabaseUrl = 'https://omizjfxbxkfkxlxdkbej.supabase.co'; // ¬°REEMPLAZA ESTO!
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9taXpqZnhieGtma3hseGRrYmVqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU0NzkyMjIsImV4cCI6MjA3MTA1NTIyMn0.UAj61BfHqIF8Gg9bHYsEF_ocTM8Og4oJN2bWT11N6Rg'; // ¬°REEMPLAZA ESTO!
      
    // Inicializar Supabase
    const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);
    window.supabase = supabase;
    
    // Estado del partido - ACTUALIZADO CON SETS
    let matchState = {
      id: null,
      club_id: null,
      court: "",
      scoring_type: "traditional",
      team_a_name: "EQUIPO A",
      team_b_name: "EQUIPO B",
      winner: null,
      games_a: 0,
      games_b: 0,
      sets_a: 0,
      sets_b: 0,
      points_a: 0,
      points_b: 0,
      tiebreak: false,
      tiebreak_points_a: 0,
      tiebreak_points_b: 0,
      duration: "00:00",
      status: "waiting",
      team_a_players: ["Jugador 1", "Jugador 2"],
      team_b_players: ["Jugador 1", "Jugador 2"],
      startTime: null,
      timerInterval: null
    };

    // ‚úÖ CORRECCI√ìN P√ÅDEL: Funci√≥n sin AD
    function getTraditionalDisplayScore(points, isTiebreak, tiebreakPoints = 0) {
      if (isTiebreak) {
        return tiebreakPoints.toString();
      }
      
      const traditionalPoints = ['0', '15', '30', '40'];
      
      // ‚úÖ CORRECCI√ìN: En p√°del no existe AD, siempre mostrar 40 para 3+ puntos
      if (points >= 3) {
        return '40';
      }
      
      return traditionalPoints[points] || '40';
    }

    // INICIALIZACI√ìN
    document.addEventListener('DOMContentLoaded', async () => {
      try {
        const urlParams = new URLSearchParams(window.location.search);
        const clubId = urlParams.get('club');
        const courtId = urlParams.get('court') || "2";
        
        if (!clubId) {
          showErrorScreen("URL inv√°lida: falta el identificador del club.");
          return;
        }
        
        window.clubId = clubId;
        matchState.club_id = clubId;
        matchState.court = `Cancha ${courtId}`;
        
        const tvCourtNumber = document.getElementById('court-number');
        if (tvCourtNumber) {
          tvCourtNumber.textContent = courtId;
        }
        
        resetDisplay();
        setupRealtimeSubscription();
        await loadActiveMatch();
        setTimeout(generateQRCode, 100);
        
      } catch (error) {
        console.error("Error cr√≠tico al inicializar:", error);
        showErrorScreen("Error al inicializar la aplicaci√≥n.");
      }
    });

    // ‚úÖ CORRECCI√ìN: Funci√≥n mejorada para mostrar partido
    async function updateMatchDisplay(match) {
      try {
        if (match.club_id !== matchState.club_id) {
          return;
        }
        
        // ‚úÖ ACTUALIZACI√ìN COMPLETA DEL ESTADO
        matchState = {
          ...matchState,
          id: match.id,
          club_id: match.club_id,
          court: match.court,
          scoring_type: match.scoring_type || "traditional",
          team_a_name: match.team_a_name || "EQUIPO A",
          team_b_name: match.team_b_name || "EQUIPO B",
          winner: match.winner,
          games_a: match.games_a || 0,
          games_b: match.games_b || 0,
          sets_a: match.sets_a || 0,  // ‚úÖ GARANTIZAR QUE SETS SE ACTUALIZAN
          sets_b: match.sets_b || 0,
          points_a: match.points_a || 0,
          points_b: match.points_b || 0,
          tiebreak: match.tiebreak || false,
          tiebreak_points_a: match.tiebreak_points_a || 0,
          tiebreak_points_b: match.tiebreak_points_b || 0,
          duration: match.duration || "00:00",
          status: match.status,
          team_a_players: match.team_a_players || ["Jugador 1", "Jugador 2"],
          team_b_players: match.team_b_players || ["Jugador 1", "Jugador 2"]
        };
        
        console.log("üîÑ Actualizando TV con datos:", {
          sets: `${matchState.sets_a}-${matchState.sets_b}`,
          games: `${matchState.games_a}-${matchState.games_b}`,
          points: `${matchState.points_a}-${matchState.points_b}`,
          tiebreak: matchState.tiebreak
        });
        
        // ‚úÖ ACTUALIZAR NOMBRES DE EQUIPOS
        document.getElementById('team-a-name').textContent = matchState.team_a_name;
        document.getElementById('team-b-name').textContent = matchState.team_b_name;
        document.getElementById('team-a-display').textContent = matchState.team_a_name;
        document.getElementById('team-b-display').textContent = matchState.team_b_name;
        
        // ‚úÖ ACTUALIZAR JUGADORES
        updatePlayersDisplay('team-a', matchState.team_a_players);
        updatePlayersDisplay('team-b', matchState.team_b_players);
        
        // ‚úÖ ACTUALIZAR PUNTUACI√ìN CORRECTAMENTE
        const scoreAElement = document.getElementById('team-a-score');
        const scoreBElement = document.getElementById('team-b-score');
        
        if (matchState.scoring_type === 'traditional') {
          scoreAElement.textContent = getTraditionalDisplayScore(
            matchState.points_a, 
            matchState.tiebreak,
            matchState.tiebreak_points_a
          );
          scoreBElement.textContent = getTraditionalDisplayScore(
            matchState.points_b, 
            matchState.tiebreak,
            matchState.tiebreak_points_b
          );
          
          scoreAElement.className = 'score traditional-score';
          scoreBElement.className = 'score traditional-score';
        } else {
          scoreAElement.textContent = matchState.tiebreak ? matchState.tiebreak_points_a : matchState.points_a;
          scoreBElement.textContent = matchState.tiebreak ? matchState.tiebreak_points_b : matchState.points_b;
          scoreAElement.className = 'score';
          scoreBElement.className = 'score';
        }
        
        // ‚úÖ ACTUALIZAR JUEGOS Y SETS (CORRECCI√ìN CR√çTICA)
        document.getElementById('team-a-games').textContent = matchState.games_a;
        document.getElementById('team-b-games').textContent = matchState.games_b;
        document.getElementById('team-a-sets').textContent = matchState.sets_a;
        document.getElementById('team-b-sets').textContent = matchState.sets_b;
        
        // ‚úÖ ACTUALIZAR PUNTOS TOTALES
        document.getElementById('total-points').textContent = matchState.tiebreak ? 
          (matchState.tiebreak_points_a + matchState.tiebreak_points_b) : 
          (matchState.points_a + matchState.points_b);
        
        document.getElementById('scoring-system').textContent = 
          matchState.scoring_type === 'american' ? 'Sistema Americano' : 'Sistema Tradicional';
        
        // ‚úÖ ACTUALIZAR TIEBREAK
        if (matchState.tiebreak) {
          document.getElementById('tiebreak-container').style.display = 'block';
        } else {
          document.getElementById('tiebreak-container').style.display = 'none';
        }
        
        // ‚úÖ INICIAR TEMPORIZADOR SI ES NECESARIO
        if (matchState.status === 'active' && !matchState.timerInterval && match.created_at) {
          matchState.startTime = new Date(match.created_at);
          startTimer();
        }
        
        updateMatchStatus(matchState.status);
        
      } catch (error) {
        console.error("‚ùå Error en updateMatchDisplay:", error);
      }
    }    

    // Configurar suscripci√≥n en tiempo real
    function setupRealtimeSubscription() {
      try {
        console.log("üîî Suscribiendo a cambios en tiempo real...");
        
        const subscription = supabase
          .channel('matches-channel')
          .on('postgres_changes', 
            { 
              event: '*', 
              schema: 'public', 
              table: 'matches',
              filter: `club_id=eq.${matchState.club_id}`
            }, 
            (payload) => {
              console.log("üì° Evento recibido:", payload.eventType, payload.new?.id);
              
              if (payload.new && payload.new.court === matchState.court) {
                console.log("‚úÖ Partido coincide con esta cancha, actualizando...");
                // ‚úÖ FORZAR ACTUALIZACI√ìN INMEDIATA
                setTimeout(() => {
                  handleMatchUpdate(payload);
                }, 100);
              }
            })
          .subscribe((status) => {
            console.log("üìä Estado de suscripci√≥n:", status);
            if (status === 'SUBSCRIBED') {
              console.log("üéâ Suscripci√≥n activa - Listo para recibir actualizaciones");
            }
          });
          
      } catch (error) {
        console.error("‚ùå Error al configurar suscripci√≥n:", error);
        setTimeout(setupRealtimeSubscription, 5000);
      }
    }

    // ‚úÖ AGREGA esta funci√≥n en tv.html (antes de handleMatchUpdate)
    function debugMatchData(match, eventType) {
      console.log("=== üéæ DEBUG MATCH DATA ===");
      console.log("Evento:", eventType);
      console.log("ID:", match.id);
      console.log("Status:", match.status);
      console.log("Sets:", match.sets_a, "-", match.sets_b);
      console.log("Games:", match.games_a, "-", match.games_b);
      console.log("Points:", match.points_a, "-", match.points_b);
      console.log("Tiebreak:", match.tiebreak);
      console.log("Tiebreak Points:", match.tiebreak_points_a, "-", match.tiebreak_points_b);
      console.log("Scoring Type:", match.scoring_type);
      console.log("Court:", match.court);
      console.log("============================");
    }
	
    // ‚úÖ AGREGAR en tv.html para mejor seguimiento
    function debugScoreUpdate(match) {
      console.log("=== üéæ ACTUALIZACI√ìN TV ===");
      console.log("Puntos:", match.points_a + "-" + match.points_b);
      console.log("Juegos:", match.games_a + "-" + match.games_b);
      console.log("Sets:", match.sets_a + "-" + match.sets_b);
      console.log("Tiebreak:", match.tiebreak);
      console.log("============================");
    }
    
    // MODIFICAR handleMatchUpdate para mejor depuraci√≥n
    async function handleMatchUpdate(payload) {
      try {
        console.log("üì° Evento recibido:", payload.eventType, payload.new?.id);
        
        if (payload.new && payload.new.court === matchState.court) {
          // ‚úÖ DEPURACI√ìN EXTENDIDA
          debugMatchData(payload.new, payload.eventType);
          
          console.log("‚úÖ Partido coincide con esta cancha, actualizando...");
          await updateMatchDisplay(payload.new);
          
          // ‚úÖ LOG DE CONFIRMACI√ìN
          console.log("‚úÖ Pantalla TV actualizada correctamente");
        }
      } catch (error) {
        console.error("‚ùå Error en handleMatchUpdate:", error);
      }
    }

    async function loadActiveMatch() {
      try {
        const { data: match, error } = await supabase
          .from('matches')
          .select('*')
          .eq('club_id', matchState.club_id)
          .eq('court', matchState.court)
          .eq('status', 'active')
          .order('created_at', { ascending: false })
          .limit(1)
          .single();
          
        if (error && error.code !== 'PGRST116') {
          console.error("Error al cargar partido activo:", error);
          return;
        }
        
        if (match) {
          if (match.club_id !== matchState.club_id) {
            return;
          }
          
          await updateMatchDisplay(match);
        } else {
          const { data: pendingMatch, error: pendingError } = await supabase
            .from('matches')
            .select('*')
            .eq('club_id', matchState.club_id)
            .eq('court', matchState.court)
            .eq('status', 'pending')
            .order('created_at', { ascending: false })
            .limit(1)
            .single();
            
          if (pendingMatch && !pendingError) {
            if (pendingMatch.club_id !== matchState.club_id) {
              return;
            }
            
            updateMatchStatus('pending');
          }
        }
      } catch (error) {
        console.error("Error al cargar partido activo:", error);
      }
    }

    function updatePlayersDisplay(teamId, players) {
      const playersContainer = document.getElementById(`${teamId}-players`);
      playersContainer.innerHTML = '';
      
      if (!players || players.length === 0) {
        playersContainer.innerHTML = `
          <div class="player">Jugador 1</div>
          <div class="player">Jugador 2</div>
        `;
        return;
      }
      
      players.forEach(player => {
        const playerEl = document.createElement('div');
        playerEl.className = 'player';
        playerEl.textContent = player;
        playersContainer.appendChild(playerEl);
      });
    }
    
    function updateMatchStatus(status) {
      const statusElement = document.getElementById('match-status');
      statusElement.className = 'match-status';
      
      switch(status) {
        case 'pending':
          statusElement.classList.add('status-pending');
          statusElement.textContent = 'Partido Pendiente';
          break;
        case 'active':
          statusElement.classList.add('status-active');
          statusElement.textContent = 'En Curso';
          break;
        case 'completed':
          statusElement.classList.add('status-completed');
          statusElement.textContent = 'Partido Finalizado';
          break;
        default:
          statusElement.classList.add('status-waiting');
          statusElement.textContent = 'En Espera';
      }
      
      matchState.status = status;
    }
    
    function resetDisplay() {
      if (matchState.timerInterval) {
        clearInterval(matchState.timerInterval);
        matchState.timerInterval = null;
      }
      
      matchState = {
        ...matchState,
        id: null,
        team_a_name: "EQUIPO A",
        team_b_name: "EQUIPO B",
        winner: null,
        games_a: 0,
        games_b: 0,
        sets_a: 0,
        sets_b: 0,
        points_a: 0,
        points_b: 0,
        tiebreak: false,
        tiebreak_points_a: 0,
        tiebreak_points_b: 0,
        duration: "00:00",
        status: "waiting",
        team_a_players: ["Jugador 1", "Jugador 2"],
        team_b_players: ["Jugador 1", "Jugador 2"],
        startTime: null
      };
      
      document.getElementById('team-a-score').textContent = '0';
      document.getElementById('team-b-score').textContent = '0';
      document.getElementById('team-a-games').textContent = '0';
      document.getElementById('team-b-games').textContent = '0';
      document.getElementById('team-a-sets').textContent = '0';
      document.getElementById('team-b-sets').textContent = '0';
      document.getElementById('total-points').textContent = '0';
      document.getElementById('match-duration').textContent = '00:00';
      document.getElementById('tiebreak-container').style.display = 'none';
      
      document.getElementById('team-a-name').textContent = 'EQUIPO A';
      document.getElementById('team-b-name').textContent = 'EQUIPO B';
      document.getElementById('team-a-display').textContent = 'EQUIPO A';
      document.getElementById('team-b-display').textContent = 'EQUIPO B';
      
      updatePlayersDisplay('team-a', matchState.team_a_players);
      updatePlayersDisplay('team-b', matchState.team_b_players);
      
      updateMatchStatus('waiting');
    }
    
    function startTimer() {
      if (matchState.timerInterval) {
        clearInterval(matchState.timerInterval);
      }
      
      matchState.timerInterval = setInterval(() => {
        const now = new Date();
        const diff = now - matchState.startTime;
        const minutes = Math.floor(diff / 60000);
        const seconds = Math.floor((diff % 60000) / 1000);
        
        matchState.duration = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        document.getElementById('match-duration').textContent = matchState.duration;
        
        if (seconds === 0 && matchState.id) {
          updateMatchDuration();
        }
      }, 1000);
    }
    
    async function updateMatchDuration() {
      try {
        const { error } = await supabase
          .from('matches')
          .update({ 
            duration: matchState.duration,
            updated_at: new Date().toISOString()
          })
          .eq('id', matchState.id);
          
        if (error) {
          console.error("Error al actualizar duraci√≥n:", error);
        }
      } catch (error) {
        console.error("Error al actualizar duraci√≥n:", error);
      }
    }

    async function addPoint(team) {
      if (!matchState.id || matchState.status !== 'active') {
        console.log("‚ùå No hay partido activo para a√±adir puntos");
        return;
      }
      
      try {
        // Obtener el estado actual del partido
        const { data: currentMatch, error } = await supabase
          .from('matches')
          .select('*')
          .eq('id', matchState.id)
          .single();
          
        if (error) {
          console.error("Error al obtener partido:", error);
          return;
        }
        
        // Calcular nuevos puntos seg√∫n la l√≥gica de p√°del
        let newPointsA = currentMatch.points_a || 0;
        let newPointsB = currentMatch.points_b || 0;
        let newGamesA = currentMatch.games_a || 0;
        let newGamesB = currentMatch.games_b || 0;
        let newSetsA = currentMatch.sets_a || 0;
        let newSetsB = currentMatch.sets_b || 0;
        let tiebreak = currentMatch.tiebreak || false;
        let tiebreakPointsA = currentMatch.tiebreak_points_a || 0;
        let tiebreakPointsB = currentMatch.tiebreak_points_b || 0;
        
        console.log(`üéØ Simulando punto para equipo ${team}`);
        console.log(`Estado actual: Puntos ${newPointsA}-${newPointsB}, Juegos ${newGamesA}-${newGamesB}`);
        
        // ‚úÖ L√ìGICA ID√âNTICA A index.html - P√ÅDEL SIN AD
        if (tiebreak) {
          // L√≥gica de tiebreak
          if (team === 'A') tiebreakPointsA++;
          else tiebreakPointsB++;
          
          const diff = Math.abs(tiebreakPointsA - tiebreakPointsB);
          if ((tiebreakPointsA >= 7 || tiebreakPointsB >= 7) && diff >= 2) {
            // Ganador del tiebreak
            if (tiebreakPointsA > tiebreakPointsB) newGamesA = 7;
            else newGamesB = 7;
            
            // Determinar ganador del set
            const setWinner = tiebreakPointsA > tiebreakPointsB ? 'A' : 'B';
            if (setWinner === 'A') newSetsA++;
            else newSetsB++;
            
            // Resetear para nuevo set
            tiebreak = false;
            tiebreakPointsA = 0;
            tiebreakPointsB = 0;
            newPointsA = 0;
            newPointsB = 0;
            newGamesA = 0;
            newGamesB = 0;
          }
        } else {
          // L√≥gica normal de puntos
          if (team === 'A') newPointsA++;
          else newPointsB++;
          
          const scoreA = newPointsA;
          const scoreB = newPointsB;
          
          // ‚úÖ L√ìGICA DE P√ÅDEL: 4 puntos con ventaja de 1, o punto de oro despu√©s de 40-40
          if ((scoreA >= 4 && scoreA - scoreB >= 1) || (scoreB >= 4 && scoreB - scoreA >= 1)) {
            if (scoreA > scoreB) {
              newGamesA++;
              console.log("‚úÖ Equipo A gana el juego");
            } else {
              newGamesB++;
              console.log("‚úÖ Equipo B gana el juego");
            }
            
            // Resetear puntos
            newPointsA = 0;
            newPointsB = 0;
            
            // Verificar si se gan√≥ el set
            const gamesDiff = Math.abs(newGamesA - newGamesB);
            if ((newGamesA >= 6 || newGamesB >= 6) && gamesDiff >= 2) {
              // Ganador del set
              if (newGamesA > newGamesB) newSetsA++;
              else newSetsB++;
              
              // Resetear juegos para nuevo set
              newGamesA = 0;
              newGamesB = 0;
            } else if (newGamesA === 6 && newGamesB === 6) {
              // Activar tiebreak
              tiebreak = true;
              console.log("‚ö° Tiebreak activado");
            }
          }
        }
        
        // Actualizar la base de datos
        const updateData = {
          points_a: newPointsA,
          points_b: newPointsB,
          games_a: newGamesA,
          games_b: newGamesB,
          sets_a: newSetsA,
          sets_b: newSetsB,
          tiebreak: tiebreak,
          tiebreak_points_a: tiebreakPointsA,
          tiebreak_points_b: tiebreakPointsB,
          updated_at: new Date().toISOString()
        };
        
        const { error: updateError } = await supabase
          .from('matches')
          .update(updateData)
          .eq('id', matchState.id);
          
        if (updateError) {
          console.error("Error al actualizar punto:", updateError);
        } else {
          console.log("üìä Punto simulado correctamente");
          console.log(`Nuevo estado: Puntos ${newPointsA}-${newPointsB}, Juegos ${newGamesA}-${newGamesB}, Sets ${newSetsA}-${newSetsB}`);
        }
        
      } catch (error) {
        console.error("Error en simulaci√≥n de punto:", error);
      }
    }    

    async function addGame(team) {
      if (!matchState.id || matchState.status !== 'active') {
        console.log("‚ùå No hay partido activo para a√±adir juegos");
        return;
      }
      
      try {
        const { data: currentMatch, error } = await supabase
          .from('matches')
          .select('games_a, games_b, sets_a, sets_b')
          .eq('id', matchState.id)
          .single();
          
        if (error) throw error;
        
        let newGamesA = currentMatch.games_a || 0;
        let newGamesB = currentMatch.games_b || 0;
        let newSetsA = currentMatch.sets_a || 0;
        let newSetsB = currentMatch.sets_b || 0;
        
        if (team === 'A') newGamesA++;
        else newGamesB++;
        
        // Verificar si se gan√≥ el set
        const gamesDiff = Math.abs(newGamesA - newGamesB);
        if ((newGamesA >= 6 || newGamesB >= 6) && gamesDiff >= 2) {
          if (newGamesA > newGamesB) newSetsA++;
          else newSetsB++;
          
          // Resetear para nuevo set
          newGamesA = 0;
          newGamesB = 0;
        }
        
        const updateData = {
          games_a: newGamesA,
          games_b: newGamesB,
          sets_a: newSetsA,
          sets_b: newSetsB,
          points_a: 0,
          points_b: 0,
          tiebreak: false,
          tiebreak_points_a: 0,
          tiebreak_points_b: 0,
          updated_at: new Date().toISOString()
        };
        
        const { error: updateError } = await supabase
          .from('matches')
          .update(updateData)
          .eq('id', matchState.id);
          
        if (updateError) {
          console.error("Error al actualizar juego:", updateError);
        } else {
          console.log(`‚úÖ Juego simulado para equipo ${team}`);
        }
        
      } catch (error) {
        console.error("Error en simulaci√≥n de juego:", error);
      }
    }   

    async function toggleTiebreak() {
      if (!matchState.id || matchState.status !== 'active') {
        console.log("‚ùå No hay partido activo para modificar tiebreak");
        return;
      }
      
      try {
        const { data: currentMatch, error } = await supabase
          .from('matches')
          .select('tiebreak')
          .eq('id', matchState.id)
          .single();
          
        if (error) throw error;
        
        const newTiebreakValue = !currentMatch.tiebreak;
        
        const updateData = {
          tiebreak: newTiebreakValue,
          tiebreak_points_a: 0,
          tiebreak_points_b: 0,
          points_a: 0,
          points_b: 0,
          updated_at: new Date().toISOString()
        };
        
        const { error: updateError } = await supabase
          .from('matches')
          .update(updateData)
          .eq('id', matchState.id);
          
        if (updateError) {
          console.error("Error al alternar tiebreak:", updateError);
        } else {
          console.log(`üîÄ Tiebreak ${newTiebreakValue ? 'activado' : 'desactivado'}`);
        }
        
      } catch (error) {
        console.error("Error al alternar tiebreak:", error);
      }
    }

    async function endMatch() {
      if (!matchState.id || matchState.status !== 'active') {
        console.log("‚ùå No hay partido activo para finalizar");
        return;
      }
      
      try {
        const { data: currentMatch, error } = await supabase
          .from('matches')
          .select('games_a, games_b, points_a, points_b, tiebreak, tiebreak_points_a, tiebreak_points_b')
          .eq('id', matchState.id)
          .single();
          
        if (error) throw error;
        
        let winner = null;
        
        // Determinar ganador seg√∫n la l√≥gica de p√°del
        if (currentMatch.tiebreak) {
          winner = currentMatch.tiebreak_points_a > currentMatch.tiebreak_points_b ? 'teamA' : 'teamB';
        } else {
          winner = currentMatch.games_a > currentMatch.games_b ? 'teamA' : 'teamB';
        }
        
        const updateData = {
          status: 'completed',
          winner: winner,
          updated_at: new Date().toISOString()
        };
        
        const { error: updateError } = await supabase
          .from('matches')
          .update(updateData)
          .eq('id', matchState.id);
          
        if (updateError) {
          console.error("Error al finalizar partido:", updateError);
        } else {
          console.log(`üèÜ Partido finalizado. Ganador: ${winner}`);
          resetDisplay();
        }
        
      } catch (error) {
        console.error("Error al finalizar partido:", error);
      }
    }

    function generateQRCode() {
      if (!window.clubId) {
        return;
      }
      
      const courtNumber = matchState.court.replace('Cancha ', '');
      const registrationUrl = `${window.location.origin}/index.html?mode=qr&club=${window.clubId}&court=${courtNumber}`;
      
      const qrElement = document.getElementById('qrcode');
      if (!qrElement) return;
    
      qrElement.innerHTML = '';      
    
      const canvas = document.createElement('canvas');
      qrElement.appendChild(canvas);
    
      try {
        QRCode.toCanvas(canvas, registrationUrl, {
          width: 200,
          margin: 1,
          color: {
            dark: '#2c3e50',
            light: '#ffffff'
          }
        });
      } catch (error) {
        qrElement.innerHTML = '<div style="color: white; padding: 20px; text-align: center;">Error al generar QR</div>';
      }
    }

    function showErrorScreen(message) {
      document.body.innerHTML = `
        <div style="display: flex; justify-content: center; align-items: center; height: 100vh; flex-direction: column; text-align: center; padding: 20px; background: #2c3e50; color: white;">
          <h1 style="color: #e74c3c; margin-bottom: 20px; font-size: 2rem;">Error de Configuraci√≥n</h1>
          <p style="margin-bottom: 30px; font-size: 1.2rem; max-width: 500px;">${message}</p>
          <button onclick="location.reload()" style="padding: 12px 24px; background: #3498db; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 1rem;">Reintentar</button>
        </div>
      `;
    }
  </script>
</body>
</html>
