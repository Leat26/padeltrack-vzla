<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
  <title>PadelTrack - Sistema Profesional</title>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@500;600;700&family=Oswald:wght@500&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" integrity="sha512-9usAa10IRO0HhonpyAIVpjrylPvoDwiPUiKdWk5t3PyolY1cOd4DSE0Ga+ri4AuTroPR5aQvXU9xC6qOPnzFeg==" crossorigin="anonymous" referrerpolicy="no-referrer" />  
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    body {
      background: url('fondo-cancha.jpg') no-repeat center center fixed;
      background-size: cover;
      opacity: 0.95;
      font-family: 'Montserrat', sans-serif;
      color: white;
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 20px;
    }
    .container {
      width: 100%;
      max-width: 520px;
      background: rgba(255, 255, 255, 0.9);
      color: #333;
      border-radius: 24px;
      overflow: hidden;
      box-shadow: 0 20px 40px rgba(0,0,0,0.3);
      display: flex;
      flex-direction: column;
      height: 90vh;
    }
    /* Header */
    header {
      position: relative;
      padding: 20px;
      text-align: center;
      font-family: 'Oswald', sans-serif;
      font-size: 28px;
      font-weight: 600;
      letter-spacing: 1px;
    }
    header #logo {
      cursor: pointer;
      width: 100%;
      height: 130px;
      background: url('logo-padeltrack.png') no-repeat center center;
      background-size: contain;
      margin-bottom: 20px;
    }
    header .btn-header {
      position: absolute;
      background: none;
      border: none;
      color: #FFD700; /* Cambiado de white a amarillo (#FFD700) */
      font-size: 20px;
      cursor: pointer;
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      transition: all 0.2s;
    }
    header .btn-header:hover {
      background: rgba(255, 215, 0, 0.1);
    }
    header .back-btn {
      left: 20px;
    }
    header .logout-btn {
      right: 20px;
    }
    /* Pantallas */
    .screen {
      flex: 1;
      padding: 25px;
      display: none;
      overflow-y: auto;
      text-align: center;
    }
    .active {
      display: block;
      animation: fadeIn 0.4s ease-in-out;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    /* T√≠tulos */
    h2 {
      font-size: 24px;
      color: #016B3A;
      margin: 15px 0;
      font-weight: 600;
    }
    h3 {
      font-size: 18px;
      margin: 10px 0;
      font-weight: 600;
    }
    /* Botones */
    .btn {
      background: #016B3A;
      color: white;
      border: none;
      padding: 14px 28px;
      margin: 12px;
      font-size: 18px;
      border-radius: 14px;
      cursor: pointer;
      width: 85%;
      max-width: 320px;
      font-weight: 600;
      transition: all 0.3s ease;
      box-shadow: 0 4px 10px rgba(1, 107, 58, 0.3);
    }
    .btn:hover {
      background: #00552E;
      transform: translateY(-2px);
    }
    .btn-blue {
      background: #1976D2;
      box-shadow: 0 4px 10px rgba(25, 118, 210, 0.3);
    }
    .btn-blue:hover {
      background: #1565c0;
    }
    .btn-red {
      background: #D32F2F;
      box-shadow: 0 4px 10px rgba(211, 47, 47, 0.3);
    }
    .btn-red:hover {
      background: #c62828;
    }
    .btn-disabled {
      background: #BDBDBD !important;
      cursor: not-allowed;
      opacity: 0.7;
    }
    .btn-disabled:hover {
      transform: none;
      background: #BDBDBD !important;
    }
    .btn-green {
      background: #016B3A;
      color: white;
      padding: 14px 28px;
      margin: 20px 0;
      font-size: 18px;
      border-radius: 14px;
      cursor: pointer;
      width: 85%;
      max-width: 320px;
      font-weight: 600;
      box-shadow: 0 4px 10px rgba(1, 107, 58, 0.3);
      transition: all 0.3s ease;
    }
    .btn-green:hover {
      background: #00552E;
      transform: translateY(-2px);
    }		
    /* Enlaces */
    .link {
      color: #1976D2;
      font-size: 16px;
      text-decoration: none;
      margin-top: 15px;
      display: inline-block;
    }
    .link:hover {
      text-decoration: underline;
    }
    /* Equipos */
    .teams {
      display: flex;
      justify-content: space-around;
      gap: 15px;
      margin: 20px 0;
      flex-wrap: wrap;
    }
    .team {
      flex: 1;
      min-width: 45%;
      background: #f5f5f5;
      padding: 15px;
      border-radius: 16px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.05);
      transition: all 0.3s ease;
      cursor: pointer;
      border: 2px solid transparent;
    }
    .team:hover {
      transform: translateY(-3px);
      box-shadow: 0 6px 12px rgba(0,0,0,0.1);
    }
    .team.selected {
      border: 2px solid #016B3A;
      box-shadow: 0 0 0 4px #E8F5E9;
    }
    .team h3 {
      color: #016B3A;
      font-weight: 600;
    }
    input {
      width: 90%;
      padding: 10px;
      margin: 6px 0;
      border: 1px solid #ddd;
      border-radius: 10px;
      font-size: 14px;
      font-family: 'Montserrat', sans-serif;
    }
    .player-inputs {
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin-top: 10px;
	  align-items: stretch;
    }
    .player-name {
      display: flex;
      gap: 5px;
    }
    .player-name input {
      flex: 1;
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 8px;
      background: #f8f9fa;
      font-size: 14px;
      height: 40px;
      box-sizing: border-box;
      margin-bottom: 4px;
    }	
    .player-name input:disabled {
      opacity: 0.7;
      cursor: not-allowed;
      background: #e9ecef;
      color: #495057;
    }	
    .cedula-input {
      display: flex;
	  position: relative;
      gap: 10px;
      align-items: center;
    }
    .cedula-validation {
      position: absolute;
      right: 10px;
      top: 50%;
      transform: translateY(-50%);
      font-size: 16px;
      width: 24px;
      height: 24px;
      display: flex;
      align-items: center;
      justify-content: center;	  
    }
    .cedula-validation.valid {
      color: #4CAF50;
    }
    .cedula-validation.invalid {
      color: #D32F2F;
    }
    .cedula-validation.loading {
      color: #1976D2;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      0% { transform: translateY(-50%) rotate(0deg); }
      100% { transform: translateY(-50%) rotate(360deg); }
    }
    /* Marcador */
    .scoreboard {
      display: flex;
      justify-content: space-around;
      align-items: center;
      margin: 20px 0;
      gap: 20px;
    }
    .games-score {
      font-size: 22px;
      font-weight: 600;
      color: #666;
      margin-bottom: 5px;
    }
    .score {
      font-size: 70px;
      font-weight: 700;
      color: #016B3A;
      font-family: 'Oswald', sans-serif;
      transition: all 0.3s ease;
    }
    .score.winner {
      color: #4CAF50;
      text-shadow: 0 0 10px rgba(76, 175, 80, 0.3);
    }
    .score.loser {
      color: #D32F2F;
    }
    .tiebreak-badge {
      background: #FFECB3;
      color: #5D4037;
      padding: 4px 10px;
      border-radius: 20px;
      font-weight: 600;
      font-size: 14px;
      display: inline-block;
      margin: 5px 0;
    }
    .sudden-death {
      background: #FFCCBC;
      color: #D84315;
      font-weight: 700;
    }
    .controls {
      display: flex;
      justify-content: center;
      gap: 25px;
      margin: 15px 0;
    }
    .controls button {
      font-size: 24px;
      width: 60px;
      height: 60px;
      border-radius: 50%;
      border: none;
      background: #016B3A;
      color: white;
      cursor: pointer;
      transition: all 0.2s;
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }
    .controls button:active {
      transform: scale(0.9);
    }
    .timer {
      font-size: 18px;
      margin: 15px 0;
      color: #555;
      font-weight: 500;
    }
    /* Estad√≠sticas */
    .stats {
      text-align: left;
      margin: 20px auto;
      width: 90%;
      background: #f8f9fa;
      padding: 18px;
      border-radius: 12px;
      font-size: 16px;
      color: #333;
      box-shadow: 0 2px 6px rgba(0,0,0,0.05);
      line-height: 1.6;
    }
    .stats strong {
      color: #016B3A;
    }
    .scoring-badge {
      background: #E8F5E9;
      color: #016B3A;
      padding: 6px 12px;
      border-radius: 20px;
      font-weight: 600;
      display: inline-block;
      margin: 10px 0;
      font-size: 14px;
    }
    /* Iconos de equipos */
    .team-icon {
      font-size: 20px;
      margin-right: 5px;
    }
    /* Footer */
    .footer {
      text-align: center;
      font-size: 12px;
      color: #aaa;
      margin-top: 10px;
    }
    /* Ayuda */
    .help-tip {
      background: #e0e0e0;
      border-radius: 50%;
      width: 24px;
      height: 24px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      margin-left: 5px;
      cursor: help;
      color: #016B3A;
    }
    /* Notificaci√≥n */
    .notification {
      position: fixed;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: #016B3A;
      color: white;
      padding: 12px 25px;
      border-radius: 30px;
      font-weight: 600;
      box-shadow: 0 4px 15px rgba(0,0,0,0.2);
      z-index: 100;
      opacity: 0;
      transition: opacity 0.3s;
    }
    .notification.show {
      opacity: 1;
    }
    /* Indicador de modo */
    .mode-indicator {
      background: #E3F2FD;
      border-left: 4px solid #1976D2;
      padding: 8px 15px;
      margin: 10px 0;
      border-radius: 0 8px 8px 0;
      font-size: 14px;
      color: #0D47A1;
      text-align: left;
    }
    /* Dashboard */
    .dashboard-stats {
      display: flex;
      justify-content: space-between;
      text-align: center;
      margin-bottom: 20px;
    }
    .stat-item {
      background: #016B3A;
      color: white;
      border-radius: 16px;
      padding: 15px;
      flex: 1;
      margin: 0 5px;
    }
    .stat-value {
      font-size: 24px;
      font-weight: bold;
      margin: 5px 0;
    }
    .dashboard-actions {
      display: flex;
      gap: 10px;
      margin-top: 20px;
    }
    .dashboard-actions .btn {
      flex: 1;
      padding: 12px;
      font-size: 16px;
    }
    /* Team name input */
    .team-name-input {
      width: 90%;
      padding: 8px;
      margin: 10px auto 15px;
      border: 1px solid #ddd;
      border-radius: 10px;
      font-size: 14px;
      text-align: center;
      font-style: italic;
      color: #666;
      min-height: 40px; /* Asegura altura m√≠nima */
      box-sizing: border-box;	  
    }
    /* Player status */
    .player-status {
      font-size: 12px;
      margin-top: -5px;
      margin-bottom: 5px;
      text-align: left;
      padding-left: 5%;
      color: #4CAF50;
    }
    /* Error messages */
    .error-message {
      color: #D32F2F;
      font-size: 14px;
      margin-top: -5px;
      margin-bottom: 5px;
      text-align: left;
      padding-left: 5%;
      font-weight: 600;
    }
    /* Ranking */
    .ranking-wins {
      color: #4CAF50;
      font-weight: bold;
    }
    .ranking-losses {
      color: #D32F2F;
    }
    .win-percentage {
      background: #E8F5E9;
      color: #388E3C;
      padding: 2px 8px;
      border-radius: 10px;
      font-weight: bold;
      font-size: 12px;
    }
    /* Alertas */
    .alert {
      background: #FFF8E1;
      color: #5D4037;
      padding: 10px;
      border-radius: 8px;
      margin: 10px 0;
      text-align: left;
    }
    .alert strong {
      color: #D84315;
    }
    /* Pantalla de Bienvenida */
    #welcome {
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      text-align: center;
    }
    #welcome h2 {
      font-size: 28px;
      color: #016B3A;
      margin-bottom: 15px;
    }
    #welcome .subtitle {
      font-size: 18px;
      color: #555;
      margin-bottom: 20px;
    }
    .handshake-container {
      margin: 30px 0;
    }
    .handshake-img {
      max-width: 200px;
      border-radius: 12px;
    }								
    /* ================================= */
    /* =========== RESPONSIVE ========== */
    /* ================================= */
    /* Variables para altura en m√≥viles */
    :root {
      --vh: 1vh;
    }
    /* Ajustes para tablets */
    @media (max-width: 768px) {
      .container {
        border-radius: 20px;
        height: 95vh;
      }
      header {
        padding: 15px;
        font-size: 24px;
      }
      header #logo {
        height: 80px;
      }
      .screen {
        padding: 20px 15px;
      }
      .btn {
        margin: 8px 0;
        width: 90%;
      }
      .teams {
        gap: 10px;
      }
      .team {
        min-width: 48%;
        padding: 12px;
      }
      .player-inputs {
        gap: 5px;
      }
      .scoreboard {
        gap: 10px;
      }
      .score {
        font-size: 56px;
      }
      .controls button {
        width: 50px;
        height: 50px;
        font-size: 20px;
      }
      .dashboard-stats {
        gap: 8px;
      }
      .stat-item {
        padding: 12px;
      }
      .stat-value {
        font-size: 20px;
      }
      #welcome h2 {
        font-size: 24px;
      }
      .btn-green {
        padding: 12px 20px;
        font-size: 16px;
      }   
    }
    /* Ajustes para m√≥viles peque√±os */
    @media (max-width: 480px) {
      .container {
        border-radius: 16px;
        height: 100vh;
        max-width: 100%;
        overflow-y: auto;
      }
      header {
        padding: 12px 10px;
        font-size: 22px;
      }
      header #logo {
        height: 80px;
      }
      .screen {
        padding: 15px 10px;
        overflow-y: auto;
      }
      h2 {
        font-size: 22px;
        margin: 12px 0;
      }
      h3 {
        font-size: 16px;
        margin: 8px 0;
      }
      .btn {
        padding: 12px 20px;
        font-size: 16px;
        margin: 8px 0;
      }
      .teams {
        flex-direction: column;
        gap: 8px;
      }
      .team {
        min-width: 100%;
        padding: 10px;
      }
      input {
        width: 95%;
        padding: 8px;
        font-size: 13px;
      }
      .player-inputs {
        gap: 4px;
      }
      .player-name input {
        font-size: 12px;
      }
      .scoreboard {
        flex-direction: column;
        gap: 15px;
      }
      .score {
        font-size: 48px;
      }
      .games-score {
        font-size: 18px;
      }
      .controls {
        gap: 15px;
      }
      .controls button {
        width: 45px;
        height: 45px;
        font-size: 18px;
      }
      .timer {
        font-size: 16px;
      }
      .stats {
        width: 95%;
        font-size: 14px;
        padding: 12px;
      }
      .dashboard-stats {
        flex-direction: column;
        gap: 10px;
      }
      .stat-item {
        margin: 5px 0;
      }
      .footer {
        font-size: 11px;
      }
      .help-tip {
        width: 20px;
        height: 20px;
        font-size: 10px;
      }
      .mode-indicator {
        font-size: 12px;
        padding: 6px 10px;
      }
      .scoring-badge {
        font-size: 12px;
        padding: 4px 8px;
      }
      .tiebreak-badge {
        font-size: 12px;
        padding: 2px 6px;
      }
      .player-status, .error-message {
        font-size: 11px;
      }
      .win-percentage {
        font-size: 10px;
        padding: 1px 6px;
      }
      #welcome h2 {
        font-size: 22px;
      }
      #welcome .subtitle {
        font-size: 16px;
      }
    }
    /* Para pantallas en modo horizontal en m√≥viles */
    @media (max-height: 500px) and (orientation: landscape) {
      .container {
        height: 100vh;
        overflow-y: auto;
      }
      .screen {
        overflow-y: auto;
        padding-bottom: 50px;
      }
      .scoreboard {
        flex-direction: row;
        gap: 5px;
      }
      .score {
        font-size: 36px;
      }
      .games-score {
        font-size: 16px;
      }
      .controls {
        gap: 5px;
      }
      .controls button {
        width: 35px;
        height: 35px;
        font-size: 14px;
      }
      .timer {
        font-size: 14px;
      }
      .btn {
        margin: 5px 0;
        padding: 8px 15px;
        font-size: 14px;
      }
      .teams {
        gap: 5px;
      }
      .team {
        padding: 8px;
      }
      input {
        padding: 6px;
        font-size: 12px;
      }
      .footer {
        display: none;
      }
    }
    /* Para pantallas muy peque√±as */
    @media (max-height: 400px) {
      .container {
        height: 100vh !important;
      }
      .score {
        font-size: 32px;
      }
      .games-score {
        font-size: 14px;
      }
      .controls button {
        width: 30px;
        height: 30px;
        font-size: 12px;
      }
      .footer {
        display: none;
      }
      .btn {
        margin: 4px 0;
        padding: 6px 12px;
        font-size: 12px;
      }
      .teams {
        gap: 4px;
      }
      .team {
        padding: 6px;
      }
      h2 {
        font-size: 20px;
        margin: 8px 0;
      }
      h3 {
        font-size: 14px;
        margin: 6px 0;
      }
    }
    /* Scroll suave en m√≥viles */
    .screen {
      -webkit-overflow-scrolling: touch;
    }
    /* Evitar el zoom al enfocar inputs en iOS */
    input:focus {
      font-size: 16px !important;
    }
    /* Mejorar la experiencia t√°ctil */
    .btn:active, .team:active {
      transform: scale(0.98);
      opacity: 0.9;
    }
    /* Ajustar altura del contenedor en m√≥viles */
    .container {
      height: calc(var(--vh, 1vh) * 100);
    }
	
    /* Estilo personalizado para ranking semanal */
    .ranking-item {
      display: flex;
      flex-direction: column;
      gap: 4px;
      margin: 12px 0;
    }
    
    .ranking-rank {
      font-weight: bold;
      color: #555;
      font-size: 14px;
      margin-right: 8px;
      align-self: flex-start;
	  margin-bottom: 0;
    }
    
    /* L√≠nea 1: Avatar + iniciales + nombre */
    .ranking-name {
      background: #E8F5E9;
      border-radius: 12px;
      padding: 8px 12px;
      margin-bottom: 6px;
      font-size: 16px;
      color: #016B3A;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 8px;
	  flex-wrap: wrap;
    }
    
    .ranking-name span {
      font-weight: bold;
    }
    
    /* L√≠nea 2: Nivel + porcentaje */
    .ranking-level {
      margin-left: 32px;
      margin-top: 4px;
      font-size: 14px;
      color: #016B3A;
    }
    
    /* L√≠nea 3: Estad√≠sticas */
    .ranking-stats {
      margin-left: 32px;
      margin-top: 6px;
      font-size: 13px;
      color: #666;
    }

    /* Nuevos estilos para la pantalla de inicio */
    .courts-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 15px;
      margin: 20px 0;
    }
    
    .court-card {
      background: #E8F5E9;
      border-radius: 16px;
      padding: 20px;
      text-align: center;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
      transition: all 0.3s ease;
      border: 2px solid transparent;
    }
    
    .court-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 8px 16px rgba(0,0,0,0.15);
      border-color: #016B3A;
    }
    
    .court-icon {
      font-size: 40px;
      color: #016B3A;
      margin-bottom: 10px;
    }
    
    .court-status {
      font-size: 14px;
      margin-top: 8px;
      padding: 4px 8px;
      border-radius: 12px;
      display: inline-block;
    }
    
    .status-available {
      background: #4CAF50;
      color: white;
    }
    
    .status-busy {
      background: #FF9800;
      color: white;
    }
    
    .status-offline {
      background: #F44336;
      color: white;
    }
    
    .play-button {
      margin-top: 25px;
      background: linear-gradient(135deg, #016B3A 0%, #028a48 100%);
      padding: 16px 32px;
      font-size: 18px;
      border-radius: 50px;
      box-shadow: 0 6px 12px rgba(1, 107, 58, 0.3);
    }
    
    .play-button:hover {
      transform: translateY(-3px);
      box-shadow: 0 8px 16px rgba(1, 107, 58, 0.4);
    }
    
    .play-button i {
      margin-right: 8px;
    }
    
    /* Estilos para la nueva pantalla de selecci√≥n de canchas */
    .court-option {
      background: #f8f9fa;
      border-radius: 16px;
      padding: 20px;
      text-align: center;
      margin: 10px 0;
      cursor: pointer;
      transition: all 0.3s ease;
      border: 2px solid transparent;
    }
    
    .court-option:hover {
      background: #E8F5E9;
      transform: translateY(-3px);
      box-shadow: 0 6px 12px rgba(0,0,0,0.1);
    }
    
    .court-option.selected {
      border-color: #016B3A;
      background: #E8F5E9;
      box-shadow: 0 0 0 3px rgba(1, 107, 58, 0.2);
    }
    
    .court-details {
      margin-top: 10px;
      font-size: 14px;
      color: #666;
    }	
  </style>
  <!-- Carga CORRECTA del SDK de Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    // Inicializaci√≥n CORRECTA de Supabase
    document.addEventListener('DOMContentLoaded', async function() {
      console.log("Inicializando aplicaci√≥n con Supabase...");
      
      // Configuraci√≥n de Supabase (REEMPLAZA CON TUS CREDENCIALES)
      const supabaseUrl = 'https://omizjfxbxkfkxlxdkbej.supabase.co'; // ¬°REEMPLAZA ESTO!
      const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9taXpqZnhieGtma3hseGRrYmVqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU0NzkyMjIsImV4cCI6MjA3MTA1NTIyMn0.UAj61BfHqIF8Gg9bHYsEF_ocTM8Og4oJN2bWT11N6Rg'; // ¬°REEMPLAZA ESTO!
      
      try {
        // Forma CORRECTA de inicializar Supabase
        const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);
        window.supabase = supabase;
        
        console.log("Supabase client creado exitosamente");
        
        // Definir verifyAuth INMEDIATAMENTE despu√©s
        window.verifyAuth = async function() {
            const { data, error } = await window.supabase.auth.getSession();
            if (error) {
                console.error("Error al verificar sesi√≥n:", error);
                return false;
            }
            return !!data.session;
        };		
		
        // Variables globales
        window.lastMatchId = null;
		window.currentUser = null;
        window.currentClub = null;
        window.selectedCourt = "Cancha 1";
        window.scoringType = null;
        window.scoreA = 0;
        window.scoreB = 0;
        window.gamesA = 0;
        window.gamesB = 0;
        window.setsA = 0;
        window.setsB = 0;
        window.inTiebreak = false;
        window.tiebreakPointsA = 0;
        window.tiebreakPointsB = 0;
        window.seconds = 0;
        window.interval = null;
        window.gameDuration = "00:00";
        window.teamNames = {
          teamA: "Equipo A",
          teamB: "Equipo B"
        };
		window.setHistory = []; 
        window.playersData = {
          'A1': { cedula: '', firstName: '', lastName: '', exists: false },
          'A2': { cedula: '', firstName: '', lastName: '', exists: false },
          'B1': { cedula: '', firstName: '', lastName: '', exists: false },
          'B2': { cedula: '', firstName: '', lastName: '', exists: false }
        };
		
        // Verificar si hay par√°metros de URL para modo QR
        const urlParams = new URLSearchParams(window.location.search);
        const courtId = urlParams.get('court');
        const clubIdFromUrl = urlParams.get('club');
        const mode = urlParams.get('mode');
        
        if (mode === 'qr' && courtId) {
            console.log("Modo QR detectado para cancha:", courtId);
            
            // Si hay clubId en la URL, usarlo en lugar de depender de la sesi√≥n
            if (clubIdFromUrl) {
                // Validar formato UUID
                const uuidRegex = /^[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i;
                if (uuidRegex.test(clubIdFromUrl)) {
                    // Guardar el clubId para usar en startGame
                    window.currentClubId = clubIdFromUrl;
                    
                    // Establecer la cancha seleccionada
                    window.selectedCourt = `Cancha ${courtId}`;
                    
                    // Mostrar pantalla de registro
                    window.goToScreen('register');
                    
                    // Actualizar t√≠tulo
                    const registerTitle = document.querySelector('#register h2');
                    if (registerTitle) {
                        registerTitle.textContent = `Registro para Cancha ${courtId}`;
                    }
                    
                    // Modificar temporalmente window.startGame para usar el clubId de la URL
                    const originalStartGame = window.startGame;
                    window.startGame = async function() {
                        // Forzar club_id desde la URL
                        window.gameData.club_id = clubIdFromUrl;
                        return await originalStartGame.call(this);
                    };
                } else {
                    console.error("ID de club inv√°lido en la URL:", clubIdFromUrl);
                    window.showNotification("QR inv√°lido. Contacte al administrador.");
                    window.goToScreen('home');
                }
            } else {
                // Flujo original si no hay clubId en la URL
                const isAuthenticated = await window.verifyAuth();
                if (!isAuthenticated) {
                    window.goToScreen('tv-mode');
                    initializeTvMode(courtId);
                    return;
                }
                
                // Establecer la cancha seleccionada
                window.selectedCourt = `Cancha ${courtId}`;
                
                // Mostrar pantalla de registro
                window.goToScreen('register');
                
                // Actualizar t√≠tulo
                const registerTitle = document.querySelector('#register h2');
                if (registerTitle) {
                    registerTitle.textContent = `Registro para Cancha ${courtId}`;
                }
            }
        }		
        
        if (mode === 'qr' && courtId) {
            console.log("Modo QR detectado para cancha:", courtId);
            
            // NO verificar autenticaci√≥n del jugador
            // El jugador solo debe registrar sus datos
            
            // Guardar la cancha en una variable global
            window.currentCourtId = courtId;
            
            // Mostrar pantalla de registro
            window.goToScreen('register');
            
            // Actualizar el t√≠tulo para mostrar la cancha
            const registerTitle = document.querySelector('#register h2');
            if (registerTitle) {
                registerTitle.textContent = `Registro para Cancha ${courtId}`;
            }
            
            // Modificar temporalmente window.startGame para usar la cancha correcta
            const originalStartGame = window.startGame;
            window.startGame = async function() {
                window.gameData.court = `Cancha ${courtId}`;
                return await originalStartGame.call(this);
            };
            
            return;
        }
        
        // Funci√≥n utilitaria para convertir valores a n√∫meros seguros
        window.safeNumber = function(value, defaultValue = 0) {
          if (value === undefined || value === null) return defaultValue;
          const num = typeof value === 'string' ? parseInt(value) : value;
          return isNaN(num) || num < 0 ? defaultValue : num;
        };
        
        // Mostrar notificaci√≥n
        window.showNotification = function(message) {
          const notification = document.getElementById('notification');
          if (!notification) return;
          
          notification.innerHTML = message;
          notification.classList.add('show');
          
          setTimeout(() => {
            notification.classList.remove('show');
          }, 3000);
        };
		
        // FUNCI√ìN: Obtener nivel del jugador 
        window.getPlayerLevel = function(winRate) {
          if (winRate >= 85) return { name: "Diamante", icon: "gem", color: "#1C369C" }; 
          if (winRate >= 70) return { name: "Oro", icon: "star", color: "#FFD700" };
          if (winRate >= 40) return { name: "Plata", icon: "award", color: "#C0C0C0" };
          return { name: "Bronce", icon: "medal", color: "#CD7F32" };
        };		
        
        // Funci√≥n para verificar autenticaci√≥n																		
        window.verifyAuth = async function() {
          const { data, error } = await window.supabase.auth.getSession();
          
          if (error) {
            console.error("Error al verificar sesi√≥n:", error);
            return false;
          }
          
          return !!data.session;
        };
		
        // Navegaci√≥n entre pantallas - Versi√≥n mejorada con seguridad
        window.goToScreen = async function(id) {
          
		  // Extraer el ID de pantalla de la URL si existe
		  const urlParams = new URLSearchParams(window.location.search);
		  const urlScreen = urlParams.get('screen');
		  
		  // Si la URL especifica una pantalla, usarla en lugar del par√°metro
		  const targetScreen = urlScreen || id;
		  
		  // Pantallas p√∫blicas que no requieren autenticaci√≥n
          const publicScreens = ['login', 'register-screen', 'welcome','tv-mode'];
          
          // Si no es una pantalla p√∫blica, verificar autenticaci√≥n
          if (!publicScreens.includes(id)) {
            const isAuthenticated = await window.verifyAuth();
            
            if (!isAuthenticated) {
              window.showNotification('Por favor, inicia sesi√≥n primero');
              window.goToScreen('login');
              return;									
            }
          }
          
          // Ocultar todas las pantallas
          document.querySelectorAll('.screen').forEach(s => {
            s.classList.remove('active');
            s.style.display = 'none';
          });

          document.querySelectorAll('.screen').forEach(s => {
            s.classList.remove('active');
            s.style.display = 'none';
          });		  
          
          // Mostrar la pantalla solicitada
          const screen = document.getElementById(id);
          if (screen) {
            screen.style.display = 'block';
            setTimeout(() => {
              screen.classList.add('active');
            }, 50);
          }

          // Limpiar formulario de registro si se est√° entrando a 'register-screen'
		  if (id === 'register-screen') {
              const clubName = document.getElementById('club-name');
              const clubRif = document.getElementById('club-rif');
              const courtCount = document.getElementById('court-count');
              const registerEmail = document.getElementById('register-email');
              const phonePrefix = document.getElementById('phone-prefix');
              const phoneSuffix = document.getElementById('phone-suffix');
              const registerPassword = document.getElementById('register-password');
              const registerConfirm = document.getElementById('register-confirm');
          
              if (clubName) clubName.value = '';
              if (clubRif) clubRif.value = '';
              if (courtCount) courtCount.value = '';
              if (registerEmail) registerEmail.value = '';
              if (phonePrefix) phonePrefix.value = '';
              if (phoneSuffix) phoneSuffix.value = '';
              if (registerPassword) registerPassword.value = '';
              if (registerConfirm) registerConfirm.value = '';
          }

          // Si es la pantalla de selecci√≥n de canchas, cargarlasPantalla 
          if (id === 'courts-selection') {
            window.loadCourtsSelection();
          }          

          // Si es la Pantalla de inicio, actualizar con los datos del club
          if (id === 'home' && window.currentUser && window.currentClub) {
            window.updateHomeScreen();
          }
          
          // Reiniciar marcador al salir
          if (id !== 'game' && window.interval) {
            clearInterval(window.interval);
            window.interval = null;
          }
          
          // Si es el dashboard, cargar datos
          if (id === 'dashboard' && window.currentUser && window.currentClub) {
            window.loadDashboard();
          }
          
          // Actualizar nombres de equipos en el marcador
          if (id === 'game') {
            window.updateTeamNamesDisplay();
          }
          
          // Si es registro, resetear validaciones
          if (id === 'register') {
            window.resetPlayerValidation();
            // Resetear nombres de equipos
            const teamAInput = document.getElementById('teamA-name');
            const teamBInput = document.getElementById('teamB-name');
            if (teamAInput) teamAInput.value = '';
            if (teamBInput) teamBInput.value = '';
          }
          
          // Si es ranking, cargar ranking
          if (id === 'ranking') {
            // Mostrar estado de carga inicial
            const rankingList = document.getElementById('ranking-list');
            if (rankingList) {
              rankingList.innerHTML = '<p>Cargando ranking...</p>';
            }
			window.loadRanking();
          }
          
          // Si es la pantalla de bienvenida, actualizar con el nombre del club
          if (id === 'welcome' && window.currentClub) {
            const clubNameWelcome = document.getElementById('club-name-welcome');
            if (clubNameWelcome) {
              clubNameWelcome.textContent = window.currentClub.name;
              console.log("Nombre del club actualizado en pantalla de bienvenida");
            } else {
              console.error("No se encontr√≥ el elemento club-name-welcome");
            }
          }

          
          // Asegurar que el scroll est√© en la parte superior
          if (screen) {
            screen.scrollTop = 0;
          }
        };


        // Funci√≥n para crear la pantalla de modo TV
        function createTvModeScreen() {
          const tvModeHTML = `
          <div class="screen" id="tv-mode">
            <header>
              <button class="back-btn btn-header" onclick="window.goToScreen('home')">
                <i class="fas fa-arrow-left"></i>
              </button>
            </header>
            <h2>Modo TV - Cancha #<span id="tv-court-number">1</span></h2>
            
            <div class="scoreboard">
              <div class="team team-a">
                <h3 id="tv-team-a-name">Equipo A</h3>
                <div class="players" id="tv-team-a-players">-</div>
                <div class="score" id="tv-score-a">0</div>
              </div>
              
              <div class="vs">VS</div>
              
              <div class="team team-b">
                <h3 id="tv-team-b-name">Equipo B</h3>
                <div class="players" id="tv-team-b-players">-</div>
                <div class="score" id="tv-score-b">0</div>
              </div>
            </div>
            
            <div class="game-info">
              <div class="info-box">
                <span>Duraci√≥n</span>
                <span id="tv-match-duration">00:00</span>
              </div>
              <div class="info-box">
                <span>Puntos totales</span>
                <span id="tv-total-points">0</span>
              </div>
            </div>
            
            <div class="qr-section">
              <h3>Escanee para registrar su partido</h3>
              <div id="tv-qrcode"></div>
              <p>Use su smartphone para escanear el c√≥digo</p>
            </div>
          </div>`;
          
          // Agregar la pantalla al DOM
          document.querySelector('.container').insertAdjacentHTML('beforeend', tvModeHTML);
        }
        
        // Funci√≥n para inicializar modo TV
        function initializeTvMode(courtId) {
            document.getElementById('tv-court-number').textContent = courtId;
            
            // Incluir club_id en la URL del QR
            const registrationUrl = `${window.location.origin}/index.html?mode=qr&club=${window.currentUser.id}&court=${courtId}`;
            
            QRCode.toCanvas(document.getElementById('tv-qrcode'), registrationUrl, {
                width: 180,
                margin: 1,
                color: {
                    dark: '#2c3e50',
                    light: '#ffffff'
                }
            });
            
            // Suscribirse a cambios en la base de datos para esta cancha
            setupCourtRealtimeSubscription(courtId);
        }
        
        // Funci√≥n para suscribirse a cambios en una cancha espec√≠fica
        function setupCourtRealtimeSubscription(courtId) {
          const subscription = window.supabase
            .from('matches')
            .on('UPDATE', payload => {
              if (payload.new.court_id == courtId || payload.new.court == `Cancha ${courtId}`) {
                updateTvMatchDisplay(payload.new);
              }
            })
            .on('INSERT', payload => {
              if (payload.new.court_id == courtId || payload.new.court == `Cancha ${courtId}`) {
                updateTvMatchDisplay(payload.new);
              }
            })
            .subscribe();
        }
        
        // Funci√≥n para actualizar la visualizaci√≥n en modo TV
        function updateTvMatchDisplay(matchData) {
          // Actualizar la interfaz con los datos del partido
          document.getElementById('tv-team-a-name').textContent = matchData.team_a_name || 'Equipo A';
          document.getElementById('tv-team-b-name').textContent = matchData.team_b_name || 'Equipo B';
          document.getElementById('tv-team-a-players').textContent = 
            matchData.team_a_players ? matchData.team_a_players.join(' / ') : '-';
          document.getElementById('tv-team-b-players').textContent = 
            matchData.team_b_players ? matchData.team_b_players.join(' / ') : '-';
          document.getElementById('tv-score-a').textContent = matchData.team_a_score || 0;
          document.getElementById('tv-score-b').textContent = matchData.team_b_score || 0;
          document.getElementById('tv-total-points').textContent = 
            (matchData.team_a_score || 0) + (matchData.team_b_score || 0);
          
          // Actualizar duraci√≥n si el partido est√° activo
          if (matchData.status === 'active' && matchData.start_time) {
            updateTvMatchDuration(matchData.start_time);
          }
        }
        
        // Funci√≥n para actualizar la duraci√≥n del partido en modo TV
        function updateTvMatchDuration(startTime) {
          const start = new Date(startTime);
          const now = new Date();
          const diff = now - start;
          const minutes = Math.floor(diff / 60000);
          const seconds = Math.floor((diff % 60000) / 1000);
          
          document.getElementById('tv-match-duration').textContent = 
            `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }
        
        // Actualizar la pantalla de inicio con los datos del club
        window.updateHomeScreen = async function() {
          if (!window.currentUser) return;
        
          // Mostrar estado de carga inicial
          const clubNameDisplay = document.getElementById('club-name-display');
          const totalMatches = document.getElementById('total-matches');
          const activePlayers = document.getElementById('active-players');
          const totalHours = document.getElementById('total-hours');
          const courtsGrid = document.getElementById('courts-grid');
          const playersTodayList = document.getElementById('players-today-list');
        
          // No sobrescribir el nombre del club si ya est√° establecido
          if (clubNameDisplay && clubNameDisplay.textContent === 'Cargando...') {
            clubNameDisplay.textContent = window.currentClub?.name || 'Cargando...';
          }
          
          if (courtsGrid) courtsGrid.innerHTML = '<p><i class="fas fa-spinner fa-spin"></i> Cargando canchas...</p>';
          
          // Limpiar m√©tricas (pero no el nombre del club)
          if (totalMatches) totalMatches.textContent = '0';
          if (activePlayers) activePlayers.textContent = '0';
          if (totalHours) totalHours.textContent = '0';
          if (playersTodayList) playersTodayList.innerHTML = '<p><i class="fas fa-spinner fa-spin"></i> Cargando...</p>';
        
          try {
            // Obtener datos del club
            const { data: clubData, error: clubError } = await window.supabase
              .from('clubs')
              .select('*')
              .eq('id', window.currentUser.id)
              .single();
        
            if (clubError) {
              console.error("Error al obtener datos del club:", clubError);
              if (courtsGrid) courtsGrid.innerHTML = '<i class="fas fa-exclamation-circle"></i> Error al cargar datos';
              return;
            }
        
            if (!clubData) {
              if (courtsGrid) courtsGrid.innerHTML = '<i class="fas fa-exclamation-circle"></i> Error al cargar datos';
              return;
            }
        
            // Guardar datos del club
            window.currentClub = clubData;
            
            // Actualizar nombre del club solo si es necesario
            if (clubNameDisplay && clubNameDisplay.textContent !== clubData.name) {
              clubNameDisplay.textContent = clubData.name || "Club";
            }
        
            // Obtener partidos del d√≠a
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const tomorrow = new Date(today);
            tomorrow.setDate(tomorrow.getDate() + 1);
        
            const { data: matchesData, error: matchesError } = await window.supabase
              .from('matches')
              .select('*')
              .eq('club_id', window.currentUser.id)
              .gte('created_at', today.toISOString())
              .lt('created_at', tomorrow.toISOString());
        
            if (matchesError) {
              console.error("Error al cargar partidos:", matchesError);
            }
        
            const totalMatchCount = matchesData?.length || 0;
            if (totalMatches) totalMatches.textContent = totalMatchCount;
        
            // Calcular horas jugadas (promedio de 45 min por partido)
            const totalHoursCount = Math.round((totalMatchCount * 45) / 60 * 100) / 100;
            if (totalHours) totalHours.textContent = totalHoursCount;
        
            // Obtener jugadores activos (√∫ltima semana)
            const lastWeek = new Date(today);
            lastWeek.setDate(today.getDate() - 7);
            
            // Para jugadores activos, necesitamos consultar la tabla de players
            const { data: activePlayersData, error: activePlayersError } = await window.supabase
              .from('players')
              .select('id')
              .eq('club_id', window.currentUser.id)
              .gte('last_match_date', lastWeek.toISOString());
        
            if (activePlayersError) {
              console.error("Error al obtener jugadores activos:", activePlayersError);
            } else {
              const activePlayerCount = activePlayersData?.length || 0;
              if (activePlayers) activePlayers.textContent = activePlayerCount;
            }
        
            // Jugador del d√≠a (m√°s victorias hoy)
            if (matchesData && matchesData.length > 0) {
              // Obtener todos los IDs de partidos de hoy
              const matchIds = matchesData.map(match => match.id);
        
              if (matchIds.length > 0) {
                // Obtener las relaciones de jugadores en partidos de hoy
                const { data: matchPlayersData, error: matchPlayersError } = await window.supabase
                  .from('match_players')
                  .select(`
                    match_id,
                    player_id,
                    team,
                    matches!inner(winner)
                  `)
                  .in('match_id', matchIds);
        
                if (matchPlayersError) {
                  console.error("Error al obtener jugadores de partidos:", matchPlayersError);
                  if (playersTodayList) playersTodayList.innerHTML = '<p>Error al cargar jugadores</p>';
                } else {
                  // Contar victorias por jugador
                  const playerWins = {};
        
                  matchPlayersData.forEach(mp => {
                    const match = mp.matches;
                    if (match && match.winner) {
                      // Determinar si el jugador estaba en el equipo ganador
                      const winningTeam = match.winner === 'teamA' ? 'A' : 'B';
                      if (mp.team === winningTeam) {
                        playerWins[mp.player_id] = (playerWins[mp.player_id] || 0) + 1;
                      }
                    }
                  });
        
                  // Encontrar al jugador con m√°s victorias
                  let topPlayerId = null;
                  let maxWins = 0;
                  for (const [playerId, wins] of Object.entries(playerWins)) {
                    if (wins > maxWins) {
                      maxWins = wins;
                      topPlayerId = playerId;
                    }
                  }
        
                  // Obtener informaci√≥n del jugador
                  if (topPlayerId) {
                    const { data: topPlayer, error: topPlayerError } = await window.supabase
                      .from('players')
                      .select('first_name, last_name')
                      .eq('id', topPlayerId)
                      .single();
        
                    if (topPlayerError) {
                      console.error("Error al obtener jugador:", topPlayerError);
                      if (playersTodayList) playersTodayList.innerHTML = '<p>Error al cargar jugador</p>';
                    } else {
                      if (playersTodayList) playersTodayList.innerHTML = `
                        <div style="background: #E8F5E9; padding: 12px; border-radius: 12px; font-size: 14px;">
                          <strong>üèÜ Jugador del d√≠a:</strong> ${topPlayer.first_name} ${topPlayer.last_name}<br>
                          <small>Victorias hoy: ${maxWins}</small>
                        </div>
                      `;
                    }
                  } else {
                    if (playersTodayList) playersTodayList.innerHTML = '<p>No hay jugadores con victorias hoy</p>';
                  }
                }
              } else {
                if (playersTodayList) playersTodayList.innerHTML = '<p>No hay partidos hoy</p>';
              }
            } else {
              if (playersTodayList) playersTodayList.innerHTML = '<p>No hay partidos hoy</p>';
            }
        
            // ‚úÖ Gr√°fico de uso de canchas
            const ctx = document.getElementById('courtsChart');
            if (ctx && matchesData) {
              const courtCounts = {};
              matchesData.forEach(match => {
                const court = match.court || 'Cancha desconocida';
                courtCounts[court] = (courtCounts[court] || 0) + 1;
              });
            
              const labels = Object.keys(courtCounts);
              const data = Object.values(courtCounts);
            
              // Destruir gr√°fico anterior si existe
              if (window.courtsChart && typeof window.courtsChart.destroy === 'function') {
                window.courtsChart.destroy();
              }
            
              // Crear nuevo gr√°fico
              window.courtsChart = new Chart(ctx, {
                type: 'bar',
                data: {
                  labels: labels,
                  datasets: [{
                    label: 'Partidos jugados',
                    data: data,
                    backgroundColor: '#016B3A',
                    borderRadius: 4
                  }]
                },
                options: {
                  responsive: true,
                  plugins: { legend: { display: false } },
                  scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } }
                }
              });
            }
        
            // Mostrar canchas del club
            const courtCount = window.safeNumber(clubData.court_count, 0);
            if (courtCount <= 0) {
              if (courtsGrid) courtsGrid.innerHTML = `
                <div class="alert" style="margin: 20px auto; width: 90%;">
                  <i class="fas fa-exclamation-circle"></i> <strong>Importante:</strong> No existen canchas cargadas para este club.
                </div>
                <button class="btn btn-blue" onclick="window.goToScreen('club-settings')">
                  <i class="fas fa-cog"></i> Configurar canchas
                </button>
              `;
            } else {
              // Cargar las canchas en la pantalla de inicio
              window.loadHomeCourts();
            }
        
          } catch (error) {
            console.error("Error cr√≠tico al actualizar pantalla de inicio:", error);
            if (courtsGrid) courtsGrid.innerHTML = '<i class="fas fa-exclamation-circle"></i> Error cr√≠tico';
          }
        };

        // Actualizar nombres de equipos en el marcador
        window.updateTeamNamesDisplay = function() {
          const teamAName = document.getElementById('teamA-name')?.value;
          const teamBName = document.getElementById('teamB-name')?.value;
          window.teamNames.teamA = teamAName || "Equipo A";
          window.teamNames.teamB = teamBName || "Equipo B";
          
          const teamAElement = document.getElementById('teamA-display');
          const teamBElement = document.getElementById('teamB-display');
          
          if (teamAElement) teamAElement.textContent = window.teamNames.teamA;
          if (teamBElement) teamBElement.textContent = window.teamNames.teamB;
        };

        // Funci√≥n para cargar las canchas en la pantalla de inicio
        window.loadHomeCourts = function() {
          const courtsGrid = document.getElementById('courts-grid');
          if (!courtsGrid || !window.currentClub) return;
          
          const courtCount = window.safeNumber(window.currentClub.court_count, 0);
          courtsGrid.innerHTML = '';
          
          if (courtCount <= 0) {
            courtsGrid.innerHTML = '<p>No hay canchas configuradas</p>';
            return;
          }
          
          // Obtener datos de uso de canchas para mostrar estado
          window.supabase
            .from('court_usage')
            .select('*')
            .eq('club_id', window.currentUser.id)
            .then(({ data, error }) => {
              const courtUsage = {};
              if (data) {
                data.forEach(court => {
                  courtUsage[court.court] = court.match_count || 0;
                });
              }
              
              // Crear tarjetas de canchas
              for (let i = 1; i <= courtCount; i++) {
                const courtName = `Cancha ${i}`;
                const matchCount = courtUsage[courtName] || 0;
                
                const courtCard = document.createElement('div');
                courtCard.className = 'court-card';
                
                let statusClass = 'status-available';
                let statusText = 'Disponible';
                
                if (matchCount > 3) {
                  statusClass = 'status-busy';
                  statusText = 'Ocupada';
                } else if (matchCount > 5) {
                  statusClass = 'status-offline';
                  statusText = 'Mantenimiento';
                }
                
                courtCard.innerHTML = `
                  <div class="court-icon">
                    <i class="fas fa-table-tennis-paddle-ball"></i>
                  </div>
                  <h3>${courtName}</h3>
                  <span class="court-status ${statusClass}">${statusText}</span>
                  <div class="court-details">${matchCount} partidos hoy</div>
                `;
                
                courtsGrid.appendChild(courtCard);
              }
            });
        };        
		
        // Funci√≥n para cargar la pantalla de selecci√≥n de canchas
        window.loadHomeCourts = function() {
          const courtsGrid = document.getElementById('courts-grid');
          if (!courtsGrid || !window.currentClub) return;
          
          const courtCount = window.safeNumber(window.currentClub.court_count, 0);
          courtsGrid.innerHTML = '';
          
          if (courtCount <= 0) {
            courtsGrid.innerHTML = '<p>No hay canchas configuradas</p>';
            return;
          }
          
          // Obtener datos de uso de canchas para mostrar estado
          window.supabase
            .from('court_usage')
            .select('*')
            .eq('club_id', window.currentUser.id)
            .then(({ data, error }) => {
              const courtUsage = {};
              if (data) {
                data.forEach(court => {
                  courtUsage[court.court] = court.match_count || 0;
                });
              }
              
              // Crear tarjetas de canchas
              for (let i = 1; i <= courtCount; i++) {
                const courtName = `Cancha ${i}`;
                const matchCount = courtUsage[courtName] || 0;
                
                const courtCard = document.createElement('div');
                courtCard.className = 'court-card';
                
                let statusClass = 'status-available';
                let statusText = 'Disponible';
                
                if (matchCount > 3) {
                  statusClass = 'status-busy';
                  statusText = 'Ocupada';
                } else if (matchCount > 5) {
                  statusClass = 'status-offline';
                  statusText = 'Mantenimiento';
                }
                
                courtCard.innerHTML = `
                  <div class="court-icon">
                    <i class="fas fa-table-tennis-paddle-ball"></i>
                  </div>
                  <h3>${courtName}</h3>
                  <span class="court-status ${statusClass}">${statusText}</span>
                  <div class="court-details">${matchCount} partidos hoy</div>
                `;
                
                // Hacer que la tarjeta sea clickable para seleccionar la cancha
                courtCard.addEventListener('click', function() {
                  window.selectedCourt = courtName;
                  window.goToScreen('scoring-type');
                });
                
                courtsGrid.appendChild(courtCard);
              }
            });
        };

        // Funci√≥n para confirmar la selecci√≥n de cancha
        window.confirmCourtSelection = function() {
          const selectedCourt = document.querySelector('.court-option.selected');
          if (!selectedCourt) return;
          
          window.selectedCourt = selectedCourt.dataset.court;
          window.goToScreen('scoring-type');
        };
    
        // Seleccionar sistema de puntuaci√≥n
        window.selectScoring = function(type) {
          window.scoringType = type;
          // Resaltar selecci√≥n
          const traditionalOption = document.getElementById('traditional-option');
          const americanOption = document.getElementById('american-option');
          
          if (traditionalOption) traditionalOption.classList.remove('selected');
          if (americanOption) americanOption.classList.remove('selected');
          
          if (type === 'traditional' && traditionalOption) {
            traditionalOption.classList.add('selected');
          } else if (americanOption) {
            americanOption.classList.add('selected');
          }
          
          // Actualizar interfaz
          const btn = document.getElementById('continue-btn');
          if (btn) {
            btn.disabled = false;
            btn.classList.remove('btn-disabled');
            btn.innerHTML = '<i class="fas fa-play"></i> Continuar';
          }
          
          // Actualizar indicadores
          const indicator = document.getElementById('scoring-indicator');
          const modeDesc = document.getElementById('mode-description');
          
          if (indicator && modeDesc) {
            if (type === 'traditional') {
              indicator.innerHTML = '<i class="fas fa-info-circle"></i> Modo Tradicional';
              modeDesc.textContent = 'Sistema oficial de p√°del: Gana el set quien llegue a 6 juegos con diferencia de 2 (m√°ximo 7-5)';
            } else {
              indicator.innerHTML = '<i class="fas fa-info-circle"></i> Modo Americano';
              modeDesc.textContent = 'Sistema venezolano: Puntos acumulativos hasta 16 entre ambos equipos. En 8-8 se juega tiebreak a 7 puntos.';
            }
          }
        };
        
        // Continuar al registro
        window.goToRegister = function() {
          if (!window.scoringType) return;
          window.goToScreen('register');
        };
        
        // Convertir puntuaci√≥n seg√∫n sistema
        window.getDisplayScore = function(points) {
          if (window.scoringType === 'traditional' && !window.inTiebreak) {
            const traditionalPoints = ['0', '15', '30', '40', 'Game'];
            return traditionalPoints[points] || '40';
          }
          return points; // Modo americano o tiebreak
        };
        
        // Actualizar marcador visual
        window.updateScoreboard = function() {
          // Actualizar juegos ganados
          const gamesAElement = document.getElementById('gamesA');
          const gamesBElement = document.getElementById('gamesB');
          if (gamesAElement) gamesAElement.textContent = window.gamesA;
          if (gamesBElement) gamesBElement.textContent = window.gamesB;

          // Actualizar sets
          const setsAElement = document.getElementById('setsA');
          const setsBElement = document.getElementById('setsB');
          if (setsAElement) setsAElement.textContent = window.setsA;
          if (setsBElement) setsBElement.textContent = window.setsB;
          
          // Actualizar puntos actuales
          if (window.inTiebreak) {
            const scoreAElement = document.getElementById('scoreA');
            const scoreBElement = document.getElementById('scoreB');
            
            if (scoreAElement) scoreAElement.textContent = window.tiebreakPointsA;
            if (scoreBElement) scoreBElement.textContent = window.tiebreakPointsB;
            
            if (scoreAElement) scoreAElement.style.color = '#016B3A';
            if (scoreBElement) scoreBElement.style.color = '#016B3A';
            
            // Mostrar notificaci√≥n de tiebreak
            const tiebreakNotification = document.getElementById('tiebreak-notification');
            if (tiebreakNotification) tiebreakNotification.style.display = 'block';
          } else {
            const scoreAElement = document.getElementById('scoreA');
            const scoreBElement = document.getElementById('scoreB');
            
            if (scoreAElement) scoreAElement.textContent = window.getDisplayScore(window.scoreA);
            if (scoreBElement) scoreBElement.textContent = window.getDisplayScore(window.scoreB);
            
            if (scoreAElement) scoreAElement.style.color = '#D32F2F';
            if (scoreBElement) scoreBElement.style.color = '#1976D2';
            
            const tiebreakNotification = document.getElementById('tiebreak-notification');
            if (tiebreakNotification) tiebreakNotification.style.display = 'none';
          }
          
          // Resaltar ganador temporal
          if (window.scoringType === 'american') {
            // En modo americano, resaltar cuando hay ventaja
            const scoreAElement = document.getElementById('scoreA');
            const scoreBElement = document.getElementById('scoreB');
            
            if (window.scoreA > window.scoreB) {
              if (scoreAElement) scoreAElement.classList.add('winner');
              if (scoreBElement) scoreBElement.classList.add('loser');
            } else if (window.scoreB > window.scoreA) {
              if (scoreAElement) scoreAElement.classList.add('loser');
              if (scoreBElement) scoreBElement.classList.add('winner');
            } else {
              if (scoreAElement) scoreAElement.classList.remove('winner', 'loser');
              if (scoreBElement) scoreBElement.classList.remove('winner', 'loser');
            }
          } else if (window.scoringType === 'traditional') {
            // Resaltar juegos ganados
            const gamesAElement = document.getElementById('gamesA');
            const gamesBElement = document.getElementById('gamesB');
            
            if (window.gamesA > window.gamesB) {
              if (gamesAElement) gamesAElement.style.color = '#4CAF50';
              if (gamesBElement) gamesBElement.style.color = '#D32F2F';
            } else if (window.gamesB > window.gamesA) {
              if (gamesAElement) gamesAElement.style.color = '#D32F2F';
              if (gamesBElement) gamesBElement.style.color = '#4CAF50';
            } else {
              if (gamesAElement) gamesAElement.style.color = '#666';
              if (gamesBElement) gamesBElement.style.color = '#666';
            }
          }
        };
        
        // Manejar puntos en modo tradicional
        window.addTraditionalPoint = function(team) {
			// ‚úÖ Validaci√≥n: si el partido ya termin√≥, no hacer nada
			if (window.gameEnded) {
			    return;
			}            
			// Si est√° en tiebreak, manejar puntos de tiebreak
            if (window.inTiebreak) {
                if (team === 'A') window.tiebreakPointsA++;
                else window.tiebreakPointsB++;
        
                const diff = Math.abs(window.tiebreakPointsA - window.tiebreakPointsB);
                if ((window.tiebreakPointsA >= 7 || window.tiebreakPointsB >= 7) && diff >= 2) {
                    if (window.tiebreakPointsA > window.tiebreakPointsB) {
                        window.gamesA = 7;
                        window.gamesB = 6;
                    } else {
                        window.gamesA = 6;
                        window.gamesB = 7;
                    }
                    window.completeSet();
                    return;
                }
                window.updateScoreboard();
                return;
            }
        
            // --- L√ìGICA: ¬øEl punto actual gana el juego? ---
            let gameWon = false;
            let gameWinner = '';
        
            // Caso 1: Alguien llega a 40 y tiene ventaja (40-0, 40-15, 40-30)
            if (window.scoreA === 3 && window.scoreB <= 2 && team === 'A') {
                gameWon = true;
                gameWinner = 'A';
            } else if (window.scoreB === 3 && window.scoreA <= 2 && team === 'B') {
                gameWon = true;
                gameWinner = 'B';
            }
        
            // Caso 2: 40-40 ‚Üí el siguiente punto gana el juego
            if (window.scoreA === 3 && window.scoreB === 3) {
                gameWon = true;
                gameWinner = team;
            }
        
            if (gameWon) {
                // Referencias a los elementos del marcador
                const scoreAElement = document.getElementById('scoreA');
                const scoreBElement = document.getElementById('scoreB');
        
                // Mostrar "Game" temporalmente
                if (scoreAElement) {
                    scoreAElement.textContent = gameWinner === 'A' ? 'Game' : window.getDisplayScore(window.scoreA);
                    if (gameWinner === 'A') scoreAElement.style.fontWeight = 'bold';
                }
                if (scoreBElement) {
                    scoreBElement.textContent = gameWinner === 'B' ? 'Game' : window.getDisplayScore(window.scoreB);
                    if (gameWinner === 'B') scoreBElement.style.fontWeight = 'bold';
                }
        
                // Sumar el juego al equipo ganador
                if (gameWinner === 'A') {
                    window.gamesA++;
                } else {
                    window.gamesB++;
                }
        
                // Reiniciar puntos inmediatamente
                window.scoreA = 0;
                window.scoreB = 0;
        
                // Volver a mostrar "0" despu√©s de 800ms
                setTimeout(() => {
                    window.updateScoreboard();
                }, 800);
        
                // Verificar si termina el set
                const minWinGames = 6;
                const maxGame = 7;
                const minDiff = 2;
        
                // Caso 1: Gana con 6 juegos (6-0, 6-1, 6-2, 6-3, 6-4)
                if ((window.gamesA === minWinGames && window.gamesB <= minWinGames - minDiff) ||
                    (window.gamesB === minWinGames && window.gamesA <= minWinGames - minDiff)) {
                    window.completeSet();
                    return;
                }
        
                // Caso 2: Gana con 7-5
                else if ((window.gamesA === maxGame && window.gamesB === maxGame - minDiff) ||
                         (window.gamesB === maxGame && window.gamesA === maxGame - minDiff)) {
                    window.completeSet();
                    return;
                }
        
                // Caso 3: 6-6 ‚Üí activar tiebreak
                else if (window.gamesA === 6 && window.gamesB === 6) {
                    window.inTiebreak = true;
                    window.showNotification('¬°Tiebreak activado! Juega a 7 puntos');
                    window.updateScoreboard();
                    return;
                }
        
                // Si no termin√≥ el set, simplemente seguimos
                return;
            }
        
            // Si no se gan√≥ el juego, solo sumar el punto
            if (team === 'A') {
                window.scoreA++;
            } else {
                window.scoreB++;
            }
        
            // Actualizar marcador inmediatamente
            window.updateScoreboard();
        };

        // Manejar puntos en modo americano
        window.addAmericanPoint = function(team) {
          // Si estamos en tiebreak
          if (window.inTiebreak) {
            // Manejar puntos de tiebreak
            if (team === 'A') window.tiebreakPointsA++;
            else window.tiebreakPointsB++;
            // Verificar si termina el tiebreak
            const diff = Math.abs(window.tiebreakPointsA - window.tiebreakPointsB);
            if ((window.tiebreakPointsA >= 7 || window.tiebreakPointsB >= 7) && diff >= 2) {
              // El ganador del tiebreak gana el partido
              window.finalizeGame();
            }
            window.updateScoreboard();
            return;
          }
          // Modo normal
          if (team === 'A') window.scoreA++;
          else window.scoreB++;
          // Calcular puntos totales acumulados
          const totalPoints = window.scoreA + window.scoreB;
          // Verificar si termina el juego normal (16 puntos acumulados)
          if (totalPoints === 16) {
            window.finalizeGame();
            return;
          }
          // Verificar si empieza el tiebreak (8-8)
          if (window.scoreA === 8 && window.scoreB === 8) {
            window.inTiebreak = true;
            window.showNotification('¬°Tiebreak activado! Juega a 7 puntos');
          }
          window.updateScoreboard();
        };
        
        // Manejar puntos
        window.addPoint = function(team) {
          if (window.scoringType === 'traditional') {
            window.addTraditionalPoint(team);
          } else {
            window.addAmericanPoint(team);
          }
        };
        
        window.subPoint = function(team) {
          if (window.scoringType === 'traditional') {
            if (window.inTiebreak) {
              // Restar puntos en tiebreak tradicional
              if (team === 'A' && window.tiebreakPointsA > 0) window.tiebreakPointsA--;
              if (team === 'B' && window.tiebreakPointsB > 0) window.tiebreakPointsB--;
            } else {
              // Restar puntos en modo tradicional
              if (team === 'A' && window.scoreA > 0) window.scoreA--;
              if (team === 'B' && window.scoreB > 0) window.scoreB--;
            }
          } else {
            // Modo americano
            if (window.inTiebreak) {
              // Restar puntos en tiebreak americano
              if (team === 'A' && window.tiebreakPointsA > 0) window.tiebreakPointsA--;
              if (team === 'B' && window.tiebreakPointsB > 0) window.tiebreakPointsB--;
            } else {
              // Restar puntos en modo americano normal
              if ((team === 'A' && window.scoreA > 0) || (team === 'B' && window.scoreB > 0)) {
                if (team === 'A') window.scoreA--;
                else window.scoreB--;
              }
            }
          }
          // Limpiar clases de ganador
          const scoreAElement = document.getElementById('scoreA');
          const scoreBElement = document.getElementById('scoreB');
          
          if (scoreAElement) scoreAElement.classList.remove('winner', 'loser');
          if (scoreBElement) scoreBElement.classList.remove('winner', 'loser');
          
          window.updateScoreboard();
        };
        
        // Temporizador
        const gameScreen = document.getElementById('game');
        if (gameScreen) {
          gameScreen.addEventListener('click', function() {
            if (!window.interval) {
              window.interval = setInterval(() => {
                window.seconds++;
                const mins = Math.floor(window.seconds / 60).toString().padStart(2, '0');
                const secs = (window.seconds % 60).toString().padStart(2, '0');
                const timerElement = document.getElementById('timer');
                if (timerElement) {
                  timerElement.textContent = `${mins}:${secs}`;
                }
                window.gameDuration = `${mins}m ${secs}s`;
              }, 1000);
            }
          });
        }

		// Validar c√©dula (buscar en Supabase)
		window.validateCedula = async function(input) {
		  // Obtener el contenedor .cedula-input
		  const container = input.closest('.cedula-input');
		  if (!container) return;
		
		  // Obtener los elementos
		  const typeSelect = container.querySelector('.cedula-type');
		  const numberInput = container.querySelector('.cedula-number');
		
		  // Extraer datos del jugador
		  const team = input.dataset.team;
		  const player = input.dataset.player;
		  const id = team + player;
		
		  // Elementos de UI
		  const statusElement = document.getElementById(`cedula-status-${id}`);
		  const playerStatusElement = document.getElementById(`player-status-${id}`);
		  const errorElement = document.getElementById(`error-${id}`);
		
		  // Limpiar estado previo
		  if (statusElement) {
		    statusElement.innerHTML = '';
		    statusElement.className = 'cedula-validation loading';
		  }
		  if (playerStatusElement) {
		    playerStatusElement.textContent = 'Validando...';
		  }
		  if (errorElement) {
		    errorElement.style.display = 'none';
		  }
		
		  // Obtener valores
		  const type = typeSelect?.value?.trim();
		  const number = numberInput?.value?.trim();
		
		  // Validar que ambos est√©n completos
		  if (!type || !number) {
		    if (statusElement) {
		      statusElement.innerHTML = '<i class="fas fa-exclamation-circle"></i>';
		      statusElement.className = 'cedula-validation invalid';
		    }
		    if (playerStatusElement) {
		      playerStatusElement.textContent = 'Completa tipo y n√∫mero';
		    }
		    // Limpiar datos del jugador
		    window.playersData[id] = { cedula: '', firstName: '', lastName: '', exists: false };
		    return;
		  }
		
		  // Validar que el n√∫mero tenga entre 7 y 8 d√≠gitos
		  if (!/^\d{7,8}$/.test(number)) {
		    if (statusElement) {
		      statusElement.innerHTML = '<i class="fas fa-exclamation-circle"></i>';
		      statusElement.className = 'cedula-validation invalid';
		    }
		    if (playerStatusElement) {
		      playerStatusElement.textContent = '7-8 d√≠gitos requeridos';
		    }
		    window.playersData[id] = { cedula: '', firstName: '', lastName: '', exists: false };
		    return;
		  }
		
		  // ‚úÖ Construir c√©dula final
		  const cedula = `${type.toUpperCase()}-${number}`;
		
		  // Guardar en playersData
		  window.playersData[id] = {
		    ...(window.playersData[id] || {}),
		    cedula: cedula
		  };
		
		  // Mostrar estado de carga
		  if (statusElement) {
		    statusElement.innerHTML = '<i class="fas fa-spinner"></i>';
		    statusElement.className = 'cedula-validation loading';
		  }
		
		  try {
		    // Buscar jugador en Supabase (solo en el club actual)
		    const { data, error } = await window.supabase
		      .from('players')
		      .select('*')
		      .eq('cedula', cedula)
		      .eq('club_id', window.currentUser.id)
		      .single();
		
		    if (error) {
		      if (error.code === 'PGRST116') {
		        // Jugador no encontrado ‚Üí nuevo
		        if (statusElement) {
		          statusElement.innerHTML = '<i class="fas fa-user-plus"></i>';
		          statusElement.className = 'cedula-validation valid';
		        }
		        if (playerStatusElement) {
		          playerStatusElement.textContent = 'Nuevo jugador en este club';
		        }
		
		        // Habilitar campos de nombre y apellido
		        const firstNameInput = document.querySelector(`.first-name[data-team="${team}"][data-player="${player}"]`);
		        const lastNameInput = document.querySelector(`.last-name[data-team="${team}"][data-player="${player}"]`);
		        if (firstNameInput && lastNameInput) {
		          firstNameInput.disabled = false;
		          lastNameInput.disabled = false;
		          firstNameInput.focus(); // Poner foco en el primer campo
		        } else {
		          console.warn(`No se encontraron campos de nombre y apellido para ${team}${player}`);
		        }		        
		
		        // Guardar datos
		        window.playersData[id] = {
		          cedula: cedula,
		          firstName: '',
		          lastName: '',
		          exists: false
		        };
		      } else {
		        console.error("Error al validar c√©dula:", error);
		        if (statusElement) {
		          statusElement.innerHTML = '<i class="fas fa-exclamation-circle"></i>';
		          statusElement.className = 'cedula-validation invalid';
		        }
		        if (playerStatusElement) {
		          playerStatusElement.textContent = 'Error al verificar';
		        }
		        window.playersData[id] = { cedula: '', firstName: '', lastName: '', exists: false };
		      }
		      return;
		    }
		
		    // Jugador existe
		    if (statusElement) {
		      statusElement.innerHTML = '<i class="fas fa-check-circle"></i>';
		      statusElement.className = 'cedula-validation valid';
		    }
		    if (playerStatusElement) {
		      playerStatusElement.textContent = 'Jugador existente en este club';
		    }
		
		    // Rellenar y deshabilitar nombre y apellido
		    const firstNameInput = document.querySelector(`.first-name[data-team="${team}"][data-player="${player}"]`);
		    const lastNameInput = document.querySelector(`.last-name[data-team="${team}"][data-player="${player}"]`);
		    if (firstNameInput) {
		      firstNameInput.value = data.first_name || '';
		      firstNameInput.disabled = true;
		    }
		    if (lastNameInput) {
		      lastNameInput.value = data.last_name || '';
		      lastNameInput.disabled = true;
		    }
		
		    // Guardar datos
		    window.playersData[id] = {
		      cedula: cedula,
		      firstName: data.first_name || '',
		      lastName: data.last_name || '',
		      exists: true
		    };
		
		  } catch (err) {
		    console.error("Error inesperado al validar c√©dula:", err);
		    if (statusElement) {
		      statusElement.innerHTML = '<i class="fas fa-exclamation-circle"></i>';
		      statusElement.className = 'cedula-validation invalid';
		    }
		    if (playerStatusElement) {
		      playerStatusElement.textContent = 'Error';
		    }
		    window.playersData[id] = { cedula: '', firstName: '', lastName: '', exists: false };
		  }
		};

        // Resetear validaci√≥n de jugadores
        window.resetPlayerValidation = function() {
          // Limpiar datos en memoria
          Object.keys(window.playersData).forEach(key => {
            window.playersData[key] = { cedula: '', firstName: '', lastName: '', exists: false };
          });
        
          // Limpiar campos de c√©dula
          document.querySelectorAll('.cedula-type').forEach(select => {
            select.value = '';
          });
          document.querySelectorAll('.cedula-number').forEach(input => {
            input.value = '';
            const id = input.dataset.team + input.dataset.player;
            const statusElement = document.getElementById(`cedula-status-${id}`);
            const playerStatusElement = document.getElementById(`player-status-${id}`);
            const errorElement = document.getElementById(`error-${id}`);
            
            if (statusElement) statusElement.innerHTML = '';
            if (playerStatusElement) playerStatusElement.textContent = '';
            if (errorElement) errorElement.style.display = 'none';																 
          });
        
          // Limpiar nombres y apellidos
          document.querySelectorAll('.first-name, .last-name').forEach(input => {
            input.value = '';
            input.disabled = true;
          });
		  
          // Limpiar estado visual: iconos y mensajes
          document.querySelectorAll('.cedula-validation').forEach(el => {
            el.innerHTML = '';
            el.className = 'cedula-validation';
          });
          document.querySelectorAll('.player-status').forEach(el => {
            el.textContent = '';
          });
          document.querySelectorAll('.error-message').forEach(el => {
            el.style.display = 'none';
          });
        
          console.log("Campos de jugadores reseteados correctamente");
        };
        
        // Validar formato del RIF venezolano
        window.validateRifFormat = function(rif) {
          // Formato RIF venezolano: J-12345678-9
          const rifRegex = /^[JjGg]-\d{8}-\d$/;
          return rifRegex.test(rif);
        };


        // Funci√≥n para limpiar completamente el formulario de registro
        function resetRegistrationForm() {
          // Limpiar todos los campos del formulario
          document.getElementById('club-name').value = '';

          // ‚úÖ Limpiar nuevos campos de RIF
          const rifType = document.getElementById('rif-type');
          const rifNumber = document.getElementById('rif-number');
          if (rifType) rifType.value = '';
          if (rifNumber) rifNumber.value = '';

          document.getElementById('court-count').value = '';
          document.getElementById('register-email').value = '';
          document.getElementById('phone-prefix').value = '';
          document.getElementById('phone-suffix').value = '';
          document.getElementById('register-password').value = '';
          document.getElementById('register-confirm').value = '';
          
          // Tambi√©n limpiar cualquier estado interno de validaci√≥n
          const statusElements = document.querySelectorAll('.cedula-validation, .player-status, .error-message');
          statusElements.forEach(el => {
            el.textContent = '';
            el.className = el.className.replace(/valid|invalid|loading/g, '');
          });
          
          // Deshabilitar campos de nombre y apellido
          document.querySelectorAll('.first-name, .last-name').forEach(input => {
            input.value = '';
            input.disabled = true;
          });
          
          // Resetear el objeto de datos de jugadores
          window.playersData = {
            'A1': { cedula: '', firstName: '', lastName: '', exists: false },
            'A2': { cedula: '', firstName: '', lastName: '', exists: false },
            'B1': { cedula: '', firstName: '', lastName: '', exists: false },
            'B2': { cedula: '', firstName: '', lastName: '', exists: false }
          };
          
          console.log("Formulario de registro limpiado completamente");
        }

        // Funci√≥n para registrar un nuevo club - Versi√≥n optimizada y corregida

        window.registerClub = async function() {
          // Obtener elementos del DOM
          const clubNameInput = document.getElementById('club-name');
          const courtCountInput = document.getElementById('court-count');
          const emailInput = document.getElementById('register-email');
          const passwordInput = document.getElementById('register-password');
          const confirmPasswordInput = document.getElementById('register-confirm');
        
          const phonePrefixInput = document.getElementById('phone-prefix');
          const phoneSuffixInput = document.getElementById('phone-suffix');
        
          const rifTypeSelect = document.getElementById('rif-type');
          const rifNumberInputField = document.getElementById('rif-number');
        
          // Validar que todos los elementos existan
          if (!clubNameInput || !courtCountInput || !emailInput || !passwordInput || 
              !confirmPasswordInput || !phonePrefixInput || !phoneSuffixInput || 
              !rifTypeSelect || !rifNumberInputField) {
            window.showNotification('Error: Algunos campos no se encontraron. Recarga la p√°gina.');
            console.error('Faltan elementos del DOM');
            return;
          }
        
          // Obtener valores
          const clubName = clubNameInput.value?.trim() || '';
          const courtCountStr = courtCountInput.value?.trim() || '';
          const email = emailInput.value?.trim() || '';
          const password = passwordInput.value || '';
          const confirmPassword = confirmPasswordInput.value || '';
        
          const phonePrefix = phonePrefixInput.value?.trim() || '';
          const phoneSuffix = phoneSuffixInput.value?.trim() || '';
        
          const rifType = rifTypeSelect.value?.trim();
        
          let phone = '';
          let clubRif = '';
        
          // Validaciones iniciales de campos obligatorios
          if (!clubName || !courtCountStr || !email || !password || !confirmPassword) {
            window.showNotification('Por favor, completa todos los campos requeridos');
            return;
          }
        
          // Validar tel√©fono
          if ((phonePrefix && !phoneSuffix) || (!phonePrefix && phoneSuffix)) {
            window.showNotification('Por favor, completa ambos campos del n√∫mero de tel√©fono');
            return;
          }
        
          if (phonePrefix && phoneSuffix) {
            if (!/^\d{7}$/.test(phoneSuffix)) {
              window.showNotification('El n√∫mero final debe tener exactamente 7 d√≠gitos');
              return;
            }
            phone = `${phonePrefix}-${phoneSuffix}`;
          }
        
          // Validar y construir RIF
          if (!rifType || !rifNumberStr) {
            window.showNotification('Por favor, selecciona el tipo (J/G) y escribe el n√∫mero del RIF');
            return;
          }
        
          const rifNumberStr = rifNumberInputField.value?.trim();
          if (!rifNumberStr || rifNumberStr.length < 8 || rifNumberStr.length > 9) {
            window.showNotification('El n√∫mero del RIF debe tener entre 8 y 9 d√≠gitos');
            return;
          }
        
          clubRif = `${rifType.toUpperCase()}-${rifNumber}`;
        
          // Validar cantidad de canchas
          const courts = parseInt(courtCountStr, 10);
          if (isNaN(courts) || courts < 1 || courts > 20) {
            window.showNotification('La cantidad de canchas debe ser entre 1 y 20');
            return;
          }
        
          // Validar contrase√±as
          if (password !== confirmPassword) {
            window.showNotification('Las contrase√±as no coinciden');
            return;
          }
        
          if (password.length < 6) {
            window.showNotification('La contrase√±a debe tener al menos 6 caracteres');
            return;
          }
        
          // Mostrar estado de carga
          const registerBtn = document.querySelector('#register-screen .btn');
          const originalBtnText = registerBtn?.innerHTML || 'Registrar';
          if (registerBtn) {
            registerBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Verificando...';
            registerBtn.disabled = true;
          }
        
          try {
            // 1. VERIFICACI√ìN DEL RIF
            console.log("Verificando RIF:", clubRif);
            const rifToCheck = clubRif;
        
            const { data: existingClub, error: checkError } = await window.supabase
              .from('clubs')
              .select('rif')
              .eq('rif', rifToCheck)
              .maybeSingle();
        
            if (checkError) {
              console.error("Error al verificar RIF:", checkError);
              if (checkError.code === '42501' || checkError.message.includes('permission')) {
                window.showNotification('Error de permisos. Contacta al administrador.');
              } else {
                window.showNotification('Error al verificar el RIF. Intenta nuevamente.');
              }
              if (registerBtn) resetButton(registerBtn, originalBtnText);
              return;
            }
        
            if (existingClub) {
              console.log("RIF ya existe:", existingClub);
              window.showNotification('Este RIF ya est√° registrado en nuestro sistema');
              resetRegistrationForm();
              if (registerBtn) resetButton(registerBtn, originalBtnText);
              return;
            }
        
            // 2. Verificar si el email ya existe
            console.log("Verificando email:", email);
            if (registerBtn) {
              registerBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Verificando email...';
            }
        
            const { data: existingEmail, error: emailError } = await window.supabase
              .from('clubs')
              .select('email')
              .eq('email', email)
              .maybeSingle();
        
            if (emailError) {
              console.error("Error al verificar email:", emailError);
              window.showNotification('Error al verificar el email. Intenta nuevamente.');
              if (registerBtn) resetButton(registerBtn, originalBtnText);
              return;
            }
        
            if (existingEmail) {
              console.log("Email ya existe:", existingEmail);
              window.showNotification('Este correo electr√≥nico ya est√° registrado');
              if (registerBtn) resetButton(registerBtn, originalBtnText);
              return;
            }
        
            // 3. Registrar usuario en Supabase Auth
            if (registerBtn) {
              registerBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Creando cuenta...';
            }
        
            const { data, error } = await window.supabase.auth.signUp({
              email: email,
              password: password
            });
        
            if (error) {
              console.error("Error al registrar usuario:", error);
              if (error.message.includes('email already exists')) {
                window.showNotification('Este correo electr√≥nico ya est√° registrado');
              } else {
                window.showNotification(`Error: ${error.message}`);
              }
              if (registerBtn) resetButton(registerBtn, originalBtnText);
              return;
            }
        
            if (!data.user) {
              window.showNotification('Verifica tu correo electr√≥nico para completar el registro');
              if (registerBtn) resetButton(registerBtn, originalBtnText);
              return;
            }
        
            // 4. Crear club en la tabla clubs
            if (registerBtn) {
              registerBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Guardando informaci√≥n...';
            }
        
            const clubData = {
              id: data.user.id,
              rif: clubRif,
              name: clubName,
              court_count: courts,
              email: email,
              phone: phone || '000-0000',
              status: "active"
            };
        
            console.log("Datos a insertar en clubs:", clubData);
        
            const { error: clubError } = await window.supabase
              .from('clubs')
              .insert([clubData]);
        
            if (clubError) {
              console.error("Error al crear club:", clubError);
              try {
                await window.supabase.auth.signOut();
              } catch (authError) {
                console.error("Error al cerrar sesi√≥n:", authError);
              }
        
              if (clubError.code === '23505') {
                window.showNotification('Este RIF ya est√° registrado. Por favor, usa un RIF diferente.');
                resetRegistrationForm();
              } else if (clubError.code === '42501') {
                window.showNotification('Error de permisos. Contacta al administrador del sistema.');
              } else if (clubError.code === '23502') {
                window.showNotification('Error: Faltan campos obligatorios en el registro');
              } else {
                window.showNotification(`Error al registrar club: ${clubError.message}`);
              }
        
              if (registerBtn) resetButton(registerBtn, originalBtnText);
              return;
            }
        
            // 5. √âxito
            window.currentUser = data.user;
            const clubNameWelcome = document.getElementById('club-name-welcome');
            if (clubNameWelcome) {
              clubNameWelcome.textContent = clubName;
            }
        
            window.showNotification('¬°Club registrado exitosamente!');
            if (registerBtn) resetButton(registerBtn, originalBtnText);
        
            setTimeout(() => {
              window.goToScreen('welcome');
            }, 100);
        
          } catch (error) {
            console.error("Error inesperado al registrar club:", error);
            window.showNotification(`Error inesperado: ${error.message}`);
            const registerBtn = document.querySelector('#register-screen .btn');
            if (registerBtn) resetButton(registerBtn, originalBtnText);
          }
        };
        
        // Funci√≥n auxiliar para resetear el bot√≥n (si no existe)
        function resetButton(button, originalText) {
          button.innerHTML = originalText;
          button.disabled = false;
        }


        // Iniciar sesi√≥n
        window.loginUser = async function() {
          const email = document.getElementById('login-email')?.value;
          const password = document.getElementById('login-password')?.value;
          
          // Validar que se hayan ingresado ambos campos
          if (!email || !password) {
            window.showNotification('Por favor, ingresa tu correo electr√≥nico y contrase√±a');
            return;
          }
          
          const { data, error } = await window.supabase.auth.signInWithPassword({
            email: email,
            password: password
          });
          
          if (error) {
            if (error.message === 'Invalid login credentials') {
              // Verificar si el usuario existe antes de mostrar el mensaje
              const { data: userData, error: userError } = await window.supabase
                .from('clubs')
                .select('email')
                .eq('email', email)
                .maybeSingle();
              
              if (userError) {
                console.error("Error al verificar usuario:", userError);
                window.showNotification('Error al verificar credenciales. Intenta nuevamente.');
              } else if (userData) {
                // El usuario existe pero la contrase√±a es incorrecta
                window.showNotification('Contrase√±a incorrecta. Por favor, intenta nuevamente.');
              } else {
                // El usuario no existe
                window.showNotification('A√∫n no perteneces a la comunidad PadelTrack, ¬°Reg√≠strate!');
              }
            } else {
              window.showNotification(`Error: ${error.message}`);
            }			
            return;
          }
          
          window.currentUser = data.user;
          window.showNotification('¬°Inicio de sesi√≥n exitoso!');
          window.goToScreen('home');
        };
        
        // Restablecer contrase√±a
        window.resetPassword = async function() {
          const email = document.getElementById('login-email')?.value;
          
          if (!email) {
            window.showNotification('Por favor, ingresa tu correo electr√≥nico');
            return;
          }
          
          const { error } = await window.supabase.auth.resetPasswordForEmail(email, {
            redirectTo: 'https://tu-dominio.com/reset-password'
          });
          
          if (error) {
            window.showNotification(`Error: ${error.message}`);
          } else {
            window.showNotification('Revisa tu correo para restablecer tu contrase√±a');
          }
        };
        
        // Cerrar sesi√≥n
        window.logoutUser = async function() {
            const { error } = await window.supabase.auth.signOut();
            if (error) {
                window.showNotification(`Error al cerrar sesi√≥n: ${error.message}`);
            } else {
                // Limpiar variables
                window.currentUser = null;
                window.currentClub = null;
        
                // Limpiar formularios de login y registro
                const loginEmail = document.getElementById('login-email');
                const loginPassword = document.getElementById('login-password');
                const registerName = document.getElementById('club-name');
                const registerRif = document.getElementById('club-rif');
                const registerCourts = document.getElementById('court-count');
                const registerEmail = document.getElementById('register-email');
                const registerPhone = document.getElementById('phone-number'); // ‚ö†Ô∏è Eliminar si ya no existe
                const registerPassword = document.getElementById('register-password');
                const registerConfirm = document.getElementById('register-confirm');
        
                // Limpiar campos si existen
                if (loginEmail) loginEmail.value = '';
                if (loginPassword) loginPassword.value = '';
                if (registerName) registerName.value = '';
                if (registerRif) registerRif.value = '';
                if (registerCourts) registerCourts.value = '';
                if (registerEmail) registerEmail.value = '';
                if (registerPhone) registerPhone.value = ''; // Solo si a√∫n existe
                if (registerPassword) registerPassword.value = '';
                if (registerConfirm) registerConfirm.value = '';
        
                // Deshabilitar campos de nombres (como en el inicio)
                document.querySelectorAll('.first-name, .last-name').forEach(input => {
                    input.value = '';
                    input.disabled = true;
                });
        
                // Mostrar notificaci√≥n y navegar
                window.showNotification('¬°Sesi√≥n cerrada exitosamente!');
                window.goToScreen('login');
            }
        };

		// Iniciar temporizador del partido
		window.startTimer = function() {
		  if (window.interval) {
		    clearInterval(window.interval);
		  }
		
		  window.interval = setInterval(function() {
		    window.seconds++;
		    if (window.seconds >= 60) {
		      window.minutes++;
		      window.seconds = 0;
		    }
		
		    const timerElement = document.getElementById('timer');
		    if (timerElement) {
		      timerElement.textContent = `${window.minutes.toString().padStart(2, '0')}:${window.seconds.toString().padStart(2, '0')}`;
		    }
		
		    // Actualizar duraci√≥n del juego
		    window.gameDuration = `${window.minutes.toString().padStart(2, '0')}:${window.seconds.toString().padStart(2, '0')}`;
		  }, 1000);
		};
        
		// Funci√≥n para registrar jugadores
		window.startGame = async function() {
		  // Validar que todos los jugadores tengan datos completos
		  const missingData = [];
		  Object.keys(window.playersData).forEach(key => {
		    const data = window.playersData[key];
		    if (!data.cedula) {
		      missingData.push(`Jugador ${key}`);
		    } else if (!data.exists) {
		      const firstNameInput = document.querySelector(`.first-name[data-team="${key[0]}"][data-player="${key[1]}"]`);
		      const lastNameInput = document.querySelector(`.last-name[data-team="${key[0]}"][data-player="${key[1]}"]`);
		      const firstName = firstNameInput?.value?.trim() || '';
		      const lastName = lastNameInput?.value?.trim() || '';
		      if (!firstName || !lastName) {
		        missingData.push(`Jugador ${key}`);
		      }
		    }
		  });
		
		  if (missingData.length > 0) {
		    window.showNotification('Por favor, completa todos los datos de los siguientes jugadores: ' + missingData.join(', '));
		    return;
		  }
		
		  // ‚úÖ Validar que no haya c√©dulas duplicadas entre los jugadores
		  const cedulas = [];
		  const duplicates = [];
		
		  Object.keys(window.playersData).forEach(key => {
		    const data = window.playersData[key];
		    if (data.cedula) {
		      if (cedulas.includes(data.cedula)) {
		        duplicates.push(data.cedula);
		      } else {
		        cedulas.push(data.cedula);
		      }
		    }
		  });
		
		  if (duplicates.length > 0) {
		    const cedulaDuplicada = duplicates[0];
		    const jugadores = Object.keys(window.playersData)
		      .filter(key => window.playersData[key].cedula === cedulaDuplicada)
		      .map(key => `Jugador ${key}`)
		      .join(' y ');
		
		    window.showNotification(`La c√©dula ${cedulaDuplicada} est√° repetida. No se permite que un jugador participe dos veces en el mismo partido.`);
		    return;
		  }
		  
		  if (!window.currentUser) {
		    window.showNotification('Error: No has iniciado sesi√≥n. Por favor, inicia sesi√≥n primero.');
		    window.goToScreen('login');
		    return;
		  }
		  
		  // Registrar jugadores en la base de datos (SOLO PARA ESTE CLUB)
		  for (const key in window.playersData) {
		    const player = window.playersData[key];
		    if (player.exists) continue; // Ya existe en este club
		    
		    // Obtener los valores del DOM
		    const firstNameInput = document.querySelector(`.first-name[data-team="${key[0]}"][data-player="${key[1]}"]`);
		    const lastNameInput = document.querySelector(`.last-name[data-team="${key[0]}"][data-player="${key[1]}"]`);
		    
		    const firstName = firstNameInput?.value?.trim() || '';
		    const lastName = lastNameInput?.value?.trim() || '';
		    
		    // Validar que los nombres no est√©n vac√≠os
		    if (!firstName || !lastName) {
		      window.showNotification(`Por favor, completa los nombres para el jugador ${key}`);
		      return;
		    }
		    
		    // Intentar insertar el jugador
		    const { error: insertError } = await window.supabase
		      .from('players')
		      .insert([
		        {
		          club_id: window.currentUser.id,
		          cedula: player.cedula,
		          first_name: firstName,
		          last_name: lastName,
		          matches_played: 0,
		          matches_won: 0,
		          created_at: new Date().toISOString(),
		          last_match_date: new Date().toISOString()
		        }
		      ]);
		    
		    if (insertError) {
		      if (insertError.code === '23505') {
		        console.error("Error de unicidad inesperado:", insertError);
		      } else {
		        console.error("Error al registrar jugador:", insertError);
		        window.showNotification(`Error al registrar ${firstName} ${lastName}`);
		        return;
		      }
		    }
		    
		    // Actualizar playersData con los nombres reales
		    window.playersData[key] = {
		      ...window.playersData[key],
		      firstName: firstName,
		      lastName: lastName
		    };
		  }
		  
		  // ‚úÖ CREAR EL PARTIDO EN LA BASE DE DATOS (AHORA S√ç ES CR√çTICO PARA LOS TVs)
		  try {
		    // Determinar el club_id a usar (priorizar gameData.club_id si existe)
		    const clubIdToUse = window.gameData?.club_id || window.currentUser.id;
		    
		    // Crear el partido en la tabla matches con estado 'active'
		    const { data: matchData, error: matchError } = await window.supabase
		      .from('matches')
		      .insert([
		        {
		          club_id: clubIdToUse,
		          court: window.gameData.court,
		          scoring_type: window.scoringType,
		          status: 'active',
		          start_time: new Date().toISOString(),
		          team_a_score: 0,
		          team_b_score: 0,
		          games_a: 0,
		          games_b: 0,
		          sets_a: 0,
		          sets_b: 0,
		          tiebreak: false,
		          team_a_name: window.teamNames.teamA,
		          team_b_name: window.teamNames.teamB,
		          duration: "00:00"
		        }
		      ])
		      .select('id')
		      .single();
		    
		    if (matchError) {
		      console.error("Error al crear partido:", matchError);
		      
		      // Mensaje espec√≠fico para errores de RLS
		      if (matchError.code === '42501') {
		        window.showNotification('Error de permisos. Verifica que tu pol√≠tica RLS est√© configurada correctamente');
		      } else {
		        window.showNotification('Error al guardar partido. Int√©ntalo de nuevo.');
		      }
		      return;
		    }
		    
		    // Guardar el ID del partido para uso posterior
		    window.lastMatchId = matchData.id;
		    
		    // ‚úÖ VINCULAR JUGADORES AL PARTIDO (ahora S√ç en el inicio)
		    try {
		      const insertPlayerInMatch = async (playerKey, team) => {
		        const player = window.playersData[playerKey];
		        
		        // Buscar el ID del jugador por su c√©dula y club_id
		        const { data: playerData, error: playerError } = await window.supabase
		          .from('players')
		          .select('id')
		          .eq('cedula', player.cedula)
		          .eq('club_id', clubIdToUse)
		          .single();
		        
		        if (playerError) {
		          console.error(`Error al buscar jugador ${player.cedula}:`, playerError);
		          return;
		        }
		        
		        // Insertar en match_players
		        const { error: matchPlayerError } = await window.supabase
		          .from('match_players')
		          .insert([
		            {
		              match_id: matchData.id,
		              player_id: playerData.id,
		              team: team
		            }
		          ]);
		        
		        if (matchPlayerError) {
		          console.error(`Error al vincular jugador ${player.cedula} al partido:`, matchPlayerError);
		        }
		      };
		      
		      // Insertar jugadores del equipo A
		      await insertPlayerInMatch('A1', 'teamA');
		      await insertPlayerInMatch('A2', 'teamA');
		      
		      // Insertar jugadores del equipo B
		      await insertPlayerInMatch('B1', 'teamB');
		      await insertPlayerInMatch('B2', 'teamB');
		      
		    } catch (error) {
		      console.error("Error al vincular jugadores al partido:", error);
		      // Continuar igual porque el partido ya se cre√≥
		    }
		    
		    // ‚úÖ Actualizar la funci√≥n addPoint para que use el partido actual
		    window.updateAddPointFunction();
		    
		    // √âxito - resetear marcador y redirigir
		    window.resetGame(); // Asegura que todo est√© limpio antes de empezar
		    window.goToScreen('game');
		    
		    // ‚úÖ Iniciar temporizador
		    window.startTimer();
		    
		  } catch (error) {
		    console.error("Error cr√≠tico al crear partido:", error);
		    window.showNotification('Error cr√≠tico al crear partido. Int√©ntalo de nuevo.');
		  }
		};
		
		// ‚úÖ Nueva funci√≥n: Actualizar addPoint para usar el partido actual
		window.updateAddPointFunction = function() {
		  // Guardar las funciones originales
		  const originalAddPoint = window.addPoint;
		  
		  // Reemplazar con una versi√≥n que actualiza el partido
		  window.addPoint = async function(team) {
		    // Primero, ejecutar la l√≥gica original
		    originalAddPoint.call(this, team);
		    
		    // Si no hay partido activo, no hacer nada
		    if (!window.lastMatchId) return;
		    
		    try {
		      // Preparar datos de actualizaci√≥n
		      const updateData = {};
		      if (team === 'A') {
		        updateData.team_a_score = window.scoreA;
		        if (window.scoringType === 'traditional') {
		          updateData.games_a = window.gamesA;
		        }
		      } else {
		        updateData.team_b_score = window.scoreB;
		        if (window.scoringType === 'traditional') {
		          updateData.games_b = window.gamesB;
		        }
		      }
		      
		      // Actualizar en Supabase
		      const { error } = await window.supabase
		        .from('matches')
		        .update(updateData)
		        .eq('id', window.lastMatchId);
		      
		      if (error) {
		        console.error('Error al actualizar puntuaci√≥n en Supabase:', error);
		      }
		    } catch (error) {
		      console.error('Error al actualizar puntuaci√≥n:', error);
		    }
		  };
		};				
        
        // Funci√≥n para finalizar partido
        window.finalizeGame = async function() {
          if (!window.currentUser) {
            window.showNotification('Por favor, inicia sesi√≥n primero');
            window.goToScreen('login');
            return;
          }
          
          // ‚úÖ Marcar el partido como terminado
          window.gameEnded = true;  
          
          // Determinar ganador
          let winner = '';
          if (window.scoringType === 'traditional') {
            if (window.inTiebreak) {
              winner = window.tiebreakPointsA > window.tiebreakPointsB ? 'A' : 'B';
            } else {
              winner = window.gamesA > window.gamesB ? 'A' : 'B';
            }
          } else {
            if (window.inTiebreak) {
              winner = window.tiebreakPointsA > window.tiebreakPointsB ? 'A' : 'B';
            } else {
              winner = window.scoreA > window.scoreB ? 'A' : 'B';
            }
          }
          
          // Actualizar pantalla de finalizaci√≥n
          const resultTitle = document.getElementById('result-title');
          if (resultTitle) {
            resultTitle.innerHTML = 
              `<i class="fas fa-trophy"></i> ¬°${winner === 'A' ? window.teamNames.teamA : window.teamNames.teamB} se lleva la victoria!`;
          }
          
          // Calcular puntajes seg√∫n sistema
          let gamesAVal = 0, gamesBVal = 0, pointsAVal = 0, pointsBVal = 0;
          if (window.scoringType === 'traditional') {
            gamesAVal = window.gamesA;
            gamesBVal = window.gamesB;
            pointsAVal = window.inTiebreak ? window.tiebreakPointsA : 0;
            pointsBVal = window.inTiebreak ? window.tiebreakPointsB : 0;
          } else {
            pointsAVal = window.inTiebreak ? window.tiebreakPointsA : window.scoreA;
            pointsBVal = window.inTiebreak ? window.tiebreakPointsB : window.scoreB;
          }
          
          const teamAName = document.getElementById('teamA-name')?.value || "Equipo A";
          const teamBName = document.getElementById('teamB-name')?.value || "Equipo B";
          
          // ‚úÖ ACTUALIZAR el partido existente en Supabase (NO crear uno nuevo)
          try {
            const { error } = await window.supabase
              .from('matches')
              .update([
                {
                  status: 'completed',
                  end_time: new Date().toISOString(),
                  winner: winner === 'A' ? 'teamA' : 'teamB',
                  games_a: gamesAVal,
                  games_b: gamesBVal,
                  points_a: pointsAVal,
                  pointsBVal,
                  tiebreak: window.inTiebreak,
                  duration: window.gameDuration
                }
              ])
              .eq('id', window.lastMatchId);
            
            if (error) {
              console.error("Error al actualizar partido: ", {
                code: error.code,
                message: error.message,
                details: error.details,
                hint: error.hint,
                data: {
                  id: window.lastMatchId,
                  winner: winner === 'A' ? 'teamA' : 'teamB',
                  games_a: gamesAVal,
                  games_b: gamesBVal
                }
              });
            
              // Mensaje m√°s espec√≠fico para errores de RLS
              if (error.code === '42501') {
                window.showNotification('Error de permisos. Verifica que tu pol√≠tica RLS est√© configurada correctamente');
              } else {
                window.showNotification('Error al actualizar partido. Int√©ntalo de nuevo.');
              }
            } else {
              // ‚≠ê‚≠ê‚≠ê ACTUALIZACI√ìN CR√çTICA - Manejo mejorado del uso de canchas
              try {
                // Intentar llamar a la funci√≥n RPC
                const { error: courtError } = await window.supabase
                  .rpc('increment_court_usage', {
                    p_club_id: window.currentUser.id,
                    p_court: window.selectedCourt
                  });
                
                if (courtError) {
                  console.error("Error DETALLADO al actualizar uso de canchas:", {
                    code: courtError.code,
                    message: courtError.message,
                    details: courtError.details,
                    hint: courtError.hint
                  });
                  
                  // Verificar si la tabla court_usage existe
                  const { error: tableCheck } = await window.supabase
                    .from('court_usage')
                    .select('count(*)', { count: 'exact' })
                    .limit(1);
                  
                  if (tableCheck) {
                    window.showNotification('Tabla court_usage no existe. Configura Supabase correctamente.');
                  } else {
                    window.showNotification('Error al actualizar uso de canchas. Revisa la configuraci√≥n.');
                  }
                } else {
                  console.log("Uso de canchas actualizado correctamente");
                }
              } catch (error) {
                console.error("Error CR√çTICO al actualizar uso de canchas:", error);
                window.showNotification('Error cr√≠tico al actualizar uso de canchas.');
              }
              
              // Actualizar estad√≠sticas de jugadores
              await window.updatePlayerStats(winner === 'A' ? 'teamA' : 'teamB');
            }
            
            // --- 1. Actualizar duraci√≥n real ---
            const durationEl = document.getElementById('final-duration');
            if (durationEl) {
              const minutes = Math.floor(window.seconds / 60);
              const secs = window.seconds % 60;
              durationEl.textContent = `${minutes} min ${secs.toString().padStart(2, '0')} seg`;
            }
            
            // --- 2. Calcular dominio del partido para "promedio de saques" ---
            let total, teamAVal;
            if (window.scoringType === 'traditional') {
              // Modo tradicional: usar juegos ganados
              total = window.gamesA + window.gamesB;
              teamAVal = window.gamesA;
            } else {
              // Modo americano: usar puntos ganados
              total = window.scoreA + window.scoreB;
              teamAVal = window.scoreA;
            }
            
            // Calcular porcentaje de dominio
            const percentage = total > 0 ? Math.round((teamAVal / total) * 100) : 50;
            
            // Actualizar % de saques
            const servePercentageEl = document.getElementById('serve-percentage');
            if (servePercentageEl) {
              servePercentageEl.textContent = `${percentage}%`;
              
              // Opcional: mejorar el mensaje seg√∫n qui√©n domin√≥
              const serveP = servePercentageEl.parentElement;
              if (percentage > 50) {
                serveP.innerHTML = `<strong>üéØ Promedio de saques:</strong> <span id="serve-percentage">${percentage}%</span> a favor de <strong>${window.teamNames.teamA}</strong>`;
              } else if (percentage < 50) {
                serveP.innerHTML = `<strong>üéØ Promedio de saques:</strong> <span id="serve-percentage">${100 - percentage}%</span> a favor de <strong>${window.teamNames.teamB}</strong>`;
              } else {
                serveP.innerHTML = `<strong>üéØ Promedio de saques:</strong> <span id="serve-percentage">50%</span> (equilibrado)`;
              }
            }
        
            // --- ‚úÖ Mostrar resultado de todos los sets ---
            const setScoresEl = document.getElementById('set-scores');
            if (setScoresEl) {
              let scoreHtml = '';
            
              if (window.scoringType === 'traditional') {
                if (window.setHistory && window.setHistory.length > 0) {
                  const setLines = window.setHistory.map((set, i) => {
                    let setLine = `<strong>Set ${i + 1}:</strong> ${set.gamesA}-${set.gamesB}`;
                    if (set.tiebreak) {
                      setLine += ` (Tiebreak: ${set.tiebreakA}-${set.tiebreakB})`;
                    }
                    return setLine;
                  });
                  scoreHtml = setLines.join('<br>');
                } else {
                  scoreHtml = 'No se complet√≥ ning√∫n set';
                }
              } else {
                // Modo americano
                if (window.inTiebreak) {
                  scoreHtml = `
                    <strong>Puntos regulares:</strong> ${window.scoreA}-${window.scoreB} <br>
                    <strong>Tiebreak:</strong> ${window.tiebreakPointsA}-${window.tiebreakPointsB}
                  `;
                } else {
                  scoreHtml = `<strong>Puntos finales:</strong> ${window.scoreA}-${window.scoreB}`;
                }
              }
            
              setScoresEl.innerHTML = scoreHtml;
            }
            
            // Mostrar pantalla de finalizaci√≥n
            window.goToScreen('end');
          } catch (error) {
            console.error("Error cr√≠tico al finalizar partido:", error);
            window.showNotification('Error cr√≠tico al finalizar partido. Int√©ntalo de nuevo.');
          }
        };        
        
		// Funci√≥n para actualizar estad√≠sticas
		window.updatePlayerStats = async function(winnerTeam) {
		  if (!window.currentUser) return;
		  
		  // Obtener el ID del partido reci√©n creado
		  const matchId = window.lastMatchId;
		  if (!matchId) {
		    console.error("No se encontr√≥ ID de partido para actualizar estad√≠sticas");
		    return;
		  }
		  
		  // Actualizar cada jugador
		  for (const key in window.playersData) {
		    const player = window.playersData[key];
		    if (!player.cedula) continue;
		    
		    try {
		      // Verificar si el jugador existe
		      const { data: existingPlayer, error } = await window.supabase
		        .from('players')
		        .select('id, matches_played, matches_won')
		        .eq('cedula', player.cedula)
		        .eq('club_id', window.currentUser.id)
		        .single();
		      
		      if (error && error.code !== 'PGRST116') {  // PGRST116 = no encontrado
		        console.error(`Error al obtener jugador ${player.cedula}:`, error);
		        continue;
		      }
		      
		      // Determinar si este jugador gan√≥
		      const playerWon = (winnerTeam === 'teamA' && key[0] === 'A') || 
		                        (winnerTeam === 'teamB' && key[0] === 'B');
		      
		      // Calcular nuevos valores
		      let newMatchesPlayed = 1;
		      let newMatchesWon = playerWon ? 1 : 0;
		      
		      if (existingPlayer) {
		        newMatchesPlayed = existingPlayer.matches_played + 1;
		        newMatchesWon = existingPlayer.matches_won + (playerWon ? 1 : 0);
		      }
		      
		      // Actualizar o crear jugador
		      const { error: updateError } = await window.supabase
		        .from('players')
		        .upsert([
		          {
		            cedula: player.cedula,
		            club_id: window.currentUser.id,
		            first_name: player.firstName,
		            last_name: player.lastName,
		            matches_played: newMatchesPlayed,
		            matches_won: newMatchesWon,
		            last_match_date: new Date().toISOString()
		          }
		        ], {
		          onConflict: 'cedula,club_id',
		          ignoreDuplicates: false
		        });
		      
		      if (updateError) {
		        console.error(`Error al actualizar jugador ${player.cedula}:`, updateError);
		      } else {
		        console.log(`Estad√≠sticas actualizadas para jugador ${player.cedula}`);
		      }
		    } catch (error) {
		      console.error(`Error CR√çTICO al actualizar jugador ${player.cedula}:`, error);
		    }
		  }
		  
		  console.log("Estad√≠sticas actualizadas correctamente");
		  window.loadRanking();
		};		
        
        // Funci√≥n para cargar ranking
        window.loadRanking = async function() {
            if (!window.currentUser) {
                const rankingList = document.getElementById('ranking-list');
                if (rankingList) {
                    rankingList.innerHTML = `<div class="alert"><i class="fas fa-exclamation-circle"></i><strong>Error:</strong> Por favor, inicia sesi√≥n primero</div>`;
                }
                return;
            }
        
            // Mostrar estado de carga
            const rankingList = document.getElementById('ranking-list');
            if (rankingList) {
                rankingList.innerHTML = `<p>Cargando ranking...</p>`;
            }
        
            // Calcular fecha de hace 7 d√≠as
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const lastWeek = new Date(today);
            lastWeek.setDate(today.getDate() - 7);
			
            // Mostrar fecha de corte del ranking
            const cutoffDate = lastWeek.toLocaleDateString('es-ES', { 
                day: '2-digit', 
                month: '2-digit', 
                year: 'numeric' 
            });
            const cutoffElement = document.getElementById('ranking-cutoff');
            if (cutoffElement) {
                cutoffElement.textContent = `Activos desde el ${cutoffDate}`;
            }			
        
            try {
				const { data, error } = await window.supabase
				  .from('players')
				  .select(`
				    *,
				    match_players!inner(
				      matches!inner(created_at)
				    )
				  `)
				  .eq('club_id', window.currentUser.id)
				  .gte('match_players.matches.created_at', lastWeek.toISOString())
				  .gt('matches_played', 0)
				  .order('matches_won', { ascending: false });
        
                if (error) {
                    console.error("Error al cargar ranking:", error);
                    if (rankingList) {
                        rankingList.innerHTML = `<div class="alert" style="margin: 15px 0;"><i class="fas fa-exclamation-circle"></i><strong>Error al cargar ranking: ${error.message}</strong></div>`;
                    }
                    return;
                }
        
                if (!data || data.length === 0) {
                    if (rankingList) {
                        rankingList.innerHTML = `<p style="text-align: center; padding: 15px; color: #666;">
													<i class="fas fa-trophy" style="font-size: 24px; opacity: 0.5; display: block; margin-bottom: 10px;"></i>
													<strong>¬°An√≠mate a jugar!</strong><br>
													No hay partidos esta semana.<br>
													S√© el primero en marcar un partido.
												</p>`;
                    }
                    return;
                }
        
                // Generar HTML del ranking
                let html = '';
                let rank = 1;
                data.forEach(player => {
                  const matchesPlayed = player.matches_played || 0;
                  const matchesWon = window.safeNumber(player.matches_won, 0);
                  const matchesLost = matchesPlayed - matchesWon;
                  const winPercentage = matchesPlayed > 0 ? Math.round((matchesWon / matchesPlayed) * 100) : 0;
                  const level = window.getPlayerLevel(winPercentage);
                  const initials = `${player.first_name?.[0] || ''}${player.last_name?.[0] || ''}`.toUpperCase();
                
                  html += `
                  <div class="ranking-item">
                    <div class="ranking-name">
                      <span class="ranking-rank">${rank}.</span>
                      <span>üë§</span>
                      <strong>${initials}</strong>
                      <span>${player.first_name || 'Nombre'} ${player.last_name || 'Apellido'}</span>
                    </div>
                    <div class="ranking-level">
                      <i class="fas fa-${level.icon}" style="color: ${level.color};"></i> ${level.name} (${winPercentage}%)
                    </div>
                    <div class="ranking-stats">
                      <i class="fas fa-tennis-ball" style="margin-right: 4px;"></i> ${matchesPlayed} jugados |
                      <i class="fas fa-check-circle" style="color: #4CAF50; margin-right: 4px;"></i> ${matchesWon} ganados |
                      <i class="fas fa-times-circle" style="color: #D32F2F; margin-right: 4px;"></i> ${matchesLost} perdidos
                    </div>
                  </div>`;
                  rank++;
                });
				
                if (rankingList) {
                    rankingList.innerHTML = html;
                }
            } catch (error) {
                console.error("Error cr√≠tico al cargar ranking:", error);
                if (rankingList) {
                    rankingList.innerHTML = `<div class="alert"><i class="fas fa-exclamation-circle"></i><strong>Error cr√≠tico:</strong> ${error.message}</div>`;
                }
            }
        };

        // Funci√≥n para cargar la selecci√≥n de canchas
        window.loadCourtsSelection = function() {
          const courtsList = document.getElementById('courts-list');
          if (!courtsList || !window.currentClub) return;
          
          const courtCount = window.safeNumber(window.currentClub.court_count, 0);
          courtsList.innerHTML = '';
          
          if (courtCount <= 0) {
            courtsList.innerHTML = '<p>No hay canchas configuradas</p>';
            return;
          }
          
          // Crear opciones de canchas
          for (let i = 1; i <= courtCount; i++) {
            const courtOption = document.createElement('div');
            courtOption.className = 'court-option';
            courtOption.dataset.court = `Cancha ${i}`;
            courtOption.innerHTML = `
              <h3><i class="fas fa-table-tennis-paddle-ball"></i> Cancha ${i}</h3>
              <p>Selecciona para iniciar un partido</p>
            `;
            
            // Bot√≥n para generar QR
            const qrButton = document.createElement('button');
            qrButton.className = 'btn btn-small';
            qrButton.innerHTML = '<i class="fas fa-qrcode"></i> Generar QR para TV';
            qrButton.style.marginTop = '10px';
            qrButton.style.width = '100%';
            
            // A√±adir funcionalidad al bot√≥n QR
            qrButton.onclick = function(e) {
              e.stopPropagation();
              const courtNumber = i;
              const qrUrl = `${window.location.origin}/tv.html?club=${window.currentUser.id}&court=${courtNumber}`;
              
              // Crear modal con QR
              const modal = document.createElement('div');
              modal.style.position = 'fixed';
              modal.style.top = '0';
              modal.style.left = '0';
              modal.style.width = '100%';
              modal.style.height = '100%';
              modal.style.backgroundColor = 'rgba(0,0,0,0.7)';
              modal.style.display = 'flex';
              modal.style.justifyContent = 'center';
              modal.style.alignItems = 'center';
              modal.style.zIndex = '1000';
              
              modal.innerHTML = `
                <div style="background: white; padding: 20px; border-radius: 10px; text-align: center; max-width: 400px;">
                  <h3>QR para Cancha ${courtNumber}</h3>
                  <div id="modal-qrcode" style="margin: 15px auto; width: 200px; height: 200px;"></div>
                  <p style="margin-bottom: 15px; font-size: 0.85rem; color: #555;">
                    URL: <br><small style="word-break: break-all;">${qrUrl}</small>
                  </p>
                  <div style="display: flex; gap: 10px; justify-content: center; margin-top: 10px;">
                    <button class="btn" id="download-qr">
                      <i class="fas fa-download"></i> Descargar QR
                    </button>
                    <button class="btn btn-blue" id="copy-url">
                      <i class="fas fa-copy"></i> Copiar URL
                    </button>
                  </div>
                  <button class="btn btn-red" style="margin-top: 15px; width: 100%;" 
                          onclick="this.closest('div[style*="fixed"]').remove();">
                    <i class="fas fa-times"></i> Cerrar
                  </button>
                </div>
              `;
              
              document.body.appendChild(modal);
              
              // Generar QR en el modal
              QRCode.toCanvas(document.getElementById('modal-qrcode'), qrUrl, {
                width: 200,
                margin: 2,
                color: { 
                  dark: '#2c3e50', 
                  light: '#ffffff' 
                }
              }, function(error) {
                if (error) {
                  console.error("Error al generar QR:", error);
                  document.getElementById('modal-qrcode').innerHTML = 
                    '<div style="color: #e74c3c; padding: 10px;">Error al generar QR</div>';
                }
              });
              
              // Funcionalidad de descarga
              document.getElementById('download-qr').onclick = function() {
                const canvas = document.querySelector('#modal-qrcode canvas');
                if (!canvas) return;
                
                const pngUrl = canvas.toDataURL("image/png");
                const downloadLink = document.createElement('a');
                downloadLink.href = pngUrl;
                downloadLink.download = `QR_Cancha_${courtNumber}.png`;
                downloadLink.click();
              };
              
              // Funcionalidad de copiar URL
              document.getElementById('copy-url').onclick = function() {
                navigator.clipboard.writeText(qrUrl).then(() => {
                  const originalText = this.innerHTML;
                  this.innerHTML = '<i class="fas fa-check"></i> Copiado!';
                  setTimeout(() => {
                    this.innerHTML = originalText;
                  }, 2000);
                }).catch(err => {
                  console.error('Error al copiar:', err);
                });
              };
            };
            
            courtOption.appendChild(qrButton);
            
            courtOption.addEventListener('click', function() {
              // Deseleccionar todas las opciones
              document.querySelectorAll('.court-option').forEach(opt => {
                opt.classList.remove('selected');
              });
              
              // Seleccionar esta opci√≥n
              this.classList.add('selected');
              
              // Habilitar bot√≥n de confirmaci√≥n
              document.getElementById('confirm-court-btn').disabled = false;
            });
            
            courtsList.appendChild(courtOption);
          }
        };

		// Funci√≥n para cargar dashboard
		window.loadDashboard = async function() {
		  if (!window.currentUser) {
		    // Mostrar mensaje de error
		    const totalMatches = document.getElementById('total-matches');
		    const activePlayers = document.getElementById('active-players');
		    const totalHours = document.getElementById('total-hours');
		    const topPlayersList = document.getElementById('top-players-list');
		    const courtsUsage = document.getElementById('courts-usage');
		    
		    if (totalMatches) totalMatches.textContent = "0";
		    if (activePlayers) activePlayers.textContent = "0";
		    if (totalHours) totalHours.textContent = "0";
		    if (topPlayersList) topPlayersList.innerHTML = '<p>Por favor, inicia sesi√≥n primero</p>';
		    if (courtsUsage) courtsUsage.innerHTML = '<p>Inicia sesi√≥n para ver el uso de canchas</p>';
		    return;
		  }
		  
		  const clubId = window.currentUser.id;
		  const today = new Date();
		  today.setHours(0, 0, 0, 0);
		  const tomorrow = new Date(today);
		  tomorrow.setDate(tomorrow.getDate() + 1);
		  const lastWeek = new Date(today);
		  lastWeek.setDate(today.getDate() - 7);
		  
		  try {
		    // 1. Partidos del d√≠a
		    const { data: matchesData, error: matchesError } = await window.supabase
		      .from('matches')
		      .select('id')
		      .eq('club_id', clubId)
		      .gte('created_at', today.toISOString())
		      .lt('created_at', tomorrow.toISOString());
		    
		    if (matchesError) {
		      console.error("Error al obtener partidos:", matchesError);
		      const totalMatches = document.getElementById('total-matches');
		      const totalHours = document.getElementById('total-hours');
		      const activePlayers = document.getElementById('active-players');
		    
		      if (totalMatches) totalMatches.textContent = "0";
		      if (totalHours) totalHours.textContent = "0";
		      if (activePlayers) activePlayers.textContent = "0";
		    
		    } else {
		      // ‚úÖ 1. Partidos del d√≠a
		      const totalMatches = document.getElementById('total-matches');
		      if (totalMatches) totalMatches.textContent = matchesData.length;
		    
		      // ‚úÖ 2. Horas jugadas (aprox 1.5h por partido)
		      const totalHours = document.getElementById('total-hours');
		      if (totalHours) {
		        const totalHoursValue = Math.floor(matchesData.length * 1.5);
		        totalHours.textContent = totalHoursValue;
		      }
		    
		      // ‚úÖ 3. Jugadores activos (hoy) - Usando match_players
		      const activePlayers = document.getElementById('active-players');
		      if (activePlayers) {
		        // Obtener IDs de partidos de hoy
		        const matchIds = matchesData.map(match => match.id);
		        let uniquePlayersCount = 0;
		        
		        if (matchIds.length > 0) {
		          // Consultar match_players para obtener jugadores de partidos de hoy
		          const { data: matchPlayersData, error: matchPlayersError } = await window.supabase
		            .from('match_players')
		            .select('player_id')
		            .in('match_id', matchIds);
		          
		          if (matchPlayersError) {
		            console.error("Error al obtener jugadores de partidos:", matchPlayersError);
		          } else {
		            // Contar jugadores √∫nicos
		            const uniquePlayers = new Set();
		            matchPlayersData.forEach(mp => uniquePlayers.add(mp.player_id));
		            uniquePlayersCount = uniquePlayers.size;
		          }
		        }
		        
		        activePlayers.textContent = uniquePlayersCount;
		      }
		    }
		    
		    // 3. Top 5 jugadores (usando datos de la tabla players)
		    const { data: topPlayersData, error: topPlayersError } = await window.supabase
		      .from('players')
		      .select('*')
		      .eq('club_id', clubId)
		      .gte('last_match_date', lastWeek.toISOString())
		      .gt('matches_played', 0)
		      .limit(10);
		    
		    if (topPlayersError) {
		      console.error("Error al obtener top jugadores:", topPlayersError);
		      const topPlayersList = document.getElementById('top-players-list');
		      if (topPlayersList) {
		        topPlayersList.innerHTML = `
		          <div class="alert">
		            <i class="fas fa-exclamation-circle"></i> 
		            <strong>Error:</strong> ${topPlayersError.message}
		          </div>
		        `;
		      }
		    } else {
		      const topPlayersList = document.getElementById('top-players-list');
		      
		      if (!topPlayersList) return;
		    
		      if (topPlayersData.length === 0) {
		        topPlayersList.innerHTML = '<p>No hay jugadores activos esta semana</p>';
		      } else {
		        // ‚úÖ Ordenar por porcentaje de victorias
		        const sortedTopPlayers = topPlayersData
		          .sort((a, b) => {
		            const winRateA = a.matches_played > 0 ? a.matches_won / a.matches_played : 0;
		            const winRateB = b.matches_played > 0 ? b.matches_won / b.matches_played : 0;
		            return winRateB - winRateA; // Mayor porcentaje primero
		          })
		          .slice(0, 5); // Limitar a solo 5 despu√©s de ordenar
		    
		        let html = '';
		        let rank = 1;
		        sortedTopPlayers.forEach(player => {
		          const matchesPlayed = player.matches_played;
		          const matchesWon = window.safeNumber(player.matches_won, 0);
		          const winPercentage = matchesPlayed > 0 ? 
		            Math.round((matchesWon / matchesPlayed) * 100) : 0;
		          html += `
		            <div class="ranking-item">
		              <span class="ranking-rank">${rank}.</span>
		              <span style="flex: 1;">
		                <strong>${player.first_name || 'Nombre'} ${player.last_name || 'Apellido'}</strong>
		                <div class="win-percentage">${winPercentage}% de victorias</div>
		              </span>
		              <span>
		                <span class="ranking-wins">${matchesWon}</span>-
		                <span class="ranking-losses">${matchesPlayed - matchesWon}</span>
		              </span>
		            </div>
		          `;
		          rank++;
		        });
		        topPlayersList.innerHTML = html;
		      }
		    }
		    
		    // 4. Uso de canchas
		    const { data: courtsData, error: courtsError } = await window.supabase
		      .from('court_usage')
		      .select('*')
		      .eq('club_id', clubId);
		    
		    if (courtsError) {
		      console.error("Error al obtener canchas:", courtsError);
		      const courtsUsage = document.getElementById('courts-usage');
		      if (courtsUsage) {
		        courtsUsage.innerHTML = `
		          <div class="alert">
		            <i class="fas fa-exclamation-circle"></i> 
		            <strong>Error:</strong> ${courtsError.message}
		          </div>
		        `;
		      }
		    } else {
		      let html = '';
		      const courtsUsage = document.getElementById('courts-usage');
		      
		      if (!courtsUsage) return;
		      
		      if (courtsData.length === 0) {
		        html = '<p>No hay datos de uso de canchas</p>';
		      } else {
		        courtsData.forEach(court => {
		          html += `
		            <p style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #eee;">
		              <span><strong>${court.court}</strong></span>
		              <span>${court.match_count} hoy</span>
		            </p>
		          `;
		        });
		      }
		      courtsUsage.innerHTML = html;
		    }
		  } catch (error) {
		    console.error("Error cr√≠tico al cargar dashboard:", error);
		    const topPlayersList = document.getElementById('top-players-list');
		    const courtsUsage = document.getElementById('courts-usage');
		    
		    if (topPlayersList) {
		      topPlayersList.innerHTML = `
		        <div class="alert">
		          <i class="fas fa-exclamation-circle"></i> 
		          <strong>Error cr√≠tico:</strong> ${error.message}
		        </div>
		      `;
		    }
		    
		    if (courtsUsage) {
		      courtsUsage.innerHTML = `
		        <div class="alert">
		          <i class="fas fa-exclamation-circle"></i> 
		          <strong>Error cr√≠tico:</strong> ${error.message}
		        </div>
		      `;
		    }
		  }
		};
        
        // Exportar datos
        window.exportData = async function() {
          if (!window.currentUser) return;
          
          window.showNotification('Exportando datos...');
          const today = new Date();
          const dateStr = today.toISOString().split('T')[0];
          
          // Obtener partidos del d√≠a
          const { matchesData, error: matchesError } = await window.supabase
            .from('matches')
            .select('*')
            .eq('club_id', window.currentUser.id)
            .gte('created_at', new Date(today.setHours(0, 0, 0, 0)).toISOString());
          
          if (matchesError) {
            console.error("Error al exportar: ", matchesError);
            window.showNotification('Error al exportar datos');
            return;
          }
          
          if (matchesData.length === 0) {
            window.showNotification('No hay datos para exportar');
            return;
          }
          
          // Crear CSV
          let csv = 'Fecha,Cancha,Equipo A,Equipo B,Jugadores A,Jugadores B,Resultado,Ganador\n';
          
          // Aqu√≠ necesitar√≠amos obtener los jugadores, pero por simplicidad:
          matchesData.forEach(match => {
            const score = match.scoring_type === 'traditional' ? 
              `${match.games_a}-${match.games_b}` : 
              `${match.points_a}-${match.points_b}`;
              
            const winner = match.winner === 'teamA' ? match.team_a_name : match.team_b_name;
            
            csv += `${new Date().toLocaleDateString()},${match.court},"${match.team_a_name}","${match.team_b_name}",N/A,N/A,${score},"${winner}"\n`;
          });
          
          // Descargar CSV
          const blob = new Blob([csv], { type: 'text/csv' });
          const url = window.URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.setAttribute('hidden', '');
          a.setAttribute('href', url);
          a.setAttribute('download', `padeltrack-${dateStr}.csv`);
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          
          window.showNotification('¬°Datos exportados exitosamente!');
        };
        
        // Funcion varios sets
        window.completeSet = function() {
          let winnerSet = '';
          if (window.inTiebreak) {
            winnerSet = window.tiebreakPointsA > window.tiebreakPointsB ? 'A' : 'B';
          } else {
            winnerSet = window.gamesA > window.gamesB ? 'A' : 'B';
          }
        
          const teamName = winnerSet === 'A' ? window.teamNames.teamA : window.teamNames.teamB;
          const setNumber = (window.setsA + window.setsB) + 1;
        
          // ‚úÖ Guardar el resultado del set en el historial ANTES de resetear los juegos
          window.setHistory.push({
            gamesA: window.gamesA,
            gamesB: window.gamesB,
            tiebreak: window.inTiebreak,
            tiebreakA: window.inTiebreak ? window.tiebreakPointsA : 0,
            tiebreakB: window.inTiebreak ? window.tiebreakPointsB : 0
          });
        
          // Aumentar sets ganados
          if (winnerSet === 'A') {
            window.setsA++;
          } else {
            window.setsB++;
          }
        
          window.showNotification(`Set ${setNumber} ganado por <strong>${teamName}</strong>`, 3000);
        
          // Verificar si el partido termin√≥ (2 sets)
          if (window.setsA === 2 || window.setsB === 2) {
            window.finalizeGame();
            return;
          }
        
          // Resetear para el pr√≥ximo set
          window.gamesA = 0;
          window.gamesB = 0;
          window.scoreA = 0;
          window.scoreB = 0;
          window.inTiebreak = false;
          window.tiebreakPointsA = 0;
          window.tiebreakPointsB = 0;
        
          window.updateScoreboard();
        };
		
        // Resetear el juego (marcador, temporizador, variables)
        window.resetGame = function() {
		
		  // ‚úÖ Reiniciar estado del juego
		  window.gameEnded = false;
          
		  // Resetear variables de puntuaci√≥n
          window.scoreA = 0;
          window.scoreB = 0;
          window.gamesA = 0;
          window.gamesB = 0;
          window.setsA = 0;
          window.setsB = 0;		  
          window.inTiebreak = false;
          window.tiebreakPointsA = 0;
          window.tiebreakPointsB = 0;
        
          // Resetear temporizador
          if (window.interval) {
            clearInterval(window.interval);
            window.interval = null;
          }
          window.minutes = 0;
          window.seconds = 0;
          window.gameDuration = "00:00";
          // Resetear UI
          window.updateScoreboard();
		  
          // Resetear indicadores visuales
          const scoreAElement = document.getElementById('scoreA');
          const scoreBElement = document.getElementById('scoreB');
          const gamesAElement = document.getElementById('gamesA');
          const gamesBElement = document.getElementById('gamesB');
          const timerElement = document.getElementById('timer');
          const tiebreakNotification = document.getElementById('tiebreak-notification');
        
          if (scoreAElement) scoreAElement.textContent = '0';
          if (scoreBElement) scoreBElement.textContent = '0';
          if (gamesAElement) gamesAElement.textContent = '0';
          if (gamesBElement) gamesBElement.textContent = '0';
          if (timerElement) timerElement.textContent = '00:00';
          if (tiebreakNotification) tiebreakNotification.style.display = 'none';
        
          // Resetear colores y clases
          if (scoreAElement) scoreAElement.style.color = '#D32F2F';
          if (scoreBElement) scoreBElement.style.color = '#1976D2';
        
          console.log("Marcador y temporizador reseteados correctamente");
        };		
        

        // Configurar listener de autenticaci√≥n
        window.supabase.auth.onAuthStateChange((event, session) => {
          if (session) {
            window.currentUser = session.user;
            
            // Obtener datos del club
            window.supabase
              .from('clubs')
              .select('*')
              .eq('id', window.currentUser.id)
              .single()
              .then(({ data, error }) => {
                if (error) {
                  console.error("Error al obtener datos del club:", error);
                  window.currentClub = null;
                  
                  // Crear documento del club con valores por defecto
                  window.supabase
                    .from('clubs')
                    .insert([
                      {
                        id: window.currentUser.id,
                        name: "Nuevo Club",
                        court_count: 0,
                        email: window.currentUser.email,
                        phone: "N/A",
                        status: "active"
                      }
                    ])
                    .then(({ error: insertError }) => {
                      if (insertError) {
                        console.error("Error al crear club:", insertError);
                      } else {
                        window.currentClub = {
                          id: window.currentUser.id,
                          name: "Nuevo Club",
                          court_count: 0
                        };
                        window.updateHomeScreen();
                      }
                    });
                } else {
                  window.currentClub = data;
                  if (document.getElementById('home')?.classList.contains('active')) {
                    window.updateHomeScreen();
                  }
                }
              });
          } else {
            window.currentUser = null;
            window.currentClub = null;
            
            // Redirigir al login si no est√° en una pantalla p√∫blica
            if (!document.getElementById('login')?.classList.contains('active') && 
                !document.getElementById('register-screen')?.classList.contains('active')) {
              window.goToScreen('login');
            }
          }
		  
          // Si hay par√°metro court y ahora est√° autenticado, ir al modo TV
          if (courtId && session) {
            if (!document.getElementById('tv-mode')) {
              createTvModeScreen();
            }
            window.goToScreen('tv-mode');
            initializeTvMode(courtId);
          }
	  
        });
        
        // Verificar estado actual de autenticaci√≥n
        window.supabase.auth.getSession().then(({ data, error }) => {
          if (error) {
            console.error("Error al obtener sesi√≥n:", error);
            window.goToScreen('login');
            return;
          }
          
          if (data.session) {
            window.currentUser = data.session.user;
            // Obtener datos del club
            window.supabase
              .from('clubs')
              .select('*')
              .eq('id', window.currentUser.id)
              .single()
              .then(({ data, error }) => {
                if (error) {
                  console.error("Error al obtener datos del club:", error);
                  window.currentClub = null;
                  // Crear documento del club con valores por defecto
                  window.supabase
                    .from('clubs')
                    .insert([
                      {
                        id: window.currentUser.id,
                        name: "Nuevo Club",
                        court_count: 0,
                        email: window.currentUser.email,
                        phone: "N/A",
                        status: "active"
                      }
                    ])
                    .then(({ error: insertError }) => {
                      if (insertError) {
                        console.error("Error al crear club:", insertError);
                      } else {
                        window.currentClub = {
                          id: window.currentUser.id,
                          name: "Nuevo Club",
                          court_count: 0
                        };
                        window.updateHomeScreen();
                      }
                    });
                } else {
                  window.currentClub = data;
                  window.updateHomeScreen();
                }
              });
          } else {
            window.goToScreen('login');
          }
        });
        
        // Si no hay usuario, mostrar login
        if (!window.currentUser) {
          window.goToScreen('login');
        }
        
        // Variables para manejar el estado de sesi√≥n
        window.isManualLogout = false;
        window.sessionCleanupAttempted = false;
        
        // Detectar cierre de pesta√±a/ventana
        window.addEventListener('beforeunload', function() {
          if (window.isManualLogout || window.sessionCleanupAttempted) return;
          try {
            // Marcar que intentamos limpiar la sesi√≥n
            window.sessionCleanupAttempted = true;
          } catch (e) {
            console.log("No se pudo limpiar completamente la sesi√≥n, pero es normal en beforeunload");
          }
        });
        
        // Detectar cambios de visibilidad para manejar inactividad
        document.addEventListener('visibilitychange', function() {
          if (document.visibilityState === 'hidden') {
            // Si la p√°gina est√° oculta por m√°s de 1 minuto, cerrar sesi√≥n
            setTimeout(() => {
              if (document.visibilityState === 'hidden' && window.currentUser && !window.isManualLogout) {
                window.logoutUser();
              }
            }, 60000); // 1 minuto
          }
        });
        
        if (document.querySelector('.cedula-number') || document.querySelector('.cedula-type')) {
          document.querySelectorAll('.cedula-number').forEach(input => {
            input.addEventListener('blur', function() {
              window.validateCedula(this);
            });
          });
        
          document.querySelectorAll('.cedula-type').forEach(select => {
            select.addEventListener('change', function() {
              window.validateCedula(this);
            });
          });
        }		
		
		
        // Temporizador de inactividad (cierra sesi√≥n despu√©s de 15 minutos sin actividad)
        let inactivityTimer;
        const INACTIVITY_TIMEOUT = 15 * 60 * 1000; // 15 minutos
        
        function resetInactivityTimer() {
          if (inactivityTimer) {
            clearTimeout(inactivityTimer);
          }
          if (window.currentUser && !window.isManualLogout) {
            inactivityTimer = setTimeout(() => {
              window.logoutUser();
              window.showNotification('Sesi√≥n cerrada por inactividad');
            }, INACTIVITY_TIMEOUT);
          }
        }
        
        // Iniciar el temporizador al cargar la p√°gina
        document.addEventListener('DOMContentLoaded', resetInactivityTimer);
		     
        // Reiniciar el temporizador en cada interacci√≥n
        document.addEventListener('click', resetInactivityTimer);
        document.addEventListener('mousemove', resetInactivityTimer);
        document.addEventListener('keypress', resetInactivityTimer);
        
        console.log("Aplicaci√≥n inicializada correctamente");

        } catch (error) {
          console.error("Error cr√≠tico al inicializar la aplicaci√≥n:", error);
          // Muestra mensaje de error en el body
          document.body.innerHTML = `
            <div style="font-family: 'Montserrat', sans-serif; text-align: center; padding: 20px; color: #333; max-width: 500px; margin: 0 auto; height: 100vh; display: flex; flex-direction: column; justify-content: center;">
              <h2 style="color: #D32F2F; margin-bottom: 15px;">Error cr√≠tico</h2>
              <p style="margin-bottom: 20px; line-height: 1.5;">Error: ${error.message}</p>
              <div style="display: flex; gap: 10px; justify-content: center;">
                <button onclick="location.reload()" style="background: #016B3A; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; flex: 1; max-width: 150px;">
                  Recargar p√°gina
                </button>
                <button onclick="window.open('https://status.supabase.com/', '_blank')" style="background: #1976D2; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; flex: 1; max-width: 150px;">
                  Estado de Supabase
                </button>
              </div>
            </div>
          `;
        }
    });
  </script>
</head>
<body>
  <div class="container" style="height: auto; min-height: 100vh;">
    <!-- Logo Clickable -->
    <header>
      <div id="logo"></div>
    </header>
    <!-- Pantalla 1: Login -->
    <div class="screen" id="login">
      <h2>Inicia sesi√≥n</h2>
      <div class="stats" style="margin: 20px auto; width: 90%;">
        <p><strong>Correo electr√≥nico</strong></p>
        <input type="email" id="login-email" placeholder="tu@correo.com" style="width: 100%; margin: 10px 0;">
        <p><strong>Contrase√±a</strong></p>
        <input type="password" id="login-password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" style="width: 100%; margin: 10px 0;">
      </div>
      <button class="btn" onclick="window.loginUser()">
        <i class="fas fa-sign-in-alt"></i> Iniciar sesi√≥n
      </button>
      <p style="font-size: 14px; margin: 10px 0;">
        <a href="#" class="link" onclick="window.goToScreen('register-screen')">¬øNo tienes cuenta? Reg√≠strate</a>
      </p>
      <p style="font-size: 14px; margin: 10px 0;">
        <a href="#" class="link" onclick="window.resetPassword()">¬øOlvidaste tu contrase√±a?</a>
      </p>
    </div>
    <!-- Pantalla 2: Registro de Club -->
    <div class="screen" id="register-screen">
      <header>
        <button class="back-btn btn-header" onclick="window.goToScreen('login')">
          <i class="fas fa-arrow-left"></i>
        </button>
      </header>
      <h2>Reg√≠strate como Club de P√°del</h2>
      <div class="stats" style="margin: 20px auto; width: 90%;">
        <p><strong>Nombre del Club</strong></p>
        <input type="text" id="club-name" placeholder="Club P√°del Venezuela" style="width: 100%; margin: 10px 0;">
        <p><strong>RIF (Ej: J-123456789)</strong></p>
        <div class="rif-input" style="display: flex; gap: 10px; align-items: center;">
          <select id="rif-type" style="width: 60px; padding: 10px; font-size: 16px;" required>
            <option value="">--</option>
            <option value="J">J</option>
            <option value="G">G</option>
          </select>
          <input 
            type="text" 
            id="rif-number" 
            placeholder="123456789" 
            maxlength="9"
            pattern="[0-9]*"
            style="flex: 1; padding: 10px; font-size: 16px;" 
            required>
        </div>
        <p><strong>Cantidad de canchas</strong></p>
        <input type="number" id="court-count" min="1" max="20" value="2" style="width: 100%; margin: 10px 0;">
        <p><strong>Correo electr√≥nico</strong></p>
        <input type="email" id="register-email" placeholder="contacto@club.com" style="width: 100%; margin: 10px 0;">
		<p><strong>N√∫mero telef√≥nico</strong></p>
		<div style="display: flex; gap: 10px; align-items: center; width: 100%;">
		    <select id="phone-prefix" style="width: 40%; padding: 8px; font-size: 16px;">
		        <option value=""> - </option>
		        <option value="414">414</option>
		        <option value="412">412</option>
		        <option value="424">424</option>
		        <option value="416">416</option>
		        <option value="426">426</option>
		    </select>
		    <span style="font-size: 18px; color: #555;">-</span>
		    <input 
		        type="tel" 
		        id="phone-suffix" 
		        placeholder="1234567" 
		        maxlength="7" 
		        style="width: 60%; padding: 8px; font-size: 16px;" 
				oninput="this.value = this.value.replace(/[^0-9]/g, '')"
		        inputmode="numeric"
		        pattern="[0-9]{7}"
		    >
		</div>        
		<p><strong>Contrase√±a</strong></p>
        <input type="password" id="register-password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" style="width: 100%; margin: 10px 0;">
        <p><strong>Confirmar contrase√±a</strong></p>
        <input type="password" id="register-confirm" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" style="width: 100%; margin: 10px 0;">
      </div>
      <button class="btn" onclick="window.registerClub()">
        <i class="fas fa-building"></i> Registrar Club
      </button>
      <p style="font-size: 14px; margin: 10px 0;">
        <a href="#" class="link" onclick="window.goToScreen('login')">¬øYa tienes un club registrado? Inicia sesi√≥n</a>
      </p>
    </div>
	
    <!-- Pantalla 3: Inicio -->
    <div class="screen" id="home">
      <h2>Bienvenido, <span id="club-name-display">Cargando...</span></h2>
      
      <!-- M√©tricas clave -->
      <div class="metrics-container" style="display: flex; gap: 12px; margin: 20px 0; flex-wrap: wrap;">
        <div class="metric-card" style="flex: 1; min-width: 140px; background: #E8F5E9; border-radius: 12px; padding: 15px; text-align: center; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
          <i class="fas fa-tennis-ball" style="color: #016B3A; font-size: 24px;"></i>
          <div>
            <h3 style="margin: 8px 0; color: #016B3A;" id="total-matches">0</h3>
            <p style="margin: 0; color: #555; font-size: 14px;">Partidos hoy</p>
          </div>
        </div>
        <div class="metric-card" style="flex: 1; min-width: 140px; background: #E3F2FD; border-radius: 12px; padding: 15px; text-align: center; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
          <i class="fas fa-users" style="color: #1976D2; font-size: 24px;"></i>
          <div>
            <h3 style="margin: 8px 0; color: #1976D2;" id="active-players">0</h3>
            <p style="margin: 0; color: #555; font-size: 14px;">Jugadores activos</p>
          </div>
        </div>
        <div class="metric-card" style="flex: 1; min-width: 140px; background: #FFF3E0; border-radius: 12px; padding: 15px; text-align: center; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
          <i class="fas fa-clock" style="color: #FF8F00; font-size: 24px;"></i>
          <div>
            <h3 style="margin: 8px 0; color: #FF8F00;" id="total-hours">0</h3>
            <p style="margin: 0; color: #555; font-size: 14px;">Horas jugadas</p>
          </div>
        </div>
      </div>
      
      <!-- Canchas disponibles -->
      <h2>Canchas Disponibles</h2>
      <div class="courts-grid" id="courts-grid">
        <!-- Las canchas se cargar√°n din√°micamente -->
      </div>
      
      <!-- Bot√≥n para iniciar partido -->
      <button class="btn play-button" onclick="window.goToScreen('courts-selection')">
        <i class="fas fa-play-circle"></i> Iniciar Partido
      </button>
      
      <!-- Gr√°fico de uso de canchas -->
      <h2>Uso de Canchas</h2>
      <div class="chart-container">
        <canvas id="courtsChart" height="100"></canvas>
      </div>

      <h2>Jugadores del d√≠a</h2>
      <div id="players-today-list" style="margin: 10px 0;"></div>
      
      <p><a href="#" class="link" onclick="window.goToScreen('ranking')"><i class="fas fa-trophy"></i> Ver ranking semanal</a></p>
      <button class="btn btn-red" style="margin-top: 20px; max-width: 320px;" onclick="window.logoutUser()">
        <i class="fas fa-sign-out-alt"></i> Cerrar sesi√≥n
      </button>
      <div class="footer">¬© 2025 PadelTrack. Todos los puntos cuentan.</div>
    </div>

    <!-- Nueva Pantalla: Selecci√≥n de Canchas -->
    <div class="screen" id="courts-selection">
      <header>
        <button class="back-btn btn-header" onclick="window.goToScreen('home')">
          <i class="fas fa-arrow-left"></i>
        </button>
        <h2>Selecciona una Cancha</h2>
      </header>
      
      <div id="courts-list">
        <!-- Las opciones de canchas se cargar√°n aqu√≠ -->
      </div>
      
      <button class="btn" id="confirm-court-btn" onclick="window.confirmCourtSelection()" disabled>
        <i class="fas fa-check"></i> Confirmar Cancha
      </button>
    </div>
    
    <!-- Pantalla 4: Tipo de Puntuaci√≥n -->
    <div class="screen" id="scoring-type">
      <header>
        <button class="back-btn btn-header" onclick="window.goToScreen('home')">
          <i class="fas fa-arrow-left"></i>
        </button>
      </header>
      <h2>Selecciona el sistema de puntuaci√≥n</h2>
      <div class="teams">
        <!-- Modo Tradicional (Tenis) -->
        <div class="team" id="traditional-option" onclick="window.selectScoring('traditional')">
          <h3><i class="fas fa-chess-king"></i> Modo Tradicional</h3>
          <p style="font-size: 14px; color: #666;">
            Sistema oficial de p√°del:<br>
            <strong>6 juegos para ganar el set</strong><br>
            M√°ximo 7-5 ‚Ä¢ Tiebreak a 7 en 6-6
            <span class="help-tip" title="Gana el set quien llegue a 6 juegos con diferencia de 2 (m√°ximo 7-5). En 6-6 se juega tiebreak a 7 puntos.">?</span>
          </p>
        </div>
        <!-- Modo Americano (Acumulativo) -->
        <div class="team" id="american-option" onclick="window.selectScoring('american')">
          <h3><i class="fas fa-bolt"></i> Modo Americano</h3>
          <p style="font-size: 14px; color: #666;">
            Sistema venezolano:<br>
            <strong>Acumulativo hasta 16 puntos</strong><br>
            En 8-8 se juega tiebreak a 7 puntos
            <span class="help-tip" title="Se juega hasta 16 puntos acumulados entre ambos equipos. En 8-8 se activa tiebreak a 7 puntos.">?</span>
          </p>
        </div>
      </div>
      <button class="btn btn-disabled" id="continue-btn" onclick="window.goToRegister()">
        <i class="fas fa-play"></i> Continuar
      </button>
    </div>
    <!-- Pantalla 5: Registro de Jugadores -->
    <div class="screen" id="register">
      <header>
        <button class="back-btn btn-header" onclick="window.goToScreen('scoring-type')">
          <i class="fas fa-arrow-left"></i>
        </button>
      </header>
      <h2>Registra a los jugadores</h2>
      <!-- Indicador del sistema activo -->
      <div class="scoring-badge" id="scoring-indicator">
        <i class="fas fa-info-circle"></i> Modo Tradicional
      </div>
      <div class="mode-indicator" id="mode-description">
        Sistema oficial de p√°del: Gana el set quien llegue a 6 juegos con diferencia de 2 (m√°ximo 7-5)
      </div>
      <div class="teams">
        <div class="team" style="border-top: 4px solid #D32F2F;">
          <h3><i class="team-icon fas fa-circle" style="color:#D32F2F"></i> Equipo A</h3>
          <input type="text" class="team-name-input" placeholder="Nombre del equipo (opcional)" id="teamA-name">
          <div class="player-inputs">
            <h4>Jugador 1</h4>
            <div class="cedula-input" style="display: flex; gap: 10px; align-items: center;">
              <select 
                class="cedula-type" 
                data-team="A" 
                data-player="1" 
                style="width: 60px; padding: 10px; font-size: 16px;">
                <option value="">--</option>
                <option value="V">V</option>
                <option value="E">E</option>
                <option value="P">P</option>
              </select>
              <input 
                type="text" 
                class="cedula-number" 
                data-team="A" 
                data-player="1" 
                placeholder="12345678" 
                maxlength="8" 
                pattern="\d{7,8}"
                inputmode="numeric"
                style="flex: 1; padding: 10px; font-size: 16px;" 
                onblur="window.validateCedula(this)">
              <div class="cedula-validation" id="cedula-status-A1"></div>
            </div>
            <div class="player-status" id="player-status-A1"></div>
            <div class="error-message" id="error-A1" style="display: none;">El set debe terminar en 6-4</div>
            <div class="player-name">
              <input type="text" placeholder="Nombre" class="first-name" data-team="A" data-player="1" disabled>
              <input type="text" placeholder="Apellido" class="last-name" data-team="A" data-player="1" disabled>
            </div>
          </div>		  
          <div class="player-inputs">
            <h4>Jugador 2</h4>
            <div class="cedula-input" style="display: flex; gap: 10px; align-items: center;">
              <select 
                class="cedula-type" 
                data-team="A" 
                data-player="2" 
                style="width: 60px; padding: 10px; font-size: 16px;">
                <option value="">--</option>
                <option value="V">V</option>
                <option value="E">E</option>
                <option value="P">P</option>
              </select>
              <input 
                type="text" 
                class="cedula-number" 
                data-team="A" 
                data-player="2" 
                placeholder="12345678" 
                maxlength="8" 
                pattern="\d{7,8}"
                inputmode="numeric"
                style="flex: 1; padding: 10px; font-size: 16px;" 
                onblur="window.validateCedula(this)">
              <div class="cedula-validation" id="cedula-status-A2"></div>
            </div>
            <div class="player-status" id="player-status-A2"></div>
            <div class="error-message" id="error-1" style="display: none;">El set debe terminar en 6-4</div>
            <div class="player-name">
              <input type="text" placeholder="Nombre" class="first-name" data-team="A" data-player="2" disabled>
              <input type="text" placeholder="Apellido" class="last-name" data-team="A" data-player="2" disabled>
            </div>
          </div>		  
        </div>
        <div class="team" style="border-top: 4px solid #1976D2;">
          <h3><i class="team-icon fas fa-circle" style="color:#1976D2"></i> Equipo B</h3>
          <input type="text" class="team-name-input" placeholder="Nombre del equipo (opcional)" id="teamB-name">
          <div class="player-inputs">
            <h4>Jugador 3</h4>
            <div class="cedula-input" style="display: flex; gap: 10px; align-items: center;">
              <select 
                class="cedula-type" 
                data-team="B" 
                data-player="1" 
                style="width: 60px; padding: 10px; font-size: 16px;">
                <option value="">--</option>
                <option value="V">V</option>
                <option value="E">E</option>
                <option value="P">P</option>
              </select>
              <input 
                type="text" 
                class="cedula-number" 
                data-team="B" 
                data-player="1" 
                placeholder="12345678" 
                maxlength="8" 
                pattern="\d{7,8}"
                inputmode="numeric"
                style="flex: 1; padding: 10px; font-size: 16px;" 
                onblur="window.validateCedula(this)">
              <div class="cedula-validation" id="cedula-status-B1"></div>
            </div>
            <div class="player-status" id="player-status-B1"></div>
            <div class="error-message" id="error-1" style="display: none;">El set debe terminar en 6-4</div>
            <div class="player-name">
              <input type="text" placeholder="Nombre" class="first-name" data-team="B" data-player="1" disabled>
              <input type="text" placeholder="Apellido" class="last-name" data-team="B" data-player="1" disabled>
            </div>
          </div>		  
          <div class="player-inputs">
            <h4>Jugador 4</h4>
            <div class="cedula-input" style="display: flex; gap: 10px; align-items: center;">
              <select 
                class="cedula-type" 
                data-team="B" 
                data-player="2" 
                style="width: 60px; padding: 10px; font-size: 16px;">
                <option value="">--</option>
                <option value="V">V</option>
                <option value="E">E</option>
                <option value="P">P</option>
              </select>
              <input 
                type="text" 
                class="cedula-number" 
                data-team="B" 
                data-player="2" 
                placeholder="12345678" 
                maxlength="8" 
                pattern="\d{7,8}"
                inputmode="numeric"
                style="flex: 1; padding: 10px; font-size: 16px;" 
                onblur="window.validateCedula(this)">
              <div class="cedula-validation" id="cedula-status-B2"></div>
            </div>
            <div class="player-status" id="player-status-B2"></div>
            <div class="error-message" id="error-1" style="display: none;">El set debe terminar en 6-4</div>
            <div class="player-name">
              <input type="text" placeholder="Nombre" class="first-name" data-team="B" data-player="2" disabled>
              <input type="text" placeholder="Apellido" class="last-name" data-team="B" data-player="2" disabled>
            </div>
          </div>		  
        </div>
      </div>
      <button class="btn" onclick="window.startGame()"><i class="fas fa-play"></i> Comenzar partido</button>
    </div>
    <!-- Pantalla 6: Marcador en Vivo -->
    <div class="screen" id="game">
      <header>
        <button class="back-btn btn-header" onclick="window.resetGame(); window.goToScreen('register')">
          <i class="fas fa-arrow-left"></i>
        </button>
      </header>
      <!-- Indicador del sistema activo -->
      <div class="scoring-badge" id="scoring-mode">
        <i class="fas fa-info-circle"></i> Modo Tradicional
      </div>
      <div class="scoreboard">
          <div>
              <h3 style="color:#D32F2F"><i class="fas fa-user"></i> <span id="teamA-display">Equipo A</span></h3>
              <!-- Nuevo: Sets ganados -->
              <div class="set-score" id="setsA">0</div>
              <div class="games-score" id="gamesA">0</div>
              <div class="score" id="scoreA">0</div>
              <div class="controls">
                  <button onclick="window.addPoint('A')"><i class="fas fa-plus"></i></button>
                  <button onclick="window.subPoint('A')"><i class="fas fa-minus"></i></button>
              </div>
          </div>
          <div>
              <h3 style="color:#1976D2"><i class="fas fa-user"></i> <span id="teamB-display">Equipo B</span></h3>
              <!-- Nuevo: Sets ganados -->
              <div class="set-score" id="setsB">0</div>
              <div class="games-score" id="gamesB">0</div>
              <div class="score" id="scoreB">0</div>
              <div class="controls">
                  <button onclick="window.addPoint('B')"><i class="fas fa-plus"></i></button>
                  <button onclick="window.subPoint('B')"><i class="fas fa-minus"></i></button>
              </div>
          </div>
      </div>
      <!-- Indicador de Tiebreak -->
      <div id="tiebreak-notification" class="tiebreak-badge" style="display: none;">
        <i class="fas fa-bolt"></i> Tiebreak a 7 puntos
      </div>
      <div class="timer">‚è± <span id="timer">00:00</span></div>
      <button class="btn btn-red" onclick="window.finalizeGame()">
        <i class="fas fa-flag-checkered"></i> Finalizar partido
      </button>
    </div>
    <!-- Pantalla 7: Partido Finalizado -->
    <div class="screen" id="end">
      <header>
        <button class="back-btn btn-header" onclick="window.resetGame(); window.goToScreen('home')">
          <i class="fas fa-arrow-left"></i>
        </button>
      </header>
      <h2>üéâ ¬°Partido finalizado! üéâ</h2>
      <h3 id="result-title" style="color:#016B3A">
        <i class="fas fa-trophy"></i> ¬°Equipo A se lleva la victoria!
      </h3>
      <div class="scoring-badge" id="final-scoring-mode">
        <i class="fas fa-info-circle"></i> Sistema: Modo Tradicional
      </div>
      <div class="stats">
        <p><strong>üèÜ Resultado final:</strong></p>
        <p id="set-scores">
          <!-- Aqu√≠ se inyecta el resultado real (ej: Set 1: 6-4, Puntos: 0-0) -->
        </p>
        <p><strong>‚è± Duraci√≥n:</strong> <span id="final-duration">0 min 00 seg</span></p>
        <p><strong>üéØ Promedio de saques:</strong> <span id="serve-percentage">50%</span></p>
      </div>
    </div>
    <!-- Pantalla 8: Ranking -->
    <div class="screen" id="ranking">
      <header>
        <button class="back-btn btn-header" onclick="window.goToScreen('home')">
          <i class="fas fa-arrow-left"></i>
        </button>
      </header>
      <h2><i class="fas fa-crown"></i> Ranking Semanal</h2>
      <div class="stats">
        <p id="ranking-cutoff"></p>
		<div id="ranking-list"></div>
          <strong>Cargando ranking...</strong>
        </p>
      </div>
      <p><em>¬°Participa en m√°s partidos para subir de nivel!</em></p>
      <button class="btn" onclick="window.goToScreen('home')"><i class="fas fa-arrow-left"></i> Volver</button>
    </div>
    <!-- Pantalla 9: Dashboard -->
    <div class="screen" id="dashboard">
      <header>
        <i class="fas fa-table-tennis-paddle-ball"></i> DASHBOARD
        <button class="back-btn btn-header" onclick="window.goToScreen('home')">
          <i class="fas fa-arrow-left"></i>
        </button>
        <button class="logout-btn btn-header" onclick="window.logoutUser()">
          <i class="fas fa-sign-out-alt"></i>
        </button>
      </header>
      <div style="padding: 20px; overflow-y: auto; height: calc(100% - 80px);">
        <!-- Resumen del d√≠a -->
        <div style="background: #016B3A; color: white; border-radius: 16px; padding: 15px; margin-bottom: 20px;">
          <h3 style="margin-bottom: 10px;"><i class="fas fa-chart-line"></i> Resumen del d√≠a</h3>
          <div class="dashboard-stats">
            <div class="stat-item">
              <div>Partidos</div>
              <div class="stat-value" id="total-matches">0</div>
            </div>
            <div class="stat-item">
              <div>Jugadores</div>
              <div class="stat-value" id="active-players">0</div>
            </div>
            <div class="stat-item">
              <div>Horas</div>
              <div class="stat-value" id="total-hours">0</div>
            </div>
          </div>
        </div>

        <!-- Top 5 Jugadores -->
        <div class="stats" style="margin-bottom: 20px;">
          <h3 style="margin-bottom: 10px;"><i class="fas fa-crown"></i> Top 5 Jugadores (Semana)</h3>
          <div id="top-players-list">
            <p>Cargando...</p>
          </div>
        </div>
        <!-- Uso de canchas -->
        <div class="stats" style="margin-bottom: 20px;">
          <h3 style="margin-bottom: 10px;"><i class="fas fa-court-sport"></i> Uso de Canchas</h3>
          <div id="courts-usage">
            <p>Cargando...</p>
          </div>
        </div>
        <!-- Acciones -->
        <div class="dashboard-actions">
          <button class="btn" onclick="window.goToScreen('home')">
            <i class="fas fa-racquet"></i> Registrar partido
          </button>
          <button class="btn btn-blue" onclick="window.exportData()">
            <i class="fas fa-file-export"></i> Exportar
          </button>
        </div>
      </div>
    </div>

    <!-- Pantalla 10: Bienvenida Post-Registro -->
    <div class="screen" id="welcome">
      <header>
        <button class="back-btn btn-header" onclick="window.goToScreen('login')">
          <i class="fas fa-arrow-left"></i>
        </button>
      </header>	   
      <div class="welcome-container">
        <h2>Bienvenido, <span id="club-name-welcome"></span>!</h2>
        <p class="subtitle">¬°Tu club ya est√° listo para empezar!</p>
        <div class="handshake-container">
          <img src="assets/handshake.png" alt="Manos entrelazadas" class="handshake-img" 
               onerror="this.src='https://via.placeholder.com/200x150?text=Error+de+imagen'">
        </div>
        <p>Estamos emocionados de tenerte con nosotros. ¬°Comienza a registrar tus partidos y disfruta del mejor seguimiento de p√°del!</p>
        <button class="btn btn-green" onclick="window.goToScreen('login')">Iniciar Sesi√≥n</button>
      </div>
    </div>

    <!-- Pantalla TV Mode -->
    <div class="screen" id="tv-mode">
      <header>
        <button class="back-btn btn-header" onclick="window.goToScreen('home')">
          <i class="fas fa-arrow-left"></i>
        </button>
      </header>
      <h2>Modo TV - Cancha #<span id="tv-court-number">1</span></h2>
      
      <div class="scoreboard">
        <!-- Contenido similar al de tu pantalla de juego -->
        <div class="team team-a">
          <h3 id="tv-team-a-name">Equipo A</h3>
          <div class="players" id="tv-team-a-players">-</div>
          <div class="score" id="tv-score-a">0</div>
        </div>
        // En la funci√≥n loadCourtsSelection
        <div class="vs">VS</div>
        
        <div class="team team-b">
          <h3 id="tv-team-b-name">Equipo B</h3>
          <div class="players" id="tv-team-b-players">-</div>
          <div class="score" id="tv-score-b">0</div>
        </div>
      </div>
      
      <div class="game-info">
        <div class="info-box">
          <span>Duraci√≥n</span>
          <span id="tv-match-duration">00:00</span>
        </div>
        <div class="info-box">
          <span>Puntos totales</span>
          <span id="tv-total-points">0</span>
        </div>
      </div>
      
      <div class="qr-section">
        <h3>Escanee para registrar su partido</h3>
        <div id="tv-qrcode"></div>
        <p>Use su smartphone para escanear el c√≥digo</p>
      </div>
    </div>

    <!-- Notificaci√≥n flotante -->
    <div class="notification" id="notification">
      ¬°Tiebreak activado! Juega a 7 puntos
    </div>
  </div>
</body>
</html>
